<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE OS | Deco Edition</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root {
            --main: #a29bfe;
            --bg: #f8fafc;
            --panel: #ffffff;
            --text: #1e293b;
        }

        body, html { margin: 0; padding: 0; background: var(--bg); color: var(--text); font-family: -apple-system, "PingFang SC", sans-serif; overflow-x: hidden; }

        /* --- 1. å¤åˆ»æˆªå›¾é¡¶æ ï¼šæ¯›ç»ç’ƒæ‚¬æµ®å¯¼èˆª --- */
        .joe-header {
            position: fixed; top: 15px; left: 50%; transform: translateX(-50%);
            width: 95%; max-width: 1200px; height: 55px;
            background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: 30px; border: 1px solid rgba(255, 255, 255, 0.3);
            display: flex; align-items: center; padding: 0 25px;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.07); z-index: 1000;
        }

        .logo { font-size: 20px; font-weight: 900; color: #6c5ce7; margin-right: 25px; }

        .nav-links { display: flex; gap: 8px; flex: 1; align-items: center; }
        
        /* 1:1 å¤åˆ»é©¬å¡é¾™é…è‰²æ ‡ç­¾ */
        .nav-btn {
            padding: 6px 16px; border-radius: 18px; font-size: 13px; font-weight: 600;
            cursor: pointer; border: none; transition: 0.3s; color: #636e72; background: #eee;
        }
        .nav-btn.active { background: #f1f5f9; color: var(--text); box-shadow: inset 0 2px 4px rgba(0,0,0,0.05); }
        .btn-movie { background: #fff1f1; color: #ff6b6b; }
        .btn-tv { background: #f3f0ff; color: #a29bfe; }
        .btn-anime { background: #e6fffa; color: #20c997; }
        .btn-variety { background: #fffbe6; color: #fab005; }
        .btn-live { background: #fff0f6; color: #f06595; }

        /* --- 2. ä¸»é¡µé¢å¸ƒå±€ --- */
        .container { max-width: 1200px; margin: 100px auto 50px; padding: 0 20px; }
        
        .brand-zone { text-align: center; margin-bottom: 60px; }
        .brand-zone h1 { font-size: 64px; margin: 0; font-weight: 900; background: linear-gradient(135deg, #6c5ce7, #a29bfe); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        .brand-zone p { color: #b2bec3; letter-spacing: 4px; font-weight: 500; margin-top: 10px; }

        .search-bar { width: 100%; max-width: 600px; margin: 0 auto 50px; display: flex; gap: 10px; }
        .search-bar input { flex: 1; padding: 12px 25px; border-radius: 25px; border: 1px solid #e2e8f0; outline: none; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        .search-bar button { background: var(--main); border: none; color: #fff; padding: 0 25px; border-radius: 25px; cursor: pointer; font-weight: bold; }

        .section-header { font-size: 18px; font-weight: 700; margin: 30px 0 20px; display: flex; justify-content: space-between; align-items: center; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 25px; }
        
        /* Deco é£æ ¼å¡ç‰‡ */
        .card { background: #fff; border-radius: 15px; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03); cursor: pointer; transition: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); position: relative; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 12px 30px rgba(0,0,0,0.1); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .score { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.5); backdrop-filter: blur(4px); color: #fff; font-size: 11px; padding: 3px 8px; border-radius: 6px; }
        .card .info { padding: 12px; }
        .card .title { font-size: 14px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* --- 3. è¯¦æƒ…æ’­æ”¾é¡µ (æˆªå›¾ 4, 5) --- */
        #player-page { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; padding-top: 80px; }
        .player-content { max-width: 1400px; margin: 0 auto; display: grid; grid-template-columns: 1fr 350px; gap: 30px; padding: 0 30px; }
        
        .video-box { border-radius: 16px; overflow: hidden; background: #000; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .video-info { background: #fff; border-radius: 16px; padding: 25px; margin-top: 25px; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }

        .side-panel { background: #fff; border-radius: 16px; display: flex; flex-direction: column; overflow: hidden; box-shadow: 0 4px 15px rgba(0,0,0,0.03); height: 750px; }
        .side-tabs { display: flex; border-bottom: 1px solid #f1f5f9; }
        .tab-btn { flex: 1; padding: 18px; text-align: center; cursor: pointer; font-size: 15px; font-weight: 700; color: #94a3b8; }
        .tab-btn.active { color: #6c5ce7; border-bottom: 3px solid #6c5ce7; }

        .tab-body { flex: 1; overflow-y: auto; padding: 20px; }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .ep-item { background: #f1f5f9; padding: 12px 0; text-align: center; border-radius: 8px; font-size: 13px; cursor: pointer; transition: 0.2s; }
        .ep-item.active { background: #6c5ce7; color: #fff; }

        .source-item { display: flex; align-items: center; gap: 12px; padding: 15px; border-radius: 12px; margin-bottom: 10px; background: #f8fafc; cursor: pointer; border: 1px solid transparent; }
        .source-item.active { border-color: #a29bfe; background: #f3f0ff; }

        /* ç®¡ç†é¢æ¿ (æˆªå›¾ 3) */
        #admin-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(5px); }
        .admin-box { background: #fff; width: 90%; max-width: 550px; border-radius: 24px; padding: 35px; }
        .admin-row { padding: 18px 25px; background: #f8fafc; border-radius: 15px; margin-bottom: 12px; display: flex; justify-content: space-between; cursor: pointer; border: 1px solid #f1f5f9; }
    </style>
</head>
<body>

<header class="joe-header">
    <div class="logo">JOE OS</div>
    <div class="nav-links">
        <div class="nav-btn active" onclick="location.reload()">é¦–é¡µ</div>
        <div class="nav-btn btn-movie" onclick="loadDouban('Movie')">ç”µå½±</div>
        <div class="nav-btn btn-tv" onclick="loadDouban('TV')">å‰§é›†</div>
        <div class="nav-btn btn-anime" onclick="loadDouban('Anime')">åŠ¨æ¼«</div>
        <div class="nav-btn btn-variety" onclick="loadDouban('Variety')">ç»¼è‰º</div>
        <div class="nav-btn btn-live" onclick="showAdmin()">ç®¡ç†é¢æ¿</div>
    </div>
</header>

<div class="container">
    <div class="brand-zone">
        <h1>JOE</h1>
        <p>å‘ç° Â· æ”¶è— Â· ç»§ç»­è§‚çœ‹</p>
    </div>

    <div class="search-bar">
        <input type="text" id="search-input" placeholder="è¾“å…¥ç‰‡åï¼Œå…¨ç½‘æºèšåˆæœç´¢...">
        <button onclick="aggregateSearch()">æœç´¢</button>
    </div>

    <div id="history-sec" style="display:none;">
        <div class="section-header"><span>ç»§ç»­è§‚çœ‹</span><span style="font-size:12px; color:#94a3b8; cursor:pointer;" onclick="clearHis()">æ¸…ç©ºè®°å½•</span></div>
        <div class="grid" id="history-grid"></div>
    </div>

    <div class="section-header"><span id="grid-title">ä»Šæ—¥çƒ­é—¨</span></div>
    <div class="grid" id="main-grid"></div>
</div>

<div id="player-page">
    <div style="padding: 20px 50px; font-weight: 700; cursor: pointer; color: #6c5ce7;" onclick="closePlayer()"> â† è¿”å›ä¸»é¡µ</div>
    <div class="player-content">
        <div class="player-left">
            <div class="video-box">
                <video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls style="width:100%; height:100%;"></video>
            </div>
            <div class="video-info">
                <h2 id="v-name" style="margin:0 0 10px;">åŠ è½½ä¸­...</h2>
                <div id="v-tags" style="display:flex; gap:10px; margin-bottom:15px;"></div>
                <p id="v-desc" style="color:#64748b; font-size:14px; line-height:1.8;"></p>
            </div>
        </div>
        <div class="side-panel">
            <div class="side-tabs">
                <div id="tab-ep" class="tab-btn active" onclick="switchTab('ep')">é€‰é›†</div>
                <div id="tab-src" class="tab-btn" onclick="switchTab('src')">æ¢æº</div>
            </div>
            <div id="ep-panel" class="tab-body">
                <div class="ep-grid" id="ep-list"></div>
            </div>
            <div id="src-panel" class="tab-body" style="display:none;">
                <div id="src-list"></div>
            </div>
        </div>
    </div>
</div>

<div id="admin-modal">
    <div class="admin-box">
        <h2 style="margin-top:0;">ç®¡ç†å‘˜è®¾ç½® <span style="background:#ff7675; color:#fff; font-size:10px; padding:3px 8px; border-radius:6px; vertical-align:middle;">JOE OS</span></h2>
        <div class="admin-row" onclick="addApi()"><span>ğŸ“º è§†é¢‘æºé…ç½® (ç‚¹å‡»æ·»åŠ )</span><span>+</span></div>
        <div class="admin-row"><span>ğŸ“¡ ç›´æ’­æºé…ç½®</span><span>></span></div>
        <div class="admin-row"><span>âš™ï¸ ç³»ç»Ÿè®¾ç½®</span><span>></span></div>
        <div class="admin-row"><span>ğŸ“ æ•°æ®å¤‡ä»½</span><span>></span></div>
        <button onclick="hideAdmin()" style="width:100%; padding:15px; background:#f1f2f6; border:none; border-radius:15px; margin-top:10px; cursor:pointer; font-weight:700;">ä¿å­˜å¹¶é€€å‡º</button>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    let apis = JSON.parse(localStorage.getItem('joe_v7_apis') || '[]');
    let history = JSON.parse(localStorage.getItem('joe_v7_his') || '[]');
    const player = videojs('v-core');

    window.onload = () => {
        renderHis();
        loadDouban('Movie');
    };

    // 1. è±†ç“£çœŸå¯¼å…¥
    async function loadDouban(type) {
        document.getElementById('grid-title').innerText = `è±†ç“£çƒ­æ’­ Â· ${type}`;
        const grid = document.getElementById('main-grid');
        grid.innerHTML = 'æ­£åœ¨åŠ è½½è±†ç“£äº‘ç«¯æ•°æ®...';
        try {
            const res = await fetch(`https://api.wmdb.tv/api/v1/top?type=${type}&skip=0&limit=18`);
            const data = await res.json();
            grid.innerHTML = '';
            data.forEach(m => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="score">${m.doubanRating || '7.5'}</div>
                    <img src="${m.data[0].poster}" referrerpolicy="no-referrer">
                    <div class="info"><div class="title">${m.data[0].name}</div></div>
                `;
                card.onclick = () => {
                    document.getElementById('search-input').value = m.data[0].name;
                    aggregateSearch();
                };
                grid.appendChild(card);
            });
        } catch(e) { grid.innerHTML = 'æ•°æ®æ‹‰å–å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œã€‚'; }
    }

    // 2. èšåˆæœç´¢ä¸åŒ¹é…
    async function aggregateSearch() {
        const kw = document.getElementById('search-input').value;
        if(!kw || apis.length === 0) return alert('è¯·è¾“å…¥ç‰‡åæˆ–å…ˆåœ¨ç®¡ç†é¢æ¿æ·»åŠ æº');
        
        const grid = document.getElementById('main-grid');
        grid.innerHTML = 'å…¨ç½‘æºæ‰«æä¸­...';
        
        const promises = apis.map(api => 
            fetch(`${api.url}?ac=detail&wd=${encodeURIComponent(kw)}`).then(r => r.json()).catch(() => ({list:[]}))
        );
        const results = await Promise.all(promises);
        
        grid.innerHTML = '';
        results.forEach((res, idx) => {
            if(res.list) res.list.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="score" style="background:#6c5ce7">${apis[idx].name || 'èµ„æº'}</div>
                    <img src="${item.vod_pic}">
                    <div class="info"><div class="title">${item.vod_name}</div></div>
                `;
                card.onclick = () => showPlayer(item, res.list);
                grid.appendChild(card);
            });
        });
    }

    // 3. æ’­æ”¾è¯¦æƒ…é¡µé€»è¾‘ (å¤åˆ»æˆªå›¾ 4, 5)
    function showPlayer(video, allResults) {
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-name').innerText = video.vod_name;
        document.getElementById('v-desc').innerText = video.vod_content.replace(/<[^>]+>/g, '');
        
        // æ¸²æŸ“æ¢æº
        const srcList = document.getElementById('src-list');
        srcList.innerHTML = allResults.map((v, i) => `
            <div class="source-item ${i===0?'active':''}" onclick="loadSource(${i})">
                <div style="width:35px;height:35px;background:#ddd;border-radius:6px;"></div>
                <div>
                    <div style="font-size:13px;font-weight:700;">${v.vod_name}</div>
                    <div style="font-size:11px;color:#6c5ce7;">çº¿è·¯æ­£å¸¸</div>
                </div>
            </div>
        `).join('');

        loadEps(video);
        saveHis(video);
    }

    function loadEps(video) {
        const epList = document.getElementById('ep-list');
        const urlLine = video.vod_play_url.split('$$$')[0]; // é»˜è®¤å–ç¬¬ä¸€æ¡çº¿è·¯
        const eps = urlLine.split('#');
        epList.innerHTML = eps.map(e => {
            const [name, url] = e.split('$');
            return `<div class="ep-item" onclick="playVideo('${url}', this)">${name}</div>`;
        }).join('');
        if(epList.firstChild) epList.firstChild.click();
    }

    function playVideo(url, el) {
        document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        player.src({ src: url, type: 'application/x-mpegURL' });
        player.play();
    }

    // å†å²è®°å½•é€»è¾‘
    function saveHis(v) {
        history = history.filter(h => h.vod_id !== v.vod_id);
        history.unshift(v);
        localStorage.setItem('joe_v7_his', JSON.stringify(history.slice(0, 12)));
        renderHis();
    }

    function renderHis() {
        const sec = document.getElementById('history-sec');
        const grid = document.getElementById('history-grid');
        if(history.length === 0) { sec.style.display = 'none'; return; }
        sec.style.display = 'block';
        grid.innerHTML = history.map(h => `
            <div class="card" onclick="document.getElementById('search-input').value='${h.vod_name}';aggregateSearch();">
                <div class="score">å·²çœ‹</div>
                <img src="${h.vod_pic}">
                <div class="info"><div class="title">${h.vod_name}</div></div>
            </div>
        `).join('');
    }

    // UI äº¤äº’
    function switchTab(t) {
        document.getElementById('tab-ep').classList.toggle('active', t==='ep');
        document.getElementById('tab-src').classList.toggle('active', t==='src');
        document.getElementById('ep-panel').style.display = t==='ep' ? 'block' : 'none';
        document.getElementById('src-panel').style.display = t==='src' ? 'block' : 'none';
    }
    function showAdmin() { document.getElementById('admin-modal').style.display = 'flex'; }
    function hideAdmin() { document.getElementById('admin-modal').style.display = 'none'; }
    function closePlayer() { player.pause(); document.getElementById('player-page').style.display = 'none'; }
    function addApi() {
        const n = prompt('è¯·è¾“å…¥æºåç§° (å¦‚: æé€Ÿæº):');
        const u = prompt('è¯·è¾“å…¥ API æ¥å£åœ°å€:');
        if(n && u) { apis.push({name:n, url:u}); localStorage.setItem('joe_v7_apis', JSON.stringify(apis)); }
    }
</script>
</body>
</html>
