<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE OS | Ultimate æ——èˆ°ç‰ˆ</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #a29bfe; --bg: #f8fafc; --text: #1e293b; --accent: #6c5ce7; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "PingFang SC", sans-serif; }
        
        /* å¯¼èˆª */
        header { 
            position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(15px);
            display: flex; align-items: center; padding: 12px 30px; z-index: 1000; border-bottom: 1px solid #e2e8f0;
        }
        .logo { font-size: 22px; font-weight: 900; color: var(--main); margin-right: 40px; }
        .nav { display: flex; gap: 10px; flex: 1; }
        .nav div { padding: 8px 18px; border-radius: 20px; cursor: pointer; font-size: 14px; background: #f1f5f9; transition: 0.2s; }
        .nav .active { background: var(--main); color: white; }

        .search-bar { display: flex; gap: 10px; align-items: center; }
        .search-bar input { padding: 10px 20px; border-radius: 20px; border: 1px solid #e2e8f0; width: 220px; outline: none; }
        .search-bar button { background: var(--main); color: #fff; border: none; padding: 10px 25px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* å†…å®¹åŒº */
        .container { max-width: 1400px; margin: 25px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; }
        .card { background: #fff; border-radius: 14px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid #f1f5f9; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .title { padding: 10px; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* æ’­æ”¾å™¨é¡µé¢ */
        #player-page { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; }
        .player-layout { display: grid; grid-template-columns: 1fr 400px; gap: 25px; max-width: 1600px; margin: 30px auto; padding: 0 20px; }
        .v-box { background: #000; border-radius: 18px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        
        /* å³ä¾§é¢æ¿ (Deco é£æ ¼) */
        .side-panel { background: #fff; border-radius: 18px; height: 750px; display: flex; flex-direction: column; border: 1px solid #e2e8f0; overflow: hidden; }
        .tabs { display: flex; background: #f8fafc; padding: 6px; gap: 6px; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; font-size: 14px; border-radius: 12px; color: #94a3b8; }
        .tab.active { color: var(--accent); background: #fff; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        /* é€‰é›†åˆ†æ®µ */
        .range-bar { display: flex; gap: 8px; padding: 12px; overflow-x: auto; border-bottom: 1px solid #f1f5f9; }
        .range-btn { padding: 6px 12px; border-radius: 8px; background: #f1f5f9; font-size: 12px; cursor: pointer; white-space: nowrap; }
        .range-btn.active { background: var(--main); color: white; }
        .sort-toggle { padding: 6px; cursor: pointer; font-size: 14px; display: flex; align-items: center; }

        .list-body { flex: 1; overflow-y: auto; padding: 15px; }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .ep-item { background: #f8fafc; border: 1px solid #f1f5f9; padding: 10px 0; text-align: center; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .ep-item.active { background: var(--main); color: white; }

        /* æºç®¡ç†å¼¹çª—æ ·å¼ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.7); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-body { background: #fff; width: 550px; padding: 25px; border-radius: 20px; max-height: 80vh; overflow-y: auto; }
        .api-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8fafc; border-radius: 10px; margin-bottom: 8px; border: 1px solid #eee; }
        .api-item span { font-size: 13px; font-weight: bold; }
        .api-del { color: #ff7675; cursor: pointer; font-size: 12px; }
        
        .import-area { margin-top: 20px; padding-top: 20px; border-top: 1px solid #eee; }
        textarea { width: 100%; height: 120px; border-radius: 10px; border: 1px solid #ddd; padding: 10px; box-sizing: border-box; font-size: 12px; }
    </style>
</head>
<body>

<header>
    <div class="logo">JOE PRO</div>
    <div class="nav">
        <div class="active" onclick="initHome('Movie')">ç”µå½±</div>
        <div onclick="initHome('TV')">å‰§é›†</div>
        <div onclick="initHome('Anime')">åŠ¨æ¼«</div>
        <div onclick="showManageModal()" style="color:#e67700; background:#fff3bf;">âš™ï¸ ç®¡ç†è§†é¢‘æº</div>
    </div>
    <div class="search-bar">
        <input type="text" id="search-kw" placeholder="å›è½¦ç›´æ¥æœç´¢..." onkeydown="if(event.keyCode==13) search()">
        <button onclick="search()">æœç´¢</button>
    </div>
</header>

<div class="container"><div class="grid" id="main-grid"></div></div>

<div id="player-page">
    <div style="padding: 20px 40px; cursor:pointer; font-weight:bold; color:var(--main);" onclick="closePlayer()"> â† è¿”å›åˆ—è¡¨</div>
    <div class="player-layout">
        <div>
            <div class="v-box">
                <video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto"></video>
            </div>
            <div style="background:#fff; padding:20px; border-radius:18px; margin-top:20px; border:1px solid #e2e8f0;">
                <h2 id="v-title" style="margin:0"></h2>
                <div style="display:flex; gap:15px; margin-top:15px; font-size:13px; color:#64748b;">
                    <span>ğŸš€ è·³è¿‡ç‰‡å¤´: <input type="number" id="skip-s" value="0" style="width:45px;" onchange="updateSet()"> ç§’</span>
                    <span>ğŸ¿ è‡ªåŠ¨è¿æ’­: <input type="checkbox" id="auto-n" checked onchange="updateSet()"></span>
                </div>
            </div>
        </div>
        <div class="side-panel">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('ep')">é€‰é›†</div>
                <div class="tab" onclick="switchTab('src')">æ¢æº</div>
            </div>
            <div id="ep-sec" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                <div style="display:flex; align-items:center;">
                    <div class="range-bar" id="range-bar" style="flex:1"></div>
                    <div class="sort-toggle" onclick="toggleSort()">â‡…</div>
                </div>
                <div class="list-body"><div class="ep-grid" id="ep-grid"></div></div>
            </div>
            <div id="src-sec" class="list-body" style="display:none;">
                <div id="src-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="manage-modal">
    <div class="modal-body">
        <h3 style="margin:0 0 15px 0;">è§†é¢‘æºç®¡ç†</h3>
        <div id="api-list-container"></div>
        <div class="import-area">
            <p style="font-size:12px; color:#94a3b8;">æ–°å¢æº (ä¸€è¡Œä¸€ä¸ª URL):</p>
            <textarea id="url-input" placeholder="http://api.com/api.php/provide/vod/at/json/"></textarea>
            <button onclick="doImport()" style="width:100%; padding:12px; background:var(--main); color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">æ‰¹é‡è§£æå¹¶æ·»åŠ </button>
            <button onclick="hideManageModal()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:10px; cursor:pointer;">å…³é—­çª—å£</button>
        </div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('v-core');
    let apis = JSON.parse(localStorage.getItem('joe_v11_apis') || '[]');
    let playSet = JSON.parse(localStorage.getItem('joe_v11_set') || '{"skip":0,"auto":true}');
    let currentRawEps = [];
    let isReverse = false;

    // --- 1. æºç®¡ç†é€»è¾‘ ---
    function showManageModal() {
        document.getElementById('manage-modal').style.display = 'flex';
        renderApiList();
    }
    function hideManageModal() { document.getElementById('manage-modal').style.display = 'none'; }
    
    function renderApiList() {
        const container = document.getElementById('api-list-container');
        container.innerHTML = apis.length ? "" : "<p style='font-size:12px;color:#999'>æš‚æ— å·²ä¿å­˜çš„æº</p>";
        apis.forEach((api, idx) => {
            const div = document.createElement('div');
            div.className = 'api-item';
            div.innerHTML = `<span>${api.name}</span><span class="api-del" onclick="deleteApi(${idx})">åˆ é™¤</span>`;
            container.appendChild(div);
        });
    }

    function deleteApi(idx) {
        apis.splice(idx, 1);
        localStorage.setItem('joe_v11_apis', JSON.stringify(apis));
        renderApiList();
    }

    async function doImport() {
        const urls = document.getElementById('url-input').value.split('\n').map(u => u.trim()).filter(u => u);
        for(let u of urls) {
            try {
                const r = await fetch(u + "?ac=list").then(res => res.json());
                const name = r.source?.name || (r.class && r.class[0] ? r.class[0].name : "æœªçŸ¥æº");
                if(!apis.find(a => a.url === u)) apis.push({ name, url: u });
            } catch(e) { console.error("è§£æå¤±è´¥", u); }
        }
        localStorage.setItem('joe_v11_apis', JSON.stringify(apis));
        document.getElementById('url-input').value = "";
        renderApiList();
    }

    // --- 2. é¦–é¡µä¸æœç´¢ ---
    async function initHome(type) {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = "æ­£åœ¨æ‹‰å–æœ€æ–°æ•°æ®...";
        try {
            const res = await fetch(`https://api.wmdb.tv/api/v1/top?type=${type}&skip=0&limit=30`).then(r => r.json());
            renderGrid(res.map(m => ({ name: m.data[0].name, pic: m.data[0].poster, tag: m.doubanRating })));
        } catch(e) { 
            if(apis.length) searchApi(apis[0], ""); 
            else grid.innerHTML = "è¯·å…ˆæ·»åŠ è§†é¢‘æº";
        }
    }

    function renderGrid(items) {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = "";
        items.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<img src="${item.pic}" loading="lazy"><div class="title">${item.name}</div>`;
            card.onclick = () => { document.getElementById('search-kw').value = item.name; search(); };
            grid.appendChild(card);
        });
    }

    async function search() {
        const kw = document.getElementById('search-kw').value;
        if(!kw) return;
        const grid = document.getElementById('main-grid');
        grid.innerHTML = "èšåˆçº¿è·¯æœå¯»ä¸­...";
        const results = await Promise.allSettled(apis.map(async api => {
            const start = Date.now();
            const r = await fetch(`${api.url}?ac=detail&wd=${encodeURIComponent(kw)}`).then(res => res.json());
            return { api, list: r.list || [], ms: Date.now() - start };
        }));
        grid.innerHTML = "";
        results.forEach(res => {
            if(res.status === 'fulfilled' && res.value.list.length > 0) {
                res.value.list.forEach(v => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `<img src="${v.vod_pic}"><div class="title">${v.vod_name}</div>`;
                    card.onclick = () => openPlayer(v, results);
                    grid.appendChild(card);
                });
            }
        });
    }

    // --- 3. æ’­æ”¾ä¸é€‰é›†é€»è¾‘ä¿®æ­£ ---
    function openPlayer(video, allRes) {
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-title').innerText = video.vod_name;
        document.getElementById('skip-s').value = playSet.skip;

        const srcList = document.getElementById('src-list');
        srcList.innerHTML = "";
        allRes.forEach(res => {
            if(res.status === 'fulfilled' && res.value.list.length > 0) {
                const d = document.createElement('div');
                d.className = 'api-item';
                d.style.cursor = 'pointer';
                d.innerHTML = `<span>${res.value.api.name}</span><span>${res.value.ms}ms</span>`;
                d.onclick = () => {
                    currentRawEps = res.value.list[0].vod_play_url.split('#');
                    renderRanges();
                    switchTab('ep');
                };
                srcList.appendChild(d);
            }
        });
        if(srcList.firstChild) srcList.firstChild.click();
    }

    function renderRanges() {
        const bar = document.getElementById('range-bar');
        bar.innerHTML = "";
        const size = 50;
        const total = currentRawEps.length;
        
        // æ­£åºæˆ–å€’åºæ’åˆ—åŸå§‹é›†æ•°
        let displayEps = isReverse ? [...currentRawEps].reverse() : currentRawEps;

        for(let i = 0; i < total; i += size) {
            const end = Math.min(i + size, total);
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = isReverse ? `${total-i}-${total-end+1}` : `${i+1}-${end}`;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEps(displayEps.slice(i, end));
            };
            bar.appendChild(btn);
        }
        bar.firstChild.click();
    }

    function renderEps(slice) {
        const grid = document.getElementById('ep-grid');
        grid.innerHTML = "";
        slice.forEach(item => {
            const [name, url] = item.split('$');
            const d = document.createElement('div');
            d.className = 'ep-item';
            d.innerText = name;
            d.onclick = () => {
                document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
                d.classList.add('active');
                player.src({ src: url, type: 'application/x-mpegURL' });
                player.one('loadedmetadata', () => { if(playSet.skip > 0) player.currentTime(playSet.skip); });
                player.play();
            };
            grid.appendChild(d);
        });
    }

    function toggleSort() {
        isReverse = !isReverse;
        renderRanges();
    }

    // --- 4. è¾…åŠ©å‡½æ•° ---
    function switchTab(t) {
        document.getElementById('ep-sec').style.display = t==='ep'?'flex':'none';
        document.getElementById('src-sec').style.display = t==='src'?'block':'none';
        document.querySelectorAll('.tab').forEach((el, idx) => el.classList.toggle('active', (t==='ep' && idx===0) || (t==='src' && idx===1)));
    }
    function updateSet() {
        playSet.skip = parseInt(document.getElementById('skip-s').value) || 0;
        playSet.auto = document.getElementById('auto-n').checked;
        localStorage.setItem('joe_v11_set', JSON.stringify(playSet));
    }
    function closePlayer() { player.pause(); document.getElementById('player-page').style.display = 'none'; }

    // åˆå§‹åŒ–åŠ è½½
    apis.length ? initHome('Movie') : showManageModal();
</script>
</body>
</html>
