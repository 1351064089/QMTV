<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE TV V21.11 | æé€Ÿæœç´¢+æµç•…æ’­æ”¾</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #6c5ce7; --bg: #f4f7f6; --text: #2d3436; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow-x: hidden; }
        header { position: sticky; top: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); display: flex; align-items: center; padding: 10px 20px; z-index: 1000; border-bottom: 1px solid #ddd; }
        .logo { font-size: 20px; font-weight: bold; color: var(--main); margin-right: 20px; cursor: pointer; }
        .nav { display: flex; gap: 8px; flex: 1; overflow-x: auto; scrollbar-width: none; }
        .nav div { padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; background: #eee; white-space: nowrap; }
        .nav .active { background: var(--main); color: #fff; }
        .mgr-btn { background: #fff3e0 !important; color: #e65100 !important; }

        .search-box input { padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; width: 200px; }

        .container { max-width: 1600px; margin: 20px auto; padding: 0 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card { background: #fff; border-radius: 10px; overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card:hover { transform: scale(1.03); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .info { padding: 8px; text-align: center; font-size: 12px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .his-tag { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #00ff00; font-size: 10px; padding: 2px 5px; border-radius: 3px; }

        /* æ’­æ”¾é¡µ */
        #player-page { position: fixed; inset: 0; background: #f4f4f4; z-index: 2000; display: none; overflow-y: auto; }
        .p-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; padding: 20px; }
        .v-box { background: #000; aspect-ratio: 16/9; border-radius: 10px; overflow: hidden; position: relative; }
        #v-details { position: absolute; top: 10px; left: 10px; color: #0f0; background: rgba(0,0,0,0.5); padding: 5px 10px; font-size: 11px; z-index: 5; pointer-events: none; border-radius: 4px; }
        
        .side-panel { background: #fff; border-radius: 10px; display: flex; flex-direction: column; overflow: hidden; }
        .tab-bar { display: flex; gap: 5px; padding: 10px; background: #f8f9fa; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tab-item { padding: 4px 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 11px; cursor: pointer; white-space: nowrap; }
        .tab-item.active { background: var(--main); color: #fff; border-color: var(--main); }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 15px; max-height: 500px; overflow-y: auto; }
        .ep-btn { background: #f1f1f1; padding: 8px 0; text-align: center; font-size: 12px; border-radius: 5px; cursor: pointer; }
        .ep-btn.active { background: var(--main); color: #fff; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-body { background: #fff; width: 450px; padding: 20px; border-radius: 15px; }
        textarea { width: 100%; height: 120px; margin: 10px 0; box-sizing: border-box; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE TV</div>
    <div class="nav" id="main-nav">
        <div class="active" onclick="route('home', this)">ğŸ  é¦–é¡µ</div>
        <div onclick="route('1', this)">ç”µå½±</div>
        <div onclick="route('2', this)">å‰§é›†</div>
        <div onclick="route('3', this)">ç»¼è‰º</div>
        <div onclick="route('4', this)">åŠ¨æ¼«</div>
        <div class="mgr-btn" onclick="toggleModal(true)">çº¿è·¯ç®¡ç†</div>
    </div>
    <div class="search-box"><input type="text" id="kw" placeholder="æœç´¢èµ„æº..." onkeydown="if(event.keyCode==13) doGlobalSearch()"></div>
</header>

<div class="container" id="main-view"></div>

<div id="player-page">
    <div style="padding:15px; color:var(--main); cursor:pointer; font-weight:bold;" onclick="closePlayer()">ğŸ”™ è¿”å›åˆ—è¡¨</div>
    <div class="p-layout">
        <div>
            <div class="v-box">
                <div id="v-details">æ­£åœ¨è§£ç è§†é¢‘æµ...</div>
                <div id="v-wrapper"></div>
            </div>
            <h3 id="v-title" style="margin:15px 0 5px 0;"></h3>
            <div id="v-meta" style="font-size:12px; color:#666; margin-bottom:10px;"></div>
            <p id="v-info" style="font-size:13px; color:#444; line-height:1.6;"></p>
        </div>
        <div class="side-panel">
            <div style="padding:10px; font-weight:bold; border-bottom:1px solid #eee;">çº¿è·¯åˆ‡æ¢</div>
            <div class="tab-bar" id="api-tabs"></div>
            <div style="padding:10px; font-weight:bold; border-bottom:1px solid #eee;">é€‰é›†</div>
            <div class="tab-bar" id="range-tabs"></div>
            <div class="ep-grid" id="ep-grid"></div>
        </div>
    </div>
</div>

<div id="mgr-modal" class="modal">
    <div class="modal-body">
        <h3>ç®¡ç†æ¥å£</h3>
        <div id="api-mgr-list" style="max-height:150px; overflow-y:auto; font-size:12px; border:1px solid #eee; margin-bottom:10px;"></div>
        <textarea id="api-input" placeholder="ç²˜è´´è‹¹æœCMSæ¥å£åœ°å€..."></textarea>
        <button onclick="batchAdd()" style="width:100%; padding:10px; background:var(--main); color:#fff; border:none; border-radius:5px;">ä¿å­˜å¹¶åˆ·æ–°</button>
        <button onclick="toggleModal(false)" style="width:100%; margin-top:5px; border:none; background:none; color:#999;">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    let player = null, apiList = JSON.parse(localStorage.getItem('joe_v21_apis') || '[]');
    let history = JSON.parse(localStorage.getItem('joe_v21_his') || '{}');
    let currentVod = null, currentApi = '', isReverse = false;

    // --- æé€Ÿè§£æå¼•æ“ ---
    async function smartFetch(url) {
        try {
            const res = await fetch(url, { signal: AbortSignal.timeout(5000) });
            const text = await res.text();
            if (text.includes('<?xml')) {
                const xml = new DOMParser().parseFromString(text, "text/xml");
                return { name: xml.querySelector('rss')?.getAttribute('name') || 'XML', list: Array.from(xml.querySelectorAll('video')).map(v => ({
                    vod_id: v.querySelector('id')?.textContent,
                    vod_name: v.querySelector('name')?.textContent,
                    vod_pic: v.querySelector('pic')?.textContent,
                    vod_play_url: v.querySelector('dl dd')?.textContent,
                    vod_content: v.querySelector('des')?.textContent
                }))};
            }
            const json = JSON.parse(text);
            return { name: json.source?.name || 'JSON', list: json.list || [] };
        } catch(e) { return null; }
    }

    // --- æœç´¢åŠŸèƒ½ (ä¿®å¤ç‰ˆ) ---
    async function doGlobalSearch() {
        const kw = document.getElementById('kw').value.trim();
        if(!kw) return;
        const view = document.getElementById('main-view');
        view.innerHTML = `<h3>ğŸ” æ­£åœ¨è·¨ç«™æœç´¢: ${kw}</h3><div class="grid" id="search-res"></div>`;
        
        // å…³é”®ä¿®å¤ï¼šPromise.allSettled ç¡®ä¿ä¸€ä¸ªæºæŒ‚äº†ä¸å½±å“æ•´ä½“
        const tasks = apiList.map(api => smartFetch(`${api.url}${api.url.includes('?')?'&':'?'}ac=detail&wd=${encodeURIComponent(kw)}`));
        const results = await Promise.allSettled(tasks);
        
        const container = document.getElementById('search-res');
        let hasRes = false;
        results.forEach((res, idx) => {
            if(res.status === 'fulfilled' && res.value) {
                hasRes = true;
                container.innerHTML += res.value.list.map(v => `
                    <div class="card" onclick="reqDetail('${apiList[idx].url}','${v.vod_id}')">
                        <img src="${v.vod_pic}">
                        <div class="info">${v.vod_name}</div>
                    </div>`).join('');
            }
        });
        if(!hasRes) container.innerHTML = "æœªæœåˆ°ä»»ä½•èµ„æºã€‚";
    }

    // --- è¯¦æƒ…ä¸æ¢æº ---
    async function reqDetail(apiUrl, id) {
        currentApi = apiUrl;
        const data = await smartFetch(`${apiUrl}${apiUrl.includes('?')?'&':'?'}ac=detail&ids=${id}`);
        if(!data || !data.list.length) return;
        currentVod = data.list[0];
        
        const raw = currentVod.vod_play_url.split('$$$')[0].split('#');
        currentVod.eps = raw.filter(e => e.includes('$')).map(e => { const p = e.split('$'); return { n: p[0], u: p[1] }; });

        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-title').innerText = currentVod.vod_name;
        document.getElementById('v-info').innerText = currentVod.vod_content?.replace(/<[^>]+>/g, '');
        
        renderApiTabs();
        renderRange();
        
        // è‡ªåŠ¨ç»­æ’­
        const his = history[currentVod.vod_name];
        if(his) {
            const target = currentVod.eps.find(e => e.n === his.ep);
            if(target) play(target.u, target.n, null, his.time);
        }
    }

    function renderApiTabs() {
        document.getElementById('api-tabs').innerHTML = apiList.map(api => `
            <div class="tab-item ${api.url===currentApi?'active':''}" onclick="switchSource('${api.url}')">${api.name}</div>
        `).join('');
    }

    async function switchSource(url) {
        const data = await smartFetch(`${url}${url.includes('?')?'&':'?'}ac=detail&wd=${encodeURIComponent(currentVod.vod_name)}`);
        if(data && data.list.length) reqDetail(url, data.list[0].vod_id);
        else alert("è¯¥çº¿è·¯æœä¸åˆ°æ­¤ç‰‡");
    }

    function renderRange() {
        const bar = document.getElementById('range-tabs');
        bar.innerHTML = "";
        for(let i=0; i<currentVod.eps.length; i+=50) {
            const btn = document.createElement('div');
            btn.className = 'tab-item';
            btn.innerText = `${i+1}-${Math.min(i+50, currentVod.eps.length)}`;
            btn.onclick = () => {
                document.querySelectorAll('#range-tabs .tab-item').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEpGrid(currentVod.eps.slice(i, i+50));
            };
            bar.appendChild(btn);
        }
        if(bar.firstChild) bar.firstChild.click();
    }

    function renderEpGrid(slice) {
        document.getElementById('ep-grid').innerHTML = slice.map(e => `
            <div class="ep-btn ${history[currentVod.vod_name]?.ep === e.n?'active':''}" onclick="play('${e.u}','${e.n}',this)">${e.n}</div>
        `).join('');
    }

    // --- æ’­æ”¾å™¨ä¼˜åŒ– (æ ¸å¿ƒå¡é¡¿ä¿®å¤) ---
    function play(url, epName, el, startTime = 0) {
        if(el) { document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
        if(player) player.dispose();
        
        document.getElementById('v-wrapper').innerHTML = `<video id="v-core" class="video-js vjs-16-9" controls></video>`;
        
        // æ³¨å…¥ HLS ä¼˜åŒ–å‚æ•°
        player = videojs('v-core', {
            html5: {
                hls: {
                    overrideNative: true,
                    enableLowInitialPlaylist: true,
                    smoothQualityChange: true,
                    bufferLength: 30 // é¢„ç•™30ç§’ç¼“å†²åŒºï¼Œé˜²æ­¢å¡é¡¿
                }
            }
        });

        player.src({ src: url, type: 'application/x-mpegURL' });
        player.ready(() => {
            player.play();
            if(startTime > 0) player.currentTime(startTime);
            
            // å®æ—¶è¯¦æƒ…å±•ç¤º
            const timer = setInterval(() => {
                if(!player || player.isDisposed()) return clearInterval(timer);
                const vid = document.querySelector('video');
                if(vid) {
                    const speed = (player.bufferedEnd() - player.currentTime()).toFixed(1);
                    document.getElementById('v-details').innerText = `è§£æ: ${vid.videoWidth}x${vid.videoHeight} | ç¼“å­˜: ${speed}s | è¿›åº¦: ${Math.floor(player.currentTime())}s`;
                }
            }, 1000);
        });

        player.on('timeupdate', () => {
            history[currentVod.vod_name] = { ep: epName, time: player.currentTime() };
            localStorage.setItem('joe_v21_his', JSON.stringify(history));
        });
    }

    // --- åŸºç¡€é€»è¾‘ ---
    async function route(id, el) {
        if(el) { document.querySelectorAll('.nav div').forEach(d => d.classList.remove('active')); el.classList.add('active'); }
        const view = document.getElementById('main-view');
        view.innerHTML = "æ­£åœ¨åŠ è½½...";
        if(!apiList.length) return;
        const data = await smartFetch(`${apiList[0].url}${apiList[0].url.includes('?')?'&':'?'}ac=detail&t=${id==='home'?'':id}`);
        if(data) {
            view.innerHTML = `<div class="grid">${data.list.map(v => {
                const h = history[v.vod_name] ? `<div class="his-tag">çœ‹è‡³:${history[v.vod_name].ep}</div>` : '';
                return `<div class="card" onclick="reqDetail('${apiList[0].url}','${v.vod_id}')">
                    <img src="${v.vod_pic}">${h}
                    <div class="info">${v.vod_name}</div>
                </div>`;
            }).join('')}</div>`;
        }
    }

    function toggleModal(s) { document.getElementById('mgr-modal').style.display = s?'flex':'none'; if(s) renderMgr(); }
    function renderMgr() { document.getElementById('api-mgr-list').innerHTML = apiList.map((a, i) => `<div style="padding:8px; display:flex; justify-content:space-between; border-bottom:1px solid #eee;"><span>${a.name}</span><span style="color:red; cursor:pointer;" onclick="apiList.splice(${i},1);renderMgr();localStorage.setItem('joe_v21_apis',JSON.stringify(apiList))">åˆ é™¤</span></div>`).join(''); }
    async function batchAdd() {
        const lines = document.getElementById('api-input').value.split('\n');
        for(let l of lines) { if(l.trim()) { const d = await smartFetch(l.trim()+(l.includes('?')?'&':'?')+'ac=list'); apiList.push({name: d?d.name:'çº¿è·¯', url: l.trim()}); } }
        localStorage.setItem('joe_v21_apis', JSON.stringify(apiList));
        location.reload();
    }
    function closePlayer() { if(player) player.pause(); document.getElementById('player-page').style.display='none'; route('home'); }
    window.onload = () => route('home');
</script>
</body>
</html>
