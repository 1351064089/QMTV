<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE OS | Ultimate V13</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #a29bfe; --bg: #f8fafc; --text: #1e293b; --card: #ffffff; --accent: #6c5ce7; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "PingFang SC", sans-serif; }
        
        /* å¯¼èˆªæ  - æ·±åº¦å¤åˆ» DecoTV */
        header { 
            position: sticky; top: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px);
            display: flex; align-items: center; padding: 10px 40px; z-index: 1000; border-bottom: 1px solid #e2e8f0;
        }
        .logo { font-size: 26px; font-weight: 900; color: var(--main); margin-right: 40px; cursor: pointer; letter-spacing: -1px; }
        .nav { display: flex; gap: 15px; flex: 1; }
        .nav div { padding: 8px 20px; border-radius: 20px; cursor: pointer; font-size: 14px; background: #f1f5f9; transition: 0.2s; font-weight: 500; }
        .nav .active { background: var(--main); color: white; box-shadow: 0 4px 12px rgba(162, 155, 254, 0.4); }
        .nav .btn-mgr { background: #fff3bf; color: #e67700; border: 1px solid #fab005; }

        .search-area { position: relative; width: 320px; }
        .search-area input { width: 100%; padding: 10px 20px; border-radius: 25px; border: 1px solid #e2e8f0; background: #f1f5f9; outline: none; font-size: 14px; transition: 0.3s; }
        .search-area input:focus { background: #fff; border-color: var(--main); box-shadow: 0 0 0 4px rgba(162, 155, 254, 0.1); }

        /* å†…å®¹åŒº */
        .container { max-width: 1450px; margin: 30px auto; padding: 0 25px; }
        .section-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 25px; }
        .section-title { font-size: 22px; font-weight: 800; display: flex; align-items: center; gap: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; }
        
        /* å½±ç‰‡å¡ç‰‡ */
        .card { background: var(--card); border-radius: 16px; overflow: hidden; cursor: pointer; transition: 0.4s cubic-bezier(0.165, 0.84, 0.44, 1); border: 1px solid #f1f5f9; position: relative; }
        .card:hover { transform: translateY(-8px); box-shadow: 0 20px 40px rgba(0,0,0,0.08); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: #f1f5f9; }
        .card .title { padding: 12px; text-align: center; font-size: 14px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card .badge { position: absolute; top: 12px; right: 12px; background: rgba(0,0,0,0.7); color: #fff; font-size: 11px; padding: 4px 10px; border-radius: 8px; backdrop-filter: blur(4px); }

        /* æ’­æ”¾å™¨é¡µé¢ */
        #player-page { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; }
        .player-layout { display: grid; grid-template-columns: 1fr 420px; gap: 30px; max-width: 1600px; margin: 20px auto; padding: 20px; }
        .v-container { background: #000; border-radius: 24px; overflow: hidden; box-shadow: 0 30px 60px rgba(0,0,0,0.3); position: relative; }
        
        /* ä¾§è¾¹é€‰é›†é¢æ¿ */
        .side-panel { background: #fff; border-radius: 24px; height: 800px; display: flex; flex-direction: column; border: 1px solid #e2e8f0; overflow: hidden; }
        .side-tabs { display: flex; padding: 8px; background: #f8fafc; border-bottom: 1px solid #f1f5f9; }
        .s-tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: 800; font-size: 15px; color: #94a3b8; border-radius: 15px; transition: 0.3s; }
        .s-tab.active { background: #fff; color: var(--main); box-shadow: 0 4px 12px rgba(0,0,0,0.05); }

        /* é›†æ•°åˆ†é¡µå™¨ */
        .range-container { padding: 12px; border-bottom: 1px solid #f1f5f9; background: #fff; }
        .range-scroll { display: flex; gap: 8px; overflow-x: auto; padding-bottom: 5px; }
        .range-scroll::-webkit-scrollbar { height: 4px; }
        .range-btn { padding: 6px 15px; background: #f1f5f9; border-radius: 10px; font-size: 12px; white-space: nowrap; cursor: pointer; font-weight: 600; }
        .range-btn.active { background: var(--main); color: #fff; }

        /* é›†æ•°åˆ—è¡¨ */
        .ep-list-wrapper { flex: 1; overflow-y: auto; padding: 20px; }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; }
        .ep-box { background: #f8fafc; border: 1px solid #f1f5f9; padding: 15px 0; text-align: center; border-radius: 12px; font-size: 13px; font-weight: 600; cursor: pointer; transition: 0.2s; }
        .ep-box:hover { border-color: var(--main); color: var(--main); background: #fff; }
        .ep-box.active { background: var(--main); color: #fff; border-color: var(--main); box-shadow: 0 4px 10px rgba(162, 155, 254, 0.3); }

        /* çº¿è·¯åˆ—è¡¨ */
        .src-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 20px; margin-bottom: 10px; background: #f8fafc; border-radius: 15px; cursor: pointer; border: 1px solid transparent; }
        .src-item:hover { border-color: var(--main); background: #fff; }
        .src-item.active { border-color: var(--main); background: rgba(162, 155, 254, 0.05); }
        .src-name { font-weight: 700; font-size: 14px; }
        .src-ping { font-size: 11px; color: #22c55e; font-family: monospace; }

        /* å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.8); backdrop-filter: blur(8px); display: none; align-items: center; justify-content: center; z-index: 5000; }
        .modal-card { background: #fff; width: 550px; border-radius: 30px; padding: 35px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        textarea { width: 100%; height: 150px; border: 2px solid #f1f5f9; border-radius: 20px; padding: 15px; font-family: monospace; font-size: 13px; margin: 15px 0; outline: none; transition: 0.3s; resize: none; }
        textarea:focus { border-color: var(--main); }
        .btn-full { width: 100%; padding: 15px; background: var(--main); color: #fff; border: none; border-radius: 20px; font-weight: 800; font-size: 16px; cursor: pointer; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE OS</div>
    <div class="nav">
        <div class="active" onclick="initHome('Movie')">ç”µå½±</div>
        <div onclick="initHome('TV')">å‰§é›†</div>
        <div onclick="initHome('Anime')">åŠ¨æ¼«</div>
        <div class="btn-mgr" onclick="openMgr()">âš™ï¸ æºç®¡ç†</div>
    </div>
    <div class="search-area">
        <input type="text" id="kw" placeholder="å›è½¦æœç´¢å…¨ç½‘èµ„æº..." onkeydown="if(event.keyCode==13) search()">
    </div>
</header>

<div class="container">
    <div class="section-header">
        <div class="section-title" id="stitle">ğŸ”¥ æ­£åœ¨å‘ç°</div>
    </div>
    <div class="grid" id="m-grid"></div>
</div>

<div id="player-page">
    <div style="padding: 25px 50px; cursor:pointer; font-weight:800; color:var(--main); font-size:18px;" onclick="closePlayer()"> â† è¿”å›æ¢ç´¢</div>
    <div class="player-layout">
        <div class="v-main">
            <div class="v-container">
                <video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto"></video>
            </div>
            <div style="background:#fff; margin-top:25px; padding:30px; border-radius:24px; border:1px solid #e2e8f0;">
                <h1 id="v-title" style="margin:0; font-size:28px; letter-spacing:-1px;"></h1>
                <div style="margin-top:20px; display:flex; gap:30px; font-size:14px; color:#64748b; font-weight:600;">
                    <span>â±ï¸ è·³è¿‡ç‰‡å¤´: <input type="number" id="sk-s" value="0" style="width:50px; border:none; background:#f1f5f9; padding:5px; border-radius:5px; text-align:center;" onchange="saveSet()"> ç§’</span>
                    <label style="cursor:pointer;"><input type="checkbox" id="at-n" checked onchange="saveSet()"> è‡ªåŠ¨è¿æ’­</label>
                </div>
                <p id="v-desc" style="margin-top:20px; line-height:1.8; color:#94a3b8; font-size:14px;"></p>
            </div>
        </div>
        <div class="side-panel">
            <div class="side-tabs">
                <div class="s-tab active" onclick="switchSide('ep')">é€‰é›†åˆ—è¡¨</div>
                <div class="s-tab" onclick="switchSide('src')">çº¿è·¯åˆ‡æ¢</div>
            </div>
            <div id="sec-ep" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                <div class="range-container"><div class="range-scroll" id="r-scroll"></div></div>
                <div class="ep-list-wrapper"><div class="ep-grid" id="ep-grid"></div></div>
            </div>
            <div id="sec-src" class="ep-list-wrapper" style="display:none;">
                <div id="src-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="modal-mgr">
    <div class="modal-card">
        <h2 style="margin:0">è§†é¢‘æºç®¡ç†</h2>
        <div id="api-list" style="margin-top:20px; max-height:200px; overflow-y:auto;"></div>
        <div style="margin-top:20px; border-top:1px solid #f1f5f9; pt:20px;">
            <p style="font-size:12px; color:#94a3b8;">æ·»åŠ æ–°æº (APIåœ°å€ï¼Œä¸€è¡Œä¸€ä¸ª):</p>
            <textarea id="api-in" placeholder="http://xxx.com/api.php/provide/vod/at/json/"></textarea>
            <button class="btn-full" onclick="importApis()">è§£æå¹¶ä¿å­˜çº¿è·¯</button>
            <button onclick="closeMgr()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:15px; cursor:pointer; font-weight:600;">æš‚ä¸å¤„ç†</button>
        </div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('v-core');
    let apis = JSON.parse(localStorage.getItem('joe_v13_apis') || '[]');
    let settings = JSON.parse(localStorage.getItem('joe_v13_set') || '{"skip":0,"auto":true}');
    let currentRawEps = [];

    // --- 1. æ•°æ®åˆå§‹åŒ– ---
    async function initHome(type) {
        const grid = document.getElementById('m-grid');
        document.getElementById('stitle').innerText = "ğŸ”¥ æ­£åœ¨å‘ç° Â· " + (type==='Movie'?'ç”µå½±':type==='TV'?'å‰§é›†':'åŠ¨æ¼«');
        grid.innerHTML = "<div style='grid-column:1/-1; text-align:center; padding:100px; color:#94a3b8;'>æ­£åœ¨åŒæ­¥äº‘ç«¯æ•°æ®...</div>";

        try {
            const res = await fetch(`https://api.wmdb.tv/api/v1/top?type=${type}&skip=0&limit=36`).then(r => r.json());
            renderGrid(res.map(m => ({ name: m.data[0].name, pic: m.data[0].poster, tag: m.doubanRating })));
        } catch(e) {
            if(apis.length) fetchFromApi(apis[0]);
            else grid.innerHTML = "<div style='grid-column:1/-1; text-align:center; padding:100px; color:#94a3b8;'>æš‚æ— æœ¬åœ°æºï¼Œè¯·å…ˆç‚¹å‡»â€œæºç®¡ç†â€å¯¼å…¥ã€‚</div>";
        }
    }

    async function fetchFromApi(api) {
        try {
            const res = await fetch(api.url + "?ac=detail").then(r => r.json());
            renderGrid(res.list.map(v => ({ name: v.vod_name, pic: v.vod_pic, tag: v.vod_remarks })));
        } catch(e) { console.error("æºåŠ è½½å¤±è´¥"); }
    }

    function renderGrid(data) {
        const grid = document.getElementById('m-grid');
        grid.innerHTML = "";
        data.forEach(item => {
            const div = document.createElement('div');
            div.className = 'card';
            div.innerHTML = `<div class="badge">${item.tag}</div><img src="${item.pic}"><div class="title">${item.name}</div>`;
            div.onclick = () => { document.getElementById('kw').value = item.name; search(); };
            grid.appendChild(div);
        });
    }

    // --- 2. æœç´¢é€»è¾‘ ---
    async function search() {
        const kw = document.getElementById('kw').value;
        if(!kw || !apis.length) return alert("è¯·å…ˆè¾“å…¥å…³é”®è¯å¹¶ç¡®ä¿æœ‰å¯ç”¨æºï¼");
        const grid = document.getElementById('m-grid');
        grid.innerHTML = "<div style='grid-column:1/-1; text-align:center; padding:100px; color:#94a3b8;'>å…¨ç½‘ç©¿é€æœç´¢ä¸­...</div>";

        const results = await Promise.allSettled(apis.map(async api => {
            const start = Date.now();
            const res = await fetch(`${api.url}?ac=detail&wd=${encodeURIComponent(kw)}`).then(r => r.json());
            return { api, list: res.list || [], ms: Date.now() - start };
        }));

        grid.innerHTML = "";
        results.forEach(res => {
            if(res.status === 'fulfilled' && res.value.list.length > 0) {
                res.value.list.forEach(v => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `<div class="badge" style="background:#22c55e">${res.value.ms}ms</div><img src="${v.vod_pic}"><div class="title">${v.vod_name}</div>`;
                    card.onclick = () => openPlayer(v, results);
                    grid.appendChild(card);
                });
            }
        });
    }

    // --- 3. æ’­æ”¾ä¸ã€æ·±åº¦ä¿®å¤ã€‘é›†æ•°é€»è¾‘ ---
    function openPlayer(v, allRes) {
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-title').innerText = v.vod_name;
        document.getElementById('v-desc').innerText = v.vod_content.replace(/<[^>]+>/g, '');
        document.getElementById('sk-s').value = settings.skip;
        document.getElementById('at-n').checked = settings.auto;

        const sList = document.getElementById('src-list');
        sList.innerHTML = "";
        allRes.forEach(res => {
            if(res.status === 'fulfilled' && res.value.list.length > 0) {
                const item = document.createElement('div');
                item.className = 'src-item';
                item.innerHTML = `<span class="src-name">${res.value.api.name}</span><span class="src-ping">${res.value.ms}ms</span>`;
                item.onclick = () => {
                    document.querySelectorAll('.src-item').forEach(i => i.classList.remove('active'));
                    item.classList.add('active');
                    // æ ¸å¿ƒä¿®æ­£ï¼šä¸¥æ ¼æŒ‰ç…§æ•°æ®æºåˆ†å‰²ï¼Œä¸ç•™è„æ•°æ®
                    currentRawEps = res.value.list[0].vod_play_url.split('#').filter(e => e.includes('$'));
                    renderRangeBar();
                    switchSide('ep');
                };
                sList.appendChild(item);
            }
        });
        if(sList.firstChild) sList.firstChild.click();
    }

    function renderRangeBar() {
        const scroll = document.getElementById('r-scroll');
        scroll.innerHTML = "";
        const size = 50;
        const total = currentRawEps.length;

        // åŠ¨æ€è®¡ç®—åˆ†é¡µï¼Œä¸å†™æ­»å¾ªç¯
        for (let i = 0; i < total; i += size) {
            const end = Math.min(i + size, total);
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = `${i + 1}-${end}`;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEpGrid(i, end);
            };
            scroll.appendChild(btn);
        }
        if(scroll.firstChild) scroll.firstChild.click();
    }

    function renderEpGrid(start, end) {
        const grid = document.getElementById('ep-grid');
        grid.innerHTML = "";
        // ä¸¥æ ¼æ ¹æ® slice åˆ‡ç‰‡ï¼Œç»ä¸å›æµ
        const slice = currentRawEps.slice(start, end);
        slice.forEach((item, index) => {
            const [name, url] = item.split('$');
            const box = document.createElement('div');
            box.className = 'ep-box';
            box.innerText = name.includes('ç¬¬') ? name : `ç¬¬${name}é›†`;
            box.onclick = () => {
                document.querySelectorAll('.ep-box').forEach(b => b.classList.remove('active'));
                box.classList.add('active');
                player.src({ src: url, type: 'application/x-mpegURL' });
                player.one('loadedmetadata', () => { if(settings.skip > 0) player.currentTime(settings.skip); });
                player.play();
            };
            grid.appendChild(box);
        });
    }

    // --- 4. æºç®¡ç† ---
    function openMgr() {
        document.getElementById('modal-mgr').style.display = 'flex';
        renderApiList();
    }
    function closeMgr() { document.getElementById('modal-mgr').style.display = 'none'; }
    
    function renderApiList() {
        const list = document.getElementById('api-list');
        list.innerHTML = apis.length ? "" : "<p style='color:#999;font-size:12px;'>æš‚æ— è‡ªå®šä¹‰çº¿è·¯</p>";
        apis.forEach((api, idx) => {
            const div = document.createElement('div');
            div.style = "display:flex; justify-content:space-between; padding:10px; background:#f8fafc; margin-bottom:5px; border-radius:10px; font-size:13px;";
            div.innerHTML = `<b>${api.name}</b> <span style="color:#ff7675; cursor:pointer;" onclick="delApi(${idx})">åˆ é™¤</span>`;
            list.appendChild(div);
        });
    }

    async function importApis() {
        const urls = document.getElementById('api-in').value.split('\n').map(u => u.trim()).filter(u => u);
        for(let u of urls) {
            if(apis.some(a => a.url === u)) continue;
            try {
                const res = await fetch(u + "?ac=list").then(r => r.json());
                const name = res.source?.name || (res.class && res.class[0] ? res.class[0].name : "é‡‡é›†ç«™") + (apis.length+1);
                apis.push({ name, url: u });
            } catch(e) {}
        }
        localStorage.setItem('joe_v13_apis', JSON.stringify(apis));
        document.getElementById('api-in').value = "";
        renderApiList();
    }

    function delApi(idx) {
        apis.splice(idx, 1);
        localStorage.setItem('joe_v13_apis', JSON.stringify(apis));
        renderApiList();
    }

    // --- 5. è¾…åŠ© ---
    function switchSide(t) {
        document.getElementById('sec-ep').style.display = t==='ep'?'flex':'none';
        document.getElementById('sec-src').style.display = t==='src'?'block':'none';
        document.querySelectorAll('.s-tab').forEach((el, idx) => el.classList.toggle('active', (t==='ep' && idx===0) || (t==='src' && idx===1)));
    }
    function saveSet() {
        settings.skip = parseInt(document.getElementById('sk-s').value) || 0;
        settings.auto = document.getElementById('at-n').checked;
        localStorage.setItem('joe_v13_set', JSON.stringify(settings));
    }
    function closePlayer() { player.pause(); document.getElementById('player-page').style.display = 'none'; }
    
    player.on('ended', () => {
        if(settings.auto) {
            const next = document.querySelector('.ep-box.active')?.nextSibling;
            if(next) next.click();
        }
    });

    window.onload = () => initHome('Movie');
</script>
</body>
</html>
