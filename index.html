<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE TV V21.5 | å¤šæºæµ‹é€Ÿç®¡ç†ç‰ˆ</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #6c5ce7; --bg: #f4f7f6; --text: #2d3436; --success: #2ecc71; --error: #e74c3c; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "PingFang SC", sans-serif; }
        
        /* å¯¼èˆª */
        header { position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; align-items: center; padding: 10px 30px; z-index: 1000; border-bottom: 1px solid #e0e0e0; }
        .logo { font-size: 22px; font-weight: 900; color: var(--main); margin-right: 30px; cursor: pointer; }
        .nav { display: flex; gap: 8px; flex: 1; overflow-x: auto; scrollbar-width: none; }
        .nav div { padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; background: #f1f5f9; font-weight: bold; white-space: nowrap; transition: 0.2s; }
        .nav .active { background: var(--main); color: white; }
        .mgr-btn { background: #fff8e1 !important; color: #f57c00 !important; border: 1px solid #ffe0b2; }

        .search-box input { width: 220px; padding: 9px 18px; border-radius: 20px; border: 1px solid #ddd; outline: none; transition: 0.3s; }
        .search-box input:focus { width: 300px; border-color: var(--main); }

        /* å†…å®¹åŒº */
        .container { max-width: 1650px; margin: 25px auto; padding: 0 20px; }
        .row-title { font-size: 18px; font-weight: 800; margin: 30px 0 15px; border-left: 5px solid var(--main); padding-left: 12px; display: flex; align-items: center; gap: 15px; }
        .source-tag { font-size: 10px; background: var(--main); color: #fff; padding: 2px 6px; border-radius: 4px; }

        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(165px, 1fr)); gap: 20px; }
        .card { background: #fff; border-radius: 14px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid #f1f5f9; position: relative; }
        .card:hover { transform: translateY(-6px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .info { padding: 10px; text-align: center; font-size: 13px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* æ’­æ”¾å™¨ */
        #player-page { position: fixed; inset: 0; background: #f1f5f9; z-index: 2000; display: none; overflow-y: auto; }
        .p-layout { display: grid; grid-template-columns: 1fr 400px; gap: 25px; max-width: 1700px; margin: 0 auto; padding: 20px; }
        .v-box { background: #000; border-radius: 16px; overflow: hidden; aspect-ratio: 16/9; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        
        /* é€‰é›†æ§åˆ¶ */
        .side-panel { background: #fff; border-radius: 16px; border: 1px solid #e2e8f0; display: flex; flex-direction: column; height: fit-content; }
        .range-bar { display: flex; gap: 8px; padding: 12px; overflow-x: auto; background: #f8fafc; border-bottom: 1px solid #eee; }
        .range-btn { padding: 6px 12px; border-radius: 8px; font-size: 12px; cursor: pointer; background: #fff; border: 1px solid #ddd; white-space: nowrap; }
        .range-btn.active { background: var(--main); color: #fff; border-color: var(--main); }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; max-height: 450px; overflow-y: auto; }
        .ep-item { background: #f1f5f9; padding: 10px 0; text-align: center; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .ep-item.active { background: var(--main); color: #fff; }

        /* ç®¡ç†å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: #fff; width: 90%; max-width: 550px; padding: 30px; border-radius: 20px; }
        .api-list-item { display: flex; justify-content: space-between; align-items: center; padding: 10px; border-bottom: 1px solid #eee; font-size: 13px; }
        .speed-tag { font-size: 11px; margin-left: 10px; font-weight: bold; }
        .speed-fast { color: var(--success); }
        .speed-slow { color: var(--error); }
        textarea { width: 100%; height: 100px; margin: 15px 0; padding: 12px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
        
        .btn-group { display: flex; gap: 10px; }
        button { flex: 1; padding: 12px; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; }
        .btn-primary { background: var(--main); color: #fff; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE TV</div>
    <div class="nav" id="main-nav">
        <div class="active" onclick="route('home', this)">ğŸ  é¦–é¡µ</div>
        <div onclick="route('movie', this)">ğŸ¬ ç”µå½±</div>
        <div onclick="route('tv', this)">ğŸ“º å‰§é›†</div>
        <div onclick="route('short', this)">ğŸ“± çŸ­å‰§</div>
        <div class="mgr-btn" onclick="toggleModal(true)">âš™ï¸ çº¿è·¯ç®¡ç†</div>
    </div>
    <div class="search-box">
        <input type="text" id="kw" placeholder="å¤šæºå¹¶å‘æœç´¢..." onkeydown="if(event.keyCode==13) search()">
    </div>
</header>

<div class="container" id="main-view"></div>

<div id="player-page">
    <div style="padding: 15px 25px; font-weight: 800; color: var(--main); cursor: pointer;" onclick="closePlayer()">ğŸ”™ è¿”å›åˆ—è¡¨</div>
    <div class="p-layout">
        <div class="p-left">
            <div class="v-box" id="v-wrapper"></div>
            <div style="background:#fff; padding:25px; border-radius:16px; margin-top:20px;">
                <h2 id="v-name" style="margin:0 0 10px 0;"></h2>
                <div style="font-size:13px; color:#666;">
                    ğŸš€ è·³è¿‡ç‰‡å¤´: <input type="number" id="sk-start" style="width:50px" onchange="saveConf()">
                    <span style="margin-left:15px;">ğŸ è·³è¿‡ç‰‡å°¾: <input type="number" id="sk-end" style="width:50px" onchange="saveConf()"></span>
                    <label style="margin-left:15px;"><input type="checkbox" id="at-next" checked onchange="saveConf()"> è‡ªåŠ¨è¿æ’­</label>
                </div>
                <p id="v-desc" style="font-size:14px; color:#64748b; line-height:1.7; margin-top:15px;"></p>
            </div>
        </div>
        <div class="side-panel">
            <div style="padding:15px; font-weight:800; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                <span>ğŸ“¡ é€‰é›†åˆ—è¡¨</span>
                <span style="color:var(--main); cursor:pointer; font-size:12px;" onclick="toggleSort()">æ­£/å€’åº</span>
            </div>
            <div id="range-bar" class="range-bar"></div>
            <div id="e-grid" class="ep-grid"></div>
        </div>
    </div>
</div>

<div id="mgr-modal" class="modal">
    <div class="modal-content">
        <h3 style="margin-top:0;">çº¿è·¯ç®¡ç†ä¸­å¿ƒ</h3>
        <div id="api-mgr-list" style="max-height:200px; overflow-y:auto; border:1px solid #eee; border-radius:10px;"></div>
        <textarea id="api-input" placeholder="è¾“å…¥å¤šä¸ª API åœ°å€ï¼Œä¸€è¡Œä¸€ä¸ª..."></textarea>
        <div class="btn-group">
            <button class="btn-primary" onclick="batchImport()">æ‰¹é‡å¯¼å…¥å¹¶è¯†åˆ«</button>
            <button style="background:#e8f5e9; color:#2e7d32;" onclick="testSpeed()">å¼€å§‹æµ‹é€Ÿ</button>
            <button onclick="toggleModal(false)">å…³é—­</button>
        </div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    let player = null;
    let apiList = JSON.parse(localStorage.getItem('joe_v21_apis') || '[]');
    let config = JSON.parse(localStorage.getItem('joe_v20_conf') || '{"skipStart":0,"skipEnd":0,"auto":true}');
    let currentVod = null, isReverse = false;

    // --- ä¸‡èƒ½è§£æå¼•æ“ ---
    async function smartFetch(url) {
        try {
            const res = await fetch(url, { signal: AbortSignal.timeout(5000) });
            const text = await res.text();
            if (text.trim().startsWith('<?xml') || text.trim().startsWith('<rss')) {
                const xml = new DOMParser().parseFromString(text, "text/xml");
                return { 
                    sourceName: xml.querySelector('rss')?.getAttribute('name') || 'æœªçŸ¥XMLæº',
                    list: Array.from(xml.querySelectorAll('video')).map(v => ({
                        vod_id: v.querySelector('id')?.textContent,
                        vod_name: v.querySelector('name')?.textContent,
                        vod_pic: v.querySelector('pic')?.textContent,
                        vod_content: v.querySelector('des')?.textContent,
                        vod_play_url: v.querySelector('dl dd')?.textContent
                    }))
                };
            }
            const json = JSON.parse(text);
            return { sourceName: json.source?.name || 'æœªçŸ¥JSONæº', list: json.list || [] };
        } catch(e) { return null; }
    }

    // --- åˆå§‹åŒ–ä¸è·¯ç”± ---
    async function route(id, el) {
        if(el) { document.querySelectorAll('.nav div').forEach(d => d.classList.remove('active')); el.classList.add('active'); }
        const view = document.getElementById('main-view');
        view.innerHTML = `<div class="row-title">æ­£åœ¨åŠ è½½...</div><div class="grid" id="g-main"></div>`;
        
        if(!apiList.length) { view.innerHTML = "è¯·å…ˆç‚¹å‡»çº¿è·¯ç®¡ç†å¯¼å…¥æ¥å£"; return; }
        
        const param = id === 'home' ? '' : `wd=${{movie:'ç”µå½±',tv:'å‰§',short:'çŸ­å‰§'}[id] || id}`;
        // é»˜è®¤ä½¿ç”¨æµ‹é€Ÿæœ€å¿«çš„æˆ–ç¬¬ä¸€ä¸ªæº
        fetchList(apiList[0].url, 'g-main', param);
    }

    async function fetchList(apiUrl, gid, param) {
        const data = await smartFetch(`${apiUrl}?ac=detail&${param}`);
        if(data) {
            document.getElementById(gid).innerHTML += data.list.map(v => `
                <div class="card" onclick="reqDetail('${apiUrl}','${v.vod_id}')">
                    <img src="${v.vod_pic}">
                    <div class="info">${v.vod_name}</div>
                </div>`).join('');
        }
    }

    async function search() {
        const kw = document.getElementById('kw').value;
        if(!kw) return;
        const view = document.getElementById('main-view');
        view.innerHTML = `<div class="row-title">ğŸ” å¤šæºå¹¶å‘æœç´¢ç»“æœ: ${kw}</div><div class="grid" id="g-search"></div>`;
        // å¹¶å‘è¯·æ±‚æ‰€æœ‰æº
        apiList.forEach(api => fetchList(api.url, 'g-search', `wd=${encodeURIComponent(kw)}`));
    }

    // --- æ’­æ”¾é€»è¾‘ ---
    async function reqDetail(apiUrl, id) {
        const data = await smartFetch(`${apiUrl}?ac=detail&ids=${id}`);
        currentVod = data.list[0];
        const epsRaw = currentVod.vod_play_url.split('$$$')[0].split('#'); 
        currentVod.processedEps = epsRaw.filter(s => s.includes('$')).map(e => {
            const p = e.split('$'); return { n: p[0], u: p[1] };
        });

        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-name').innerText = currentVod.vod_name;
        document.getElementById('v-desc').innerText = currentVod.vod_content?.replace(/<[^>]+>/g, '');
        document.getElementById('sk-start').value = config.skipStart;
        document.getElementById('sk-end').value = config.skipEnd;
        
        renderRangeTabs();
    }

    function renderRangeTabs() {
        const eps = isReverse ? [...currentVod.processedEps].reverse() : currentVod.processedEps;
        const bar = document.getElementById('range-bar');
        bar.innerHTML = "";
        for(let i=0; i<eps.length; i+=50) {
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = `${i+1}-${Math.min(i+50, eps.length)}`;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEpGrid(eps.slice(i, i+50));
            };
            bar.appendChild(btn);
        }
        if(bar.firstChild) bar.firstChild.click();
    }

    function renderEpGrid(slice) {
        document.getElementById('e-grid').innerHTML = slice.map(e => `<div class="ep-item" onclick="play('${e.u}','${e.n}', this)">${e.n}</div>`).join('');
    }

    function play(url, name, el) {
        document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');

        if(player) player.dispose();
        document.getElementById('v-wrapper').innerHTML = `<video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto"></video>`;
        
        player = videojs('v-core');
        player.src({ src: url, type: 'application/x-mpegURL' });
        player.ready(() => {
            player.play();
            if(config.skipStart > 0) player.currentTime(config.skipStart);
        });

        player.on('timeupdate', () => {
            const curr = player.currentTime(), dur = player.duration();
            if(config.auto && config.skipEnd > 0 && dur > 0 && (dur - curr < config.skipEnd)) playNext();
        });
        player.on('ended', () => { if(config.auto) playNext(); });
    }

    function playNext() { const next = document.querySelector('.ep-item.active')?.nextSibling; if(next) next.click(); }
    function toggleSort() { isReverse = !isReverse; renderRangeTabs(); }

    // --- ç®¡ç†ä¸æµ‹é€Ÿ ---
    function toggleModal(show) { 
        document.getElementById('mgr-modal').style.display = show?'flex':'none'; 
        if(show) renderMgrList();
    }

    async function batchImport() {
        const lines = document.getElementById('api-input').value.split('\n');
        for(let url of lines) {
            url = url.trim();
            if(!url || apiList.some(a => a.url === url)) continue;
            const data = await smartFetch(`${url}?ac=list`);
            if(data) apiList.push({ name: data.sourceName, url: url, speed: 9999 });
        }
        saveApis();
    }

    function renderMgrList() {
        document.getElementById('api-mgr-list').innerHTML = apiList.map((a, i) => `
            <div class="api-list-item">
                <div>
                    <b>${a.name}</b>
                    <span class="speed-tag ${a.speed < 500 ? 'speed-fast' : 'speed-slow'}">${a.speed === 9999 ? '-' : a.speed+'ms'}</span>
                </div>
                <button onclick="removeApi(${i})" style="flex:none; padding:4px 8px; background:#ffebee; color:red; font-size:11px;">åˆ é™¤</button>
            </div>`).join('');
    }

    async function testSpeed() {
        for(let api of apiList) {
            const start = Date.now();
            try {
                await fetch(`${api.url}?ac=list`, { mode: 'no-cors' });
                api.speed = Date.now() - start;
            } catch(e) { api.speed = 9999; }
            renderMgrList();
        }
        apiList.sort((a, b) => a.speed - b.speed);
        saveApis();
    }

    function removeApi(i) { apiList.splice(i, 1); saveApis(); }
    function saveApis() { localStorage.setItem('joe_v21_apis', JSON.stringify(apiList)); renderMgrList(); }
    function saveConf() {
        config.skipStart = parseInt(document.getElementById('sk-start').value) || 0;
        config.skipEnd = parseInt(document.getElementById('sk-end').value) || 0;
        config.auto = document.getElementById('at-next').checked;
        localStorage.setItem('joe_v20_conf', JSON.stringify(config));
    }
    function closePlayer() { if(player) player.pause(); document.getElementById('player-page').style.display='none'; }

    window.onload = () => route('home');
</script>
</body>
</html>
