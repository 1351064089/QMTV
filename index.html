<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE TV V21.23 | å¯¼å…¥ç›‘æµ‹å¢å¼ºç‰ˆ</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #6c5ce7; --bg: #f4f7f6; --text: #2d3436; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; overflow-x: hidden; }
        header { position: sticky; top: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px); display: flex; align-items: center; padding: 10px 20px; z-index: 1000; border-bottom: 1px solid #ddd; }
        .logo { font-size: 20px; font-weight: bold; color: var(--main); margin-right: 20px; cursor: pointer; }
        .nav { display: flex; gap: 8px; flex: 1; overflow-x: auto; scrollbar-width: none; }
        .nav div { padding: 6px 15px; border-radius: 20px; cursor: pointer; font-size: 13px; background: #eee; white-space: nowrap; font-weight: bold; }
        .nav .active { background: var(--main); color: #fff; }
        .search-box input { padding: 8px 15px; border-radius: 20px; border: 1px solid #ddd; outline: none; width: 220px; }

        .container { max-width: 1600px; margin: 20px auto; padding: 0 15px; }
        .section-h { font-size: 18px; font-weight: bold; margin: 25px 0 15px; display: flex; align-items: center; justify-content: space-between; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card { background: #fff; border-radius: 10px; overflow: hidden; cursor: pointer; transition: 0.2s; position: relative; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: #eee; }
        .card .info { padding: 8px; text-align: center; font-size: 12px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        
        .source-tag { position: absolute; top: 5px; left: 5px; background: rgba(108, 92, 231, 0.8); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; z-index: 2; }
        .his-tag { position: absolute; top: 5px; right: 5px; background: #ff7675; color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; z-index: 2; }

        .history-row { display: flex; gap: 15px; overflow-x: auto; padding: 10px 0; scrollbar-width: none; }
        .history-item { min-width: 160px; background: #fff; border-radius: 8px; overflow: hidden; cursor: pointer; border: 1px solid #eee; }
        .history-item img { width: 100%; aspect-ratio: 16/9; object-fit: cover; }
        .history-item .h-title { padding: 5px; font-size: 11px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        #player-page { position: fixed; inset: 0; background: #f4f4f4; z-index: 2000; display: none; overflow-y: auto; }
        .p-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; padding: 20px; max-width: 1600px; margin: 0 auto; }
        .v-box { background: #000; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; position: relative; }
        #v-details { position: absolute; top: 15px; left: 15px; color: #0f0; background: rgba(0,0,0,0.6); padding: 5px 10px; font-size: 11px; z-index: 10; border-radius: 4px; pointer-events: none; }
        
        .side-panel { background: #fff; border-radius: 12px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #eee; }
        .panel-title { padding: 12px; font-weight: bold; background: #f8f9fa; border-bottom: 1px solid #eee; }
        .tab-bar { display: flex; gap: 8px; padding: 10px; background: #fff; border-bottom: 1px solid #eee; overflow-x: auto; }
        .tab-item { padding: 5px 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 11px; cursor: pointer; white-space: nowrap; }
        .tab-item.active { background: var(--main); color: #fff; border-color: var(--main); }
        
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 15px; max-height: 400px; overflow-y: auto; }
        .ep-btn { background: #f1f5f9; padding: 10px 0; text-align: center; font-size: 12px; border-radius: 6px; cursor: pointer; }
        .ep-btn.active { background: var(--main); color: #fff; }

        /* çŠ¶æ€ä¸è¿›åº¦æ¡æ ·å¼ */
        .progress-container { margin: 10px 0; display: none; }
        .progress-bar { width: 100%; height: 6px; background: #eee; border-radius: 3px; overflow: hidden; margin-bottom: 5px; }
        .progress-fill { width: 0%; height: 100%; background: var(--main); transition: width 0.3s; }
        .status-log { font-size: 11px; color: #666; max-height: 80px; overflow-y: auto; background: #f9f9f9; padding: 8px; border-radius: 6px; border: 1px solid #eee; line-height: 1.5; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 3000; backdrop-filter: blur(4px); }
        .modal-body { background: #fff; width: 90%; max-width: 500px; padding: 25px; border-radius: 15px; }
        textarea { width: 100%; height: 100px; margin: 10px 0; border-radius: 8px; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; font-family: monospace; font-size: 12px;}
        .mgr-btn { width: 100%; padding: 12px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; margin-bottom: 5px; font-size: 13px;}
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE TV</div>
    <div class="nav" id="main-nav">
        <div class="active" onclick="route('home', this)">ğŸ  é¦–é¡µ</div>
        <div onclick="route('1', this)">ç”µå½±</div><div onclick="route('2', this)">å‰§é›†</div>
        <div onclick="route('3', this)">ç»¼è‰º</div><div onclick="route('4', this)">åŠ¨æ¼«</div>
        <div style="background:#fff3e0!important;color:#e65100!important" onclick="toggleModal(true)">âš™ï¸ çº¿è·¯/åŒæ­¥</div>
    </div>
    <div class="search-box">
        <input type="text" id="kw" placeholder="æœç‰‡åæˆ–ç²˜è´´çº¿è·¯..." onkeydown="if(event.keyCode==13) handleSearchInput()">
    </div>
</header>

<div class="container">
    <div id="history-section" style="display:none;">
        <div class="section-h">ğŸ¬ æœ€è¿‘è§‚çœ‹ <span onclick="clearHistory()" style="font-size:12px; color:#999; cursor:pointer;">[æ¸…ç©ºè®°å½•]</span></div>
        <div class="history-row" id="history-row"></div>
    </div>
    <div id="main-view"></div>
</div>

<div id="player-page">
    <div style="padding:15px 20px; color:var(--main); cursor:pointer; font-weight:bold;" onclick="closePlayer()">ğŸ”™ è¿”å›åˆ—è¡¨</div>
    <div class="p-layout">
        <div class="p-main">
            <div class="v-box"><div id="v-details">å°±ç»ª</div><div id="v-wrapper"></div></div>
            <div class="setting-card">
                <h3 id="v-title" style="margin: 0 0 15px 0;"></h3>
                <div style="font-size:13px; color:#666;">
                    è·³è¿‡ç‰‡å¤´ <input type="number" id="set-start" style="width:50px" onchange="saveSettings()"> ç§’ | 
                    ç‰‡å°¾ <input type="number" id="set-end" style="width:50px" onchange="saveSettings()"> ç§’
                    <label style="margin-left:15px"><input type="checkbox" id="set-auto" checked onchange="saveSettings()"> è‡ªåŠ¨è¿æ’­</label>
                </div>
                <p id="v-info" style="font-size:13px; color:#666; margin-top:15px; border-top:1px solid #eee; padding-top:15px;"></p>
            </div>
        </div>
        <div class="side-panel">
            <div class="panel-title">ğŸ“¡ çº¿è·¯åˆ‡æ¢</div><div class="tab-bar" id="api-tabs"></div>
            <div class="panel-title">ğŸ”¢ é€‰é›†æ’­æ”¾</div><div class="tab-bar" id="range-tabs"></div>
            <div class="ep-grid" id="ep-grid"></div>
        </div>
    </div>
</div>

<div id="mgr-modal" class="modal">
    <div class="modal-body">
        <h3 style="margin-top:0">é…ç½®ä¸­å¿ƒ</h3>
        <div id="api-mgr-list" style="max-height:120px; overflow-y:auto; border:1px solid #eee; margin-bottom:10px; border-radius: 8px; font-size:12px;"></div>
        
        <div id="import-progress" class="progress-container">
            <div class="progress-bar"><div id="pg-fill" class="progress-fill"></div></div>
            <div id="st-log" class="status-log">ç­‰å¾…æ“ä½œ...</div>
        </div>

        <textarea id="api-input" placeholder="è¾“å…¥çº¿è·¯URLï¼ˆä¸€è¡Œä¸€ä¸ªï¼‰æˆ–é…ç½®ç "></textarea>
        
        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:8px;">
            <button class="mgr-btn" style="background:var(--main); color:#fff;" onclick="batchAdd()">æ·»åŠ æ™®é€šçº¿è·¯</button>
            <button class="mgr-btn" style="background:#00b894; color:#fff;" onclick="importLunaSubscription()">å¯¼å…¥ Luna è®¢é˜…</button>
            <button class="mgr-btn" style="background:#34495e; color:#fff;" onclick="exportAllConfig()">å¯¼å‡ºé…ç½®ç </button>
            <button class="mgr-btn" style="background:#e67e22; color:#fff;" onclick="importAllConfig()">å¯¼å…¥é…ç½®ç </button>
        </div>
        <button onclick="toggleModal(false)" style="width:100%; border:none; background:none; color:#999; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    let player = null, apiList = JSON.parse(localStorage.getItem('joe_v21_apis') || '[]');
    let history = JSON.parse(localStorage.getItem('joe_v21_his') || '{}');
    let settings = JSON.parse(localStorage.getItem('joe_v21_set') || '{"start":0,"end":0,"auto":true}');
    let currentVod = null, currentApi = '', currentT = '';

    // çŠ¶æ€æ›´æ–°å·¥å…·
    const updateUIStatus = (msg, percent = null) => {
        const container = document.getElementById('import-progress');
        const log = document.getElementById('st-log');
        const fill = document.getElementById('pg-fill');
        container.style.display = 'block';
        log.innerHTML = `> ${msg}<br>${log.innerHTML}`;
        if(percent !== null) fill.style.width = percent + '%';
    };

    async function smartFetch(url, useProxy = false) {
        const finalUrl = useProxy ? "https://api.allorigins.win/get?url=" + encodeURIComponent(url) : url;
        try {
            const res = await fetch(finalUrl, { signal: AbortSignal.timeout(8000) });
            const text = useProxy ? (await res.json()).contents : await res.text();
            if (text.trim().startsWith('<?xml') || text.includes('<rss')) {
                const xml = new DOMParser().parseFromString(text, "text/xml");
                return { name: xml.querySelector('rss')?.getAttribute('name') || 'XMLæº', list: Array.from(xml.querySelectorAll('video')).map(v => ({
                    vod_id: v.querySelector('id')?.textContent || v.querySelector('last')?.textContent,
                    vod_name: v.querySelector('name')?.textContent,
                    vod_pic: v.querySelector('pic')?.textContent,
                    vod_play_url: v.querySelector('dl dd')?.textContent || '',
                    vod_content: v.querySelector('des')?.textContent || ''
                }))};
            }
            const json = JSON.parse(text);
            return { name: json.source?.name || 'JSONæº', list: (json.list || []).map(v => ({...v, vod_id: v.vod_id || v.id, vod_name: v.vod_name || v.name})), raw: json };
        } catch(e) {
            if (!useProxy) return smartFetch(url, true);
            return null;
        }
    }

    async function batchAdd() {
        const urls = document.getElementById('api-input').value.split('\n').filter(l => l.trim().startsWith('http'));
        if(!urls.length) return alert("è¯·è¾“å…¥æœ‰æ•ˆçš„URL");
        
        document.getElementById('st-log').innerHTML = "";
        for(let i=0; i<urls.length; i++) {
            const url = urls[i].trim();
            const p = Math.round(((i + 1) / urls.length) * 100);
            updateUIStatus(`æ­£åœ¨éªŒè¯: ${url.substring(0,30)}...`, p);
            
            const d = await smartFetch(url + (url.includes('?') ? '&' : '?') + 'ac=list');
            if(d) {
                apiList.push({name: d.name, url: url});
                updateUIStatus(`<span style="color:green">æˆåŠŸ: ${d.name}</span>`, p);
            } else {
                updateUIStatus(`<span style="color:red">å¤±è´¥: æ— æ³•è¿æ¥æ­¤æº</span>`, p);
            }
        }
        localStorage.setItem('joe_v21_apis', JSON.stringify(apiList));
        updateUIStatus(`å…¨éƒ¨å®Œæˆï¼å³å°†åˆ·æ–°...`, 100);
        setTimeout(() => location.reload(), 1500);
    }

    async function importLunaSubscription() {
        const url = document.getElementById('api-input').value.trim();
        if(!url.startsWith('http')) return alert("è¯·åœ¨ä¸Šæ–¹æ¡†å†…è¾“å…¥è®¢é˜…é“¾æ¥");
        
        updateUIStatus("æ­£åœ¨è·å–è®¢é˜…å†…å®¹...", 30);
        const res = await smartFetch(url);
        if(res && res.raw && res.raw.list) {
            const subs = res.raw.list.filter(s => s.api);
            for(let i=0; i<subs.length; i++) {
                const item = subs[i];
                const p = Math.round(((i + 1) / subs.length) * 100);
                if(!apiList.find(a => a.url === item.api)) {
                    apiList.push({ name: item.name, url: item.api });
                    updateUIStatus(`å·²æ·»åŠ : ${item.name}`, p);
                }
            }
            localStorage.setItem('joe_v21_apis', JSON.stringify(apiList));
            updateUIStatus("è®¢é˜…åŒæ­¥æˆåŠŸï¼å³å°†åˆ·æ–°...", 100);
            setTimeout(() => location.reload(), 1500);
        } else {
            updateUIStatus("<span style="color:red">é”™è¯¯: ä¸æ˜¯æœ‰æ•ˆçš„è®¢é˜…åœ°å€</span>", 0);
        }
    }

    // æœç´¢åŠŸèƒ½
    async function doGlobalSearch() {
        const kw = document.getElementById('kw').value.trim();
        if(!kw) return;
        const view = document.getElementById('main-view');
        view.innerHTML = `<div class="section-h">ğŸ” æ·±åº¦æœç´¢ä¸­...</div><div class="grid" id="search-res"></div>`;
        
        apiList.forEach(async (api) => {
            const base = api.url + (api.url.includes('?') ? '&' : '?');
            let data = await smartFetch(`${base}ac=detail&wd=${encodeURIComponent(kw)}`);
            if(!data || !data.list.length) data = await smartFetch(`${base}wd=${encodeURIComponent(kw)}`);
            if(data && data.list) {
                const container = document.getElementById('search-res');
                data.list.filter(v => v.vod_name.includes(kw)).forEach(v => {
                    container.innerHTML += `
                        <div class="card" onclick="reqDetail('${api.url}','${v.vod_id}')">
                            <div class="source-tag">${api.name}</div>
                            <img src="${v.vod_pic || 'https://via.placeholder.com/150x220'}">
                            <div class="info">${v.vod_name}</div>
                        </div>`;
                });
            }
        });
    }

    async function reqDetail(apiUrl, id) {
        currentApi = apiUrl;
        const base = apiUrl + (apiUrl.includes('?') ? '&' : '?');
        const data = await smartFetch(`${base}ac=detail&ids=${id}`);
        if(!data || !data.list.length) return;
        currentVod = data.list[0];
        let playInfo = currentVod.vod_play_url.split('$$$')[0];
        currentVod.eps = playInfo.split('#').filter(e => e.includes('$')).map(e => {
            const p = e.split('$'); return { n: p[0], u: p[1] };
        });
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-title').innerText = currentVod.vod_name;
        document.getElementById('v-info').innerText = currentVod.vod_content?.replace(/<[^>]+>/g, '') || 'æš‚æ— å†…å®¹';
        document.getElementById('set-start').value = settings.start;
        document.getElementById('set-end').value = settings.end;
        document.getElementById('set-auto').checked = settings.auto;
        renderApiTabs(); renderRange();
        const his = history[currentVod.vod_name];
        if(his) {
            const t = currentVod.eps.find(e => e.n === his.ep);
            if(t) play(t.u, t.n, null, his.time);
        } else if(currentVod.eps[0]) play(currentVod.eps[0].u, currentVod.eps[0].n);
    }

    function play(url, epName, el, startTime = 0) {
        if(el) { document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active')); el.classList.add('active'); }
        if(player) player.dispose();
        document.getElementById('v-wrapper').innerHTML = `<video id="v-core" class="video-js vjs-16-9" controls></video>`;
        player = videojs('v-core', { autoplay: true });
        player.src({ src: url, type: 'application/x-mpegURL' });
        player.ready(() => {
            if(startTime > 0) player.currentTime(startTime);
            else if(settings.start > 0) player.currentTime(settings.start);
            setInterval(() => {
                if(!player || player.isDisposed()) return;
                const vid = document.querySelector('video');
                if(vid) document.getElementById('v-details').innerText = `${vid.videoWidth}x${vid.videoHeight} | ç¼“å†²:${(player.bufferedEnd()-player.currentTime()).toFixed(1)}s`;
            }, 2000);
        });
        player.on('timeupdate', () => {
            const now = player.currentTime();
            history[currentVod.vod_name] = { name: currentVod.vod_name, id: currentVod.vod_id, pic: currentVod.vod_pic, apiUrl: currentApi, ep: epName, time: now, date: Date.now() };
            localStorage.setItem('joe_v21_his', JSON.stringify(history));
            if(settings.auto && settings.end > 0 && (player.duration() - now < settings.end)) playNext();
        });
        player.on('ended', () => { if(settings.auto) playNext(); });
    }

    function handleSearchInput() {
        const val = document.getElementById('kw').value.trim();
        if (val.startsWith('http')) {
            document.getElementById('api-input').value = val;
            batchAdd();
        } else doGlobalSearch();
    }

    function renderApiTabs() { document.getElementById('api-tabs').innerHTML = apiList.map(api => `<div class="tab-item ${api.url===currentApi?'active':''}" onclick="switchSource('${api.url}')">${api.name}</div>`).join(''); }
    async function switchSource(url) {
        const base = url + (url.includes('?') ? '&' : '?');
        const d = await smartFetch(`${base}ac=detail&wd=${encodeURIComponent(currentVod.vod_name)}`);
        if(d && d.list.length) reqDetail(url, d.list[0].vod_id);
        else alert("è¯¥æºæ— åŒ¹é…èµ„æº");
    }
    function renderRange() {
        const bar = document.getElementById('range-tabs'); bar.innerHTML = "";
        for(let i=0; i<currentVod.eps.length; i+=50) {
            const btn = document.createElement('div'); btn.className = 'tab-item'; btn.innerText = `${i+1}-${Math.min(i+50, currentVod.eps.length)}`;
            btn.onclick = () => { document.querySelectorAll('#range-tabs .tab-item').forEach(b => b.classList.remove('active')); btn.classList.add('active'); renderEpGrid(currentVod.eps.slice(i, i+50)); };
            bar.appendChild(btn);
        }
        if(bar.firstChild) bar.firstChild.click();
    }
    function renderEpGrid(slice) { document.getElementById('ep-grid').innerHTML = slice.map(e => `<div class="ep-btn ${history[currentVod.vod_name]?.ep === e.n?'active':''}" onclick="play('${e.u}','${e.n}',this)">${e.n}</div>`).join(''); }
    function playNext() { const n = document.querySelector('.ep-btn.active')?.nextElementSibling; if(n) n.click(); }
    function saveSettings() { settings = { start: parseInt(document.getElementById('set-start').value)||0, end: parseInt(document.getElementById('set-end').value)||0, auto: document.getElementById('set-auto').checked }; localStorage.setItem('joe_v21_set', JSON.stringify(settings)); }
    function toggleModal(s) { document.getElementById('mgr-modal').style.display = s?'flex':'none'; if(s) renderMgr(); }
    function renderMgr() { document.getElementById('api-mgr-list').innerHTML = apiList.map((a, i) => `<div style="padding:8px; display:flex; justify-content:space-between; border-bottom:1px solid #eee;"><span>${a.name}</span><span style="color:red; cursor:pointer;" onclick="apiList.splice(${i},1);renderMgr();localStorage.setItem('joe_v21_apis',JSON.stringify(apiList))">ç§»é™¤</span></div>`).join(''); }
    function closePlayer() { if(player) player.pause(); document.getElementById('player-page').style.display='none'; route(currentT || 'home'); }
    function renderHistory() {
        const hSec = document.getElementById('history-section'), hRow = document.getElementById('history-row');
        const hList = Object.values(history).sort((a,b) => b.date - a.date).slice(0, 10);
        if(hList.length > 0) {
            hSec.style.display = 'block';
            hRow.innerHTML = hList.map(h => `<div class="history-item" onclick="reqDetail('${h.apiUrl}','${h.id}')"><img src="${h.pic}"><div class="h-title">${h.name}</div><div style="font-size:10px; color:var(--main); padding:5px 8px;">çœ‹åˆ°: ${h.ep}</div></div>`).join('');
        } else hSec.style.display = 'none';
    }
    function clearHistory() { if(confirm('æ¸…ç©ºï¼Ÿ')) { history = {}; localStorage.setItem('joe_v21_his', '{}'); renderHistory(); } }
    async function route(id, el) {
        if(el) { document.querySelectorAll('.nav div').forEach(d => d.classList.remove('active')); el.classList.add('active'); }
        currentT = id === 'home' ? '' : id;
        renderHistory();
        const view = document.getElementById('main-view');
        view.innerHTML = `<div style="text-align:center; padding:50px;">æ­£åœ¨åŠ è½½é¦–é€‰æºæ¨è...</div>`;
        if(!apiList.length) return;
        const d = await smartFetch(`${apiList[0].url}${apiList[0].url.includes('?')?'&':'?'}ac=detail&t=${currentT}`);
        if(d) {
            view.innerHTML = `<div class="section-h">${id==='home'?'ğŸ”¥ ä»Šæ—¥æ¨è':'ğŸ¬ ç»“æœåˆ—è¡¨'}</div><div class="grid">${d.list.map(v => `<div class="card" onclick="reqDetail('${apiList[0].url}','${v.vod_id}')"><img src="${v.vod_pic || 'https://via.placeholder.com/150x220'}">${history[v.vod_name]?'<div class="his-tag">ç»­çœ‹</div>':''}<div class="info">${v.vod_name}</div></div>`).join('')}</div>`;
        }
    }
    function exportAllConfig() { document.getElementById('api-input').value = btoa(encodeURIComponent(JSON.stringify({apis:apiList,his:history,set:settings}))); alert("é…ç½®ç å·²ç”Ÿæˆ"); }
    function importAllConfig() { try { const c = JSON.parse(decodeURIComponent(atob(document.getElementById('api-input').value.trim()))); apiList=c.apis; history=c.his||{}; settings=c.set||settings; localStorage.setItem('joe_v21_apis',JSON.stringify(apiList)); location.reload(); } catch(e){alert("é”™è¯¯");} }
    window.onload = () => route('home');
</script>
</body>
</html>
