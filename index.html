<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE TV V20 | æ™ºèƒ½è·³è¿‡ç‰‡å¤´ç‰‡å°¾</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #6c5ce7; --bg: #f4f7f6; --text: #2d3436; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "PingFang SC", sans-serif; overflow-x: hidden; }
        
        /* å¯¼èˆªä¸æœç´¢ */
        header { position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); display: flex; align-items: center; padding: 10px 30px; z-index: 1000; border-bottom: 1px solid #e0e0e0; box-shadow: 0 4px 15px rgba(0,0,0,0.03); }
        .logo { font-size: 22px; font-weight: 900; color: var(--main); margin-right: 30px; cursor: pointer; white-space: nowrap; text-shadow: 2px 2px 0px rgba(108,92,231,0.1); }
        
        .nav { display: flex; gap: 8px; flex: 1; overflow-x: auto; scrollbar-width: none; }
        .nav::-webkit-scrollbar { display: none; }
        .nav div { padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 13px; background: #f1f5f9; font-weight: bold; white-space: nowrap; transition: 0.2s; color: #64748b; }
        .nav div:hover { background: #e2e8f0; color: #334155; }
        .nav .active { background: var(--main); color: white; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }
        
        .search-box { position: relative; margin-left: 20px; }
        .search-box input { width: 220px; padding: 9px 18px; border-radius: 20px; border: 1px solid #ddd; outline: none; background: #f8fafc; font-size: 13px; transition: 0.3s; }
        .search-box input:focus { width: 280px; border-color: var(--main); background: #fff; box-shadow: 0 0 0 3px rgba(108, 92, 231, 0.1); }

        /* å†…å®¹åŒº */
        .container { max-width: 1650px; margin: 25px auto; padding: 0 20px; }
        .row-title { font-size: 18px; font-weight: 800; margin: 30px 0 15px; border-left: 5px solid var(--main); padding-left: 12px; display: flex; justify-content: space-between; align-items: center; color: #1e293b; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(165px, 1fr)); gap: 20px; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: #fff; border-radius: 14px; overflow: hidden; cursor: pointer; transition: all 0.3s ease; border: 1px solid #f1f5f9; position: relative; }
        .card:hover { transform: translateY(-6px); box-shadow: 0 15px 35px rgba(0,0,0,0.1); border-color: var(--main); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .info { padding: 12px 10px; text-align: center; font-size: 13px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; color: #334155; }
        .card .tag { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.65); color: #fff; font-size: 10px; padding: 3px 8px; border-radius: 6px; backdrop-filter: blur(4px); font-weight: 600; }

        /* æ’­æ”¾è®°å½• */
        .history-row { display: flex; gap: 15px; overflow-x: auto; padding: 5px 0 15px; scroll-behavior: smooth; }
        .hist-card { flex: 0 0 210px; background: #fff; padding: 12px; border-radius: 12px; cursor: pointer; border: 1px solid #e2e8f0; transition: 0.2s; position: relative; }
        .hist-card:hover { border-color: var(--main); box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        
        /* æ’­æ”¾å™¨å…¨å±å±‚ */
        #player-page { position: fixed; inset: 0; background: #f1f5f9; z-index: 2000; display: none; overflow-y: auto; }
        .p-layout { display: grid; grid-template-columns: 1fr 400px; gap: 25px; max-width: 1700px; margin: 0 auto; padding: 25px; height: 95vh; box-sizing: border-box; }
        .p-left { display: flex; flex-direction: column; gap: 20px; }
        .v-box { background: #000; border-radius: 16px; overflow: hidden; position: relative; box-shadow: 0 25px 60px rgba(0,0,0,0.3); aspect-ratio: 16/9; flex-shrink: 0; }
        
        /* æ’­æ”¾å™¨å·¦ä¸Šè§’è¯¦æƒ… */
        #v-status { position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(0,0,0,0.6); color: #fff; padding: 6px 14px; border-radius: 30px; font-size: 12px; backdrop-filter: blur(8px); border: 1px solid rgba(255,255,255,0.15); pointer-events: none; display: flex; align-items: center; gap: 8px; }
        #v-status span { width: 6px; height: 6px; background: #2ecc71; border-radius: 50%; display: inline-block; box-shadow: 0 0 8px #2ecc71; }
        
        /* ä¾§è¾¹æ ï¼šçº¿è·¯ä¸é€‰é›† */
        .side-panel { background: #fff; border-radius: 16px; display: flex; flex-direction: column; border: 1px solid #e2e8f0; overflow: hidden; height: 100%; box-shadow: 0 10px 30px rgba(0,0,0,0.03); }
        
        .line-bar { padding: 15px; background: #fff; border-bottom: 1px dashed #e2e8f0; display: flex; gap: 10px; overflow-x: auto; flex-shrink: 0; }
        .line-btn { padding: 6px 14px; background: #ecfdf5; color: #059669; border: 1px solid #d1fae5; border-radius: 8px; font-size: 12px; cursor: pointer; white-space: nowrap; font-weight: 700; transition: 0.2s; }
        .line-btn.active { background: #059669; color: #fff; border-color: #059669; box-shadow: 0 2px 5px rgba(5, 150, 105, 0.3); }

        .range-bar { padding: 12px; display: flex; gap: 8px; overflow-x: auto; background: #f8fafc; border-bottom: 1px solid #e2e8f0; flex-shrink: 0; }
        .range-btn { padding: 6px 12px; background: #fff; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 11px; cursor: pointer; white-space: nowrap; transition: 0.2s; }
        .range-btn.active { background: var(--main); color: #fff; border-color: var(--main); }
        
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; overflow-y: auto; flex: 1; align-content: start; }
        .ep-item { background: #f1f5f9; padding: 12px 0; text-align: center; border-radius: 10px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; color: #475569; }
        .ep-item:hover { background: #e2e8f0; color: #000; }
        .ep-item.active { background: var(--main); color: #fff; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.3); }

        /* è®¾ç½®åŒº (é‡ç‚¹ä¼˜åŒ–) */
        .v-controls { background: #fff; padding: 25px; border-radius: 16px; border: 1px solid #e2e8f0; flex-grow: 1; display: flex; flex-direction: column; }
        .setting-box { background: #f8fafc; border-radius: 12px; padding: 15px; margin-top: 15px; border: 1px solid #e2e8f0; }
        .set-row { display: flex; gap: 20px; align-items: center; font-size: 13px; color: #475569; font-weight: 600; flex-wrap: wrap; }
        .set-input { width: 50px; padding: 5px; border: 1px solid #cbd5e1; border-radius: 6px; text-align: center; font-weight: bold; color: var(--main); outline: none; }
        .set-input:focus { border-color: var(--main); }
        
        .mgr-btn { background: #fffbeb !important; color: #b45309 !important; border: 1px solid #fde68a !important; }
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 5000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE TV</div>
    <div class="nav" id="main-nav">
        <div class="active" onclick="route('home', this)">ğŸ  é¦–é¡µ</div>
        <div onclick="route('1', this)">ğŸ¬ çƒ­é—¨ç”µå½±</div>
        <div onclick="route('2', this)">ğŸ“º åŒæ­¥å‰§é›†</div>
        <div onclick="route('3', this)">ğŸ‹ åŠ¨æ¼«ç•ªå‰§</div>
        <div onclick="route('short', this)">ğŸ“± çƒ­é—¨çŸ­å‰§</div>
        <div class="mgr-btn" onclick="toggleModal(true)">âš™ï¸ çº¿è·¯æº</div>
    </div>
    <div class="search-box">
        <input type="text" id="kw" placeholder="æœå½±ç‰‡ / çŸ­å‰§..." onkeydown="if(event.keyCode==13) search()">
    </div>
</header>

<div class="container" id="main-view"></div>

<div id="player-page">
    <div style="padding: 0 25px 15px; font-weight: 800; color: var(--main); cursor: pointer; display: flex; align-items: center; gap: 5px;" onclick="closePlayer()">
        <span>ğŸ”™</span> è¿”å›åˆ—è¡¨
    </div>
    <div class="p-layout">
        <div class="p-left">
            <div class="v-box">
                <div id="v-status"><span></span> åˆå§‹åŒ–...</div>
                <video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto"></video>
            </div>
            <div class="v-controls">
                <h2 id="v-name" style="margin:0; letter-spacing: -0.5px; font-size: 22px;"></h2>
                
                <div class="setting-box">
                    <div style="margin-bottom:10px; font-size:12px; color:#94a3b8; font-weight:bold; text-transform:uppercase;">æ’­æ”¾è®¾ç½® (è‡ªåŠ¨è®°å¿†)</div>
                    <div class="set-row">
                        <span>ğŸš€ è·³è¿‡ç‰‡å¤´: <input type="number" id="sk-start" value="0" class="set-input" onchange="saveConf()"> ç§’</span>
                        <span>ğŸ è·³è¿‡ç‰‡å°¾: <input type="number" id="sk-end" value="0" class="set-input" onchange="saveConf()"> ç§’</span>
                        <label style="cursor:pointer; display:flex; align-items:center; gap:5px; margin-left:auto;">
                            <input type="checkbox" id="at-next" checked onchange="saveConf()" style="accent-color:var(--main); transform:scale(1.2);"> 
                            è‡ªåŠ¨è¿æ’­
                        </label>
                    </div>
                </div>
                
                <p id="v-desc" style="font-size:14px; color:#64748b; margin-top:20px; line-height:1.7; max-height:120px; overflow-y:auto;"></p>
            </div>
        </div>
        
        <div class="side-panel">
            <div style="padding:15px; font-weight:800; font-size:14px; color:#334155; border-bottom:1px solid #f1f5f9; background:#fff;">ğŸ“¡ çº¿è·¯åˆ‡æ¢</div>
            <div id="line-bar" class="line-bar"></div>
            <div id="r-bar" class="range-bar"></div>
            <div id="e-grid" class="ep-grid"></div>
        </div>
    </div>
</div>

<div id="mgr-modal" class="modal">
    <div style="background:#fff; width:500px; padding:30px; border-radius:20px; box-shadow:0 25px 60px rgba(0,0,0,0.3);">
        <h3 style="margin:0 0 20px 0; color:#1e293b;">é…ç½®é‡‡é›†æº API</h3>
        <div id="api-list" style="max-height:180px; overflow-y:auto; margin-bottom:20px; border:1px solid #e2e8f0; border-radius:12px; background:#f8fafc;"></div>
        <textarea id="api-in" style="width:100%; height:80px; padding:12px; border-radius:12px; border:1px solid #cbd5e1; box-sizing:border-box; font-family:monospace; font-size:13px;" placeholder="ç²˜è´´ Maccms JSON API åœ°å€ (ä¾‹å¦‚: https://example.com/api.php/provide/vod/)"></textarea>
        <div style="display:flex; gap:10px; margin-top:20px;">
            <button onclick="importApis()" style="flex:1; padding:12px; background:var(--main); color:#fff; border:none; border-radius:10px; font-weight:bold; cursor:pointer; transition:0.2s;">ä¿å­˜å¹¶è¿æ¥</button>
            <button onclick="toggleModal(false)" style="flex:1; background:#f1f5f9; border:none; color:#64748b; border-radius:10px; cursor:pointer; font-weight:bold;">å–æ¶ˆ</button>
        </div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('v-core');
    let apis = JSON.parse(localStorage.getItem('joe_v20_apis') || '[]');
    // é»˜è®¤é…ç½®ï¼šè·³è¿‡ç‰‡å¤´0ç§’ï¼Œè·³è¿‡ç‰‡å°¾0ç§’ï¼Œè‡ªåŠ¨è¿æ’­å¼€å¯
    let config = JSON.parse(localStorage.getItem('joe_v20_conf') || '{"skipStart":0,"skipEnd":0,"auto":true}');
    let history = JSON.parse(localStorage.getItem('joe_v20_hist') || '[]');
    
    let currentVod = null; 
    let currentLines = []; 
    let activeLineIdx = 0;
    let isSwitchingEp = false; // é˜²æ­¢ç‰‡å°¾é‡å¤è§¦å‘

    // --- è·¯ç”±ç³»ç»Ÿ ---
    async function route(id, el) {
        if(el) {
            document.querySelectorAll('.nav div').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }
        const view = document.getElementById('main-view');
        
        if(id === 'home') {
            view.innerHTML = `
                <div class="row-title">ğŸ•’ æ’­æ”¾è®°å½• <span style="font-size:12px; color:#94a3b8; font-weight:normal; cursor:pointer; margin-left:auto; border:1px solid #e2e8f0; padding:2px 8px; border-radius:10px;" onclick="clearHist()">æ¸…ç©ºè®°å½•</span></div>
                <div class="history-row" id="h-row"></div>
                <div class="row-title">ğŸ†• æœ€æ–°å…¥åº“</div><div class="grid" id="g-new"></div>
                <div class="row-title">ğŸ”¥ çƒ­é—¨çŸ­å‰§</div><div class="grid" id="g-short"></div>
            `;
            renderHistory();
            fetchList('g-new', '', 12);
            fetchList('g-short', 'çŸ­å‰§', 12);
        } else {
            view.innerHTML = `<div class="row-title">æ­£åœ¨è·å–èµ„æº...</div><div class="grid" id="g-cat"></div>`;
            fetchList('g-cat', id === 'short' ? 'çŸ­å‰§' : id, 40);
        }
    }

    async function fetchList(gid, param, num) {
        if(!apis.length) { document.getElementById('main-view').innerHTML = "<div style='padding:50px;text-align:center;'>è¯·å…ˆç‚¹å‡»å³ä¸Šè§’â€œçº¿è·¯æºâ€æ·»åŠ æ¥å£</div>"; return; }
        const isId = !isNaN(param) && param !== '';
        const url = `${apis[0].url}?ac=detail&${isId ? 't='+param : 'wd='+param}`;
        try {
            const res = await fetch(url).then(r => r.json());
            renderGrid(gid, res.list.slice(0, num));
        } catch(e) { console.error(e); }
    }

    function renderGrid(gid, list) {
        const g = document.getElementById(gid);
        if(!g || !list) return;
        if(gid === 'g-cat') document.querySelector('.row-title').innerText = "èµ„æºåˆ—è¡¨";
        g.innerHTML = list.map(v => `
            <div class="card" onclick="reqDetail('${v.vod_id}')">
                <div class="tag">${v.vod_remarks || 'é«˜æ¸…'}</div>
                <img src="${v.vod_pic}">
                <div class="info">${v.vod_name}</div>
            </div>
        `).join('');
    }

    async function search() {
        const kw = document.getElementById('kw').value;
        if(!kw) return;
        const view = document.getElementById('main-view');
        view.innerHTML = `<div class="row-title">ğŸ” "${kw}" å…¨ç½‘æœç´¢ç»“æœ</div><div class="grid" id="g-search"></div>`;
        apis.forEach(api => {
            fetch(`${api.url}?ac=detail&wd=${encodeURIComponent(kw)}`)
                .then(r => r.json())
                .then(res => {
                    const g = document.getElementById('g-search');
                    if(g) g.innerHTML += res.list.map(v => `
                        <div class="card" onclick="reqDetail('${v.vod_id}')">
                            <div class="tag">${api.name}</div>
                            <img src="${v.vod_pic}">
                            <div class="info">${v.vod_name}</div>
                        </div>`).join('');
                });
        });
    }

    // --- æ’­æ”¾æ ¸å¿ƒ (æ™ºèƒ½è·³è¿‡å‡çº§ç‰ˆ) ---
    async function reqDetail(id, resumeUrl=null, resumeTime=0) {
        const res = await fetch(`${apis[0].url}?ac=detail&ids=${id}`).then(r => r.json());
        currentVod = res.list[0];
        
        // è§£æçº¿è·¯
        const froms = currentVod.vod_play_from.split('$$$');
        const urls = currentVod.vod_play_url.split('$$$');
        currentLines = froms.map((name, index) => ({
            name: name,
            eps: urls[index].split('#').filter(s => s.includes('$'))
        }));
        
        activeLineIdx = 0;
        if(resumeUrl) {
            const foundIdx = currentLines.findIndex(l => l.eps.some(e => e.includes(resumeUrl)));
            if(foundIdx !== -1) activeLineIdx = foundIdx;
        }

        openPlayerUI(resumeUrl, resumeTime);
    }

    function openPlayerUI(resumeUrl, resumeTime) {
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-name').innerText = currentVod.vod_name;
        document.getElementById('v-desc').innerText = currentVod.vod_content.replace(/<[^>]+>/g, '');
        
        // åŠ è½½é…ç½®åˆ°è¾“å…¥æ¡†
        document.getElementById('sk-start').value = config.skipStart;
        document.getElementById('sk-end').value = config.skipEnd;
        document.getElementById('at-next').checked = config.auto;
        
        renderLineButtons();
        renderRanges(resumeUrl, resumeTime);
    }

    function renderLineButtons() {
        const bar = document.getElementById('line-bar');
        bar.innerHTML = currentLines.map((line, idx) => `
            <div class="line-btn ${idx === activeLineIdx ? 'active' : ''}" 
                 onclick="switchLine(${idx})">${line.name}</div>
        `).join('');
    }

    function switchLine(idx) {
        activeLineIdx = idx;
        renderLineButtons();
        renderRanges();
    }

    function renderRanges(resumeUrl, resumeTime) {
        const bar = document.getElementById('r-bar');
        bar.innerHTML = "";
        const currentEps = currentLines[activeLineIdx].eps;
        const size = 50;

        for(let i=0; i < currentEps.length; i += size) {
            const end = Math.min(i + size, currentEps.length);
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = `${i+1}-${end}`;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEps(i, end, resumeUrl, resumeTime);
            };
            bar.appendChild(btn);
        }
        const initialPage = resumeUrl ? Math.floor(currentEps.findIndex(e => e.includes(resumeUrl)) / 50) : 0;
        if(bar.children.length > 0) bar.children[initialPage >= 0 ? initialPage : 0].click();
    }

    function renderEps(start, end, resumeUrl, resumeTime) {
        const grid = document.getElementById('e-grid');
        grid.innerHTML = "";
        const currentEps = currentLines[activeLineIdx].eps;
        
        currentEps.slice(start, end).forEach(item => {
            const [name, url] = item.split('$');
            const d = document.createElement('div');
            d.className = 'ep-item' + (resumeUrl === url ? ' active' : '');
            d.innerText = name.includes('ç¬¬') ? name : `ç¬¬${name}é›†`;
            d.onclick = () => {
                document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
                d.classList.add('active');
                play(url, name, resumeTime);
                resumeTime = 0;
            };
            grid.appendChild(d);
            if(resumeUrl === url) d.scrollIntoView({block: 'center'});
        });
        if(resumeUrl && grid.querySelector('.active')) grid.querySelector('.active').click();
    }

    function play(url, name, time) {
        isSwitchingEp = false;
        const lineName = currentLines[activeLineIdx].name;
        document.getElementById('v-status').innerHTML = `<span></span> çº¿è·¯: ${lineName} &nbsp;|&nbsp; æ­£åœ¨æ’­æ”¾: ${name}`;
        
        player.src({ src: url, type: 'application/x-mpegURL' });
        player.play();
        
        // ç‰‡å¤´è·³è¿‡é€»è¾‘
        player.off('loadedmetadata');
        player.one('loadedmetadata', () => {
            if(time > 0) player.currentTime(time);
            else if(config.skipStart > 0) player.currentTime(config.skipStart);
        });

        // æ™ºèƒ½ç›‘æ§ï¼šå†å²è®°å½• + ç‰‡å°¾è·³è¿‡
        player.off('timeupdate');
        player.on('timeupdate', () => {
            const curr = player.currentTime();
            const dur = player.duration();
            
            // è®°å½•è¿›åº¦ (æ¯é›†è¶…è¿‡10ç§’æ‰è®°å½•)
            if(curr > 10) saveHistory(name, url, curr);
            
            // ç‰‡å°¾è·³è¿‡æ ¸å¿ƒé€»è¾‘
            if(config.auto && config.skipEnd > 0 && dur > 0 && !isSwitchingEp) {
                // å¦‚æœå‰©ä½™æ—¶é—´å°äºè®¾å®šå€¼ï¼Œä¸”è§†é¢‘æ€»é•¿åº¦åˆç†(é˜²æ­¢çŸ­è§†é¢‘è¯¯åˆ¤)
                if((dur - curr) < config.skipEnd && dur > (config.skipStart + config.skipEnd + 30)) {
                    isSwitchingEp = true; // é”å®šé˜²æ­¢é‡å¤è§¦å‘
                    triggerNext();
                }
            }
        });
        
        // è‡ªç„¶ç»“æŸè¿æ’­
        player.off('ended');
        player.on('ended', () => { if(config.auto && !isSwitchingEp) triggerNext(); });
    }

    function triggerNext() {
        const next = document.querySelector('.ep-item.active')?.nextSibling;
        if(next) {
            // è¿™é‡Œç»™ä¸ªè½»å¾®çš„Toastæç¤ºä½“éªŒæ›´å¥½ï¼Œä¸è¿‡ä¸ºäº†ç®€æ´ç›´æ¥åˆ‡
            next.click();
        }
    }

    // --- æ•°æ®æŒä¹…åŒ– ---
    function saveHistory(epName, epUrl, time) {
        history = history.filter(h => h.id !== currentVod.vod_id);
        history.unshift({ id: currentVod.vod_id, name: currentVod.vod_name, epName, epUrl, time });
        localStorage.setItem('joe_v20_hist', JSON.stringify(history.slice(0, 20)));
    }
    
    function renderHistory() {
        const row = document.getElementById('h-row');
        if(!history.length) { row.innerHTML = "<div style='color:#cbd5e1; font-size:13px; padding:10px;'>æš‚æ— è§‚çœ‹è®°å½•</div>"; return; }
        row.innerHTML = history.slice(0, 10).map(h => `
            <div class="hist-card" onclick="reqDetail('${h.id}', '${h.epUrl}', ${h.time})">
                <div style="color:#1e293b; font-weight:bold; overflow:hidden; white-space:nowrap; text-overflow:ellipsis; font-size:13px;">${h.name}</div>
                <div style="color:#64748b; font-size:11px; margin-top:6px; display:flex; justify-content:space-between;">
                    <span>${h.epName}</span>
                    <span>${Math.floor(h.time/60)}åˆ†</span>
                </div>
            </div>
        `).join('');
    }
    
    function clearHist() { history=[]; localStorage.removeItem('joe_v20_hist'); renderHistory(); }
    
    function saveConf() {
        config.skipStart = parseInt(document.getElementById('sk-start').value) || 0;
        config.skipEnd = parseInt(document.getElementById('sk-end').value) || 0;
        config.auto = document.getElementById('at-next').checked;
        localStorage.setItem('joe_v20_conf', JSON.stringify(config));
    }
    
    function toggleModal(show) { document.getElementById('mgr-modal').style.display = show ? 'flex' : 'none'; if(show) renderApiList(); }
    async function importApis() {
        const urls = document.getElementById('api-in').value.split('\n').filter(u => u.trim());
        for(let u of urls) {
            try {
                const res = await fetch(u.trim() + "?ac=list").then(r => r.json());
                apis.push({ name: res.source?.name || 'æœªçŸ¥æº', url: u.trim() });
            } catch(e) {}
        }
        localStorage.setItem('joe_v20_apis', JSON.stringify(apis));
        location.reload();
    }
    function renderApiList() { 
        document.getElementById('api-list').innerHTML = apis.map((a, i) => `
            <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid #eee; font-size:12px;">
                <span>âš¡ ${a.name}</span>
                <span onclick="apis.splice(${i},1);localStorage.setItem('joe_v20_apis',JSON.stringify(apis));renderApiList()" style="color:red;cursor:pointer;">åˆ é™¤</span>
            </div>`).join(''); 
    }
    function closePlayer() { player.pause(); document.getElementById('player-page').style.display = 'none'; route('home'); }

    window.onload = () => route('home');
</script>
</body>
</html>
