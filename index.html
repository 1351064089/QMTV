<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>UltraVision X - 聚合影视中台</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #ff5c38; --bg: #0a0a0a; --panel: #161616; --card: #252525; }
        body { margin: 0; background: var(--bg); color: #eee; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }

        /* 左侧：源管理与分类 */
        .sidebar { width: 280px; background: var(--panel); border-right: 1px solid #222; display: flex; flex-direction: column; }
        .sidebar-header { padding: 20px; text-align: center; border-bottom: 1px solid #222; }
        .menu-label { padding: 15px 20px 5px; font-size: 12px; color: #666; text-transform: uppercase; }
        .source-list { flex: 1; overflow-y: auto; padding: 10px; }
        .source-item { 
            padding: 10px 15px; margin-bottom: 5px; border-radius: 6px; background: #222; 
            cursor: pointer; font-size: 14px; display: flex; justify-content: space-between; align-items: center;
        }
        .source-item.active { background: var(--main); }
        .del-btn { color: #ff3333; font-weight: bold; padding: 0 5px; }

        /* 右侧：主界面 */
        .main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        .top-nav { padding: 15px 25px; background: #000; display: flex; gap: 15px; align-items: center; border-bottom: 1px solid #222; }
        .search-bar { flex: 1; display: flex; background: #222; border-radius: 20px; padding: 5px 15px; border: 1px solid #333; }
        .search-bar input { background: transparent; border: none; color: white; flex: 1; padding: 5px; outline: none; }
        
        /* 内容区 */
        .content-area { flex: 1; overflow-y: auto; padding: 20px; }
        .filter-tags { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .tag { padding: 5px 15px; border-radius: 15px; background: #222; font-size: 13px; cursor: pointer; }
        .tag.active { background: var(--main); }

        /* 海报墙 */
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 20px; }
        .card { background: var(--card); border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.3s; position: relative; }
        .card:hover { transform: scale(1.03); box-shadow: 0 10px 20px rgba(0,0,0,0.5); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: #333; }
        .card .title { padding: 8px; font-size: 13px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card .from { position: absolute; top: 5px; left: 5px; background: rgba(0,0,0,0.6); font-size: 10px; padding: 2px 5px; border-radius: 3px; color: var(--main); }

        /* 播放层 */
        #player-modal { position: fixed; inset: 0; background: #000; z-index: 2000; display: none; grid-template-columns: 1fr 320px; }
        .list-side { background: #111; padding: 20px; overflow-y: auto; border-left: 1px solid #222; }
        .ep-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; }
        .ep-btn { background: #222; border: 1px solid #333; color: #ccc; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .ep-btn.active { background: var(--main); color: white; border-color: var(--main); }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="sidebar-header">
        <h2 style="color:var(--main); margin:0">UltraVision X</h2>
    </div>
    
    <div class="menu-label">管理订阅地址</div>
    <div style="padding: 0 20px 15px;">
        <input type="text" id="in-name" placeholder="名称" style="width:100%; margin-bottom:5px; background: #222; border: 1px solid #333; color:white; padding:5px;">
        <input type="text" id="in-url" placeholder="JSON 接口地址" style="width:100%; margin-bottom:5px; background: #222; border: 1px solid #333; color:white; padding:5px;">
        <button onclick="addSource()" style="width:100%; background:var(--main); border:none; color:white; padding:8px; border-radius:4px; cursor:pointer;">添加新源</button>
    </div>

    <div class="menu-label">当前可用源 (自动测速)</div>
    <div class="source-list" id="source-list"></div>
</aside>

<main class="main">
    <div class="top-nav">
        <div class="search-bar">
            <input type="text" id="search-input" placeholder="输入关键词，聚合全网订阅源搜索...">
            <button onclick="aggregateSearch()" style="background:none; border:none; color:var(--main); font-weight:bold; cursor:pointer;">搜索</button>
        </div>
    </div>

    <div class="content-area">
        <div class="filter-tags" id="category-tags">
            <div class="tag active">全部</div>
            <div class="tag">电影</div>
            <div class="tag">电视剧</div>
            <div class="tag">综艺</div>
            <div class="tag">动漫</div>
        </div>
        <div class="grid" id="main-grid">
            <div style="grid-column: 1/-1; text-align: center; padding: 100px; color: #666;">
                请在左侧添加订阅地址，或直接在上方搜索影片
            </div>
        </div>
    </div>
</main>

<div id="player-modal">
    <div style="display:flex; flex-direction:column; position:relative;">
        <div onclick="closePlayer()" style="position:absolute; top:15px; left:15px; z-index:10; cursor:pointer; background:rgba(0,0,0,0.5); padding:5px 15px; border-radius:20px;">✕ 关闭</div>
        <div id="video-container" style="flex:1; background:#000;">
            <video id="main-v" class="video-js vjs-big-play-centered" controls preload="auto" style="width:100%; height:100%;"></video>
        </div>
        <div style="padding:20px; background:var(--panel);">
            <h2 id="v-title" style="margin:0"></h2>
            <p id="v-desc" style="font-size:14px; color:#888; margin-top:10px;"></p>
        </div>
    </div>
    <div class="list-side">
        <h3>选集播放</h3>
        <div class="ep-grid" id="ep-list"></div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('main-v');
    let db = JSON.parse(localStorage.getItem('uv_db') || '[]');

    // 初始化：渲染侧边栏
    function renderSidebar() {
        const container = document.getElementById('source-list');
        container.innerHTML = '';
        db.forEach((src, i) => {
            const div = document.createElement('div');
            div.className = 'source-item';
            div.innerHTML = `<span>${src.name}</span> <span class="del-btn" onclick="removeSource(${i})">×</span>`;
            div.onclick = (e) => { if(!e.target.classList.contains('del-btn')) loadSingleSource(src.url); };
            container.appendChild(div);
        });
    }

    function addSource() {
        const name = document.getElementById('in-name').value;
        const url = document.getElementById('in-url').value;
        if(name && url) {
            db.push({ name, url });
            localStorage.setItem('uv_db', JSON.stringify(db));
            renderSidebar();
        }
    }

    function removeSource(i) {
        db.splice(i, 1);
        localStorage.setItem('uv_db', JSON.stringify(db));
        renderSidebar();
    }

    // 核心功能：聚合搜索
    async function aggregateSearch() {
        const keyword = document.getElementById('search-input').value.trim();
        if(!keyword) return;
        
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">正在聚合搜索全网资源...</div>';

        // 并发请求所有源
        const searchPromises = db.map(src => 
            fetch(`${src.url}?ac=detail&wd=${encodeURIComponent(keyword)}`)
            .then(res => res.json())
            .catch(() => ({ list: [] }))
        );

        const results = await Promise.all(searchPromises);
        grid.innerHTML = '';
        
        results.forEach((data, idx) => {
            if(data.list) {
                renderCards(data.list, db[idx].name);
            }
        });
    }

    // 渲染海报卡片
    function renderCards(list, sourceName) {
        const grid = document.getElementById('main-grid');
        list.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            // 修复图片显示的关键：referrerPolicy
            card.innerHTML = `
                <div class="from">${sourceName}</div>
                <img src="${item.vod_pic}" referrerpolicy="no-referrer" onerror="this.src='https://via.placeholder.com/200x300?text=暂无封面'">
                <div class="title">${item.vod_name}</div>
            `;
            card.onclick = () => openPlayer(item);
            grid.appendChild(card);
        });
    }

    // 播放逻辑
    function openPlayer(video) {
        document.getElementById('player-modal').style.display = 'grid';
        document.getElementById('v-title').innerText = video.vod_name;
        document.getElementById('v-desc').innerText = video.vod_content.replace(/<[^>]+>/g, '');

        const epList = document.getElementById('ep-list');
        epList.innerHTML = '';
        
        // 解析播放地址
        const groups = video.vod_play_url.split('$$$'); // 处理多线路
        const mainLine = groups[0].split('#');
        
        mainLine.forEach((line, i) => {
            const [name, url] = line.split('$');
            const btn = document.createElement('button');
            btn.className = 'ep-btn';
            btn.innerText = name || `第${i+1}集`;
            btn.onclick = () => {
                document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                player.src({ src: url, type: 'application/x-mpegURL' });
                player.play();
            };
            epList.appendChild(btn);
            if(i === 0) btn.click();
        });
    }

    function closePlayer() {
        player.pause();
        document.getElementById('player-modal').style.display = 'none';
    }

    async function loadSingleSource(url) {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">正在刷新资源...</div>';
        try {
            const res = await fetch(url + "?ac=detail");
            const data = await res.json();
            grid.innerHTML = '';
            renderCards(data.list, "当前源");
        } catch(e) {}
    }

    renderSidebar();
</script>
</body>
</html>
