<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE TV V21.7 | è‹¹æœCMS å¼ºåˆ¶å¯¼å…¥ä¿®å¤ç‰ˆ</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #6c5ce7; --bg: #f4f7f6; --text: #2d3436; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; }
        header { position: sticky; top: 0; background: #fff; display: flex; align-items: center; padding: 10px 20px; z-index: 1000; border-bottom: 1px solid #ddd; }
        .logo { font-size: 20px; font-weight: bold; color: var(--main); margin-right: 20px; cursor: pointer; }
        .nav { display: flex; gap: 10px; flex: 1; }
        .nav div { padding: 6px 12px; border-radius: 15px; cursor: pointer; font-size: 13px; background: #eee; }
        .nav .active { background: var(--main); color: #fff; }
        
        .container { max-width: 1400px; margin: 20px auto; padding: 0 15px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 15px; }
        .card { background: #fff; border-radius: 8px; overflow: hidden; cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .card img { width: 100%; aspect-ratio: 3/4; object-fit: cover; }
        .card .info { padding: 8px; text-align: center; font-size: 12px; font-weight: bold; }

        /* ä¾§è¾¹é€‰é›† */
        #player-page { position: fixed; inset: 0; background: #f4f4f4; z-index: 2000; display: none; overflow-y: auto; }
        .p-layout { display: grid; grid-template-columns: 1fr 350px; gap: 20px; padding: 20px; }
        .v-box { background: #000; aspect-ratio: 16/9; border-radius: 12px; overflow: hidden; }
        .side-panel { background: #fff; border-radius: 12px; padding: 10px; }
        .range-bar { display: flex; gap: 5px; overflow-x: auto; padding-bottom: 10px; border-bottom: 1px solid #eee; }
        .range-btn { padding: 4px 10px; background: #eee; border-radius: 4px; font-size: 12px; cursor: pointer; white-space: nowrap; }
        .range-btn.active { background: var(--main); color: #fff; }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-top: 10px; max-height: 500px; overflow-y: auto; }
        .ep-item { background: #f9f9f9; padding: 8px 0; text-align: center; font-size: 11px; border-radius: 4px; cursor: pointer; border: 1px solid #eee; }
        .ep-item.active { background: var(--main); color: #fff; border-color: var(--main); }

        /* å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-content { background: #fff; width: 400px; padding: 20px; border-radius: 12px; }
        textarea { width: 100%; height: 80px; margin: 10px 0; box-sizing: border-box; padding: 8px; }
        .status-msg { font-size: 12px; margin-bottom: 10px; color: #666; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE TV</div>
    <div class="nav">
        <div class="active" onclick="route('home', this)">é¦–é¡µ</div>
        <div onclick="toggleModal(true)" style="background:#fff3e0; color:#e65100;">â• å¯¼å…¥/ç®¡ç†æ¥å£</div>
    </div>
    <div style="margin-left:10px;"><input type="text" id="kw" placeholder="æœç´¢..." onkeydown="if(event.keyCode==13) search()"></div>
</header>

<div class="container" id="main-view"></div>

<div id="player-page">
    <div style="padding:15px; color:var(--main); cursor:pointer; font-weight:bold;" onclick="closePlayer()">ğŸ”™ è¿”å›</div>
    <div class="p-layout">
        <div>
            <div id="v-wrapper" class="v-box"></div>
            <h3 id="v-name"></h3>
            <div id="v-desc" style="font-size:13px; color:#666; line-height:1.6;"></div>
        </div>
        <div class="side-panel">
            <div style="display:flex; justify-content:space-between; margin-bottom:10px;">
                <b>é€‰é›†æ’­æ”¾</b>
                <span onclick="toggleSort()" style="font-size:12px; color:var(--main); cursor:pointer;">æ­£åº/å€’åº</span>
            </div>
            <div class="range-bar" id="range-bar"></div>
            <div class="ep-grid" id="e-grid"></div>
        </div>
    </div>
</div>

<div id="mgr-modal" class="modal">
    <div class="modal-content">
        <h3>ç®¡ç†æ¥å£</h3>
        <div id="status" class="status-msg">å·²å°±ç»ª</div>
        <div id="api-list" style="max-height:150px; overflow-y:auto; border:1px solid #eee; margin-bottom:10px; font-size:12px;"></div>
        <textarea id="api-input" placeholder="è¯·è¾“å…¥è‹¹æœCMSæˆ–èµ„æºç«™APIåœ°å€..."></textarea>
        <button onclick="doImport()" style="width:100%; padding:10px; background:var(--main); color:#fff; border:none; border-radius:5px;">ç«‹å³å¯¼å…¥</button>
        <button onclick="toggleModal(false)" style="width:100%; margin-top:5px; border:none; background:none; color:#999;">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    let apiList = JSON.parse(localStorage.getItem('joe_v21_apis') || '[]');
    let player = null, currentVod = null, isReverse = false;

    // æ ¸å¿ƒæŠ“å–å‡½æ•°ï¼šå¢åŠ å¼ºåŠ›å®¹é”™
    async function smartFetch(url) {
        try {
            const controller = new AbortController();
            const id = setTimeout(() => controller.abort(), 8000);
            const res = await fetch(url, { signal: controller.signal });
            clearTimeout(id);
            const text = await res.text();
            
            if (text.includes('<?xml')) {
                const xml = new DOMParser().parseFromString(text, "text/xml");
                return { name: xml.querySelector('rss')?.getAttribute('name') || 'XMLèµ„æºç«™', list: parseXml(xml) };
            }
            const json = JSON.parse(text);
            return { name: json.source?.name || 'JSONèµ„æºç«™', list: json.list || [] };
        } catch(e) {
            console.error("Fetch error:", e);
            return null; // å³ä½¿æŠ¥é”™ä¹Ÿè¿”å›nullï¼Œè®©åç»­é€»è¾‘æ¥ç®¡
        }
    }

    function parseXml(xml) {
        return Array.from(xml.querySelectorAll('video')).map(v => ({
            vod_id: v.querySelector('id')?.textContent,
            vod_name: v.querySelector('name')?.textContent,
            vod_pic: v.querySelector('pic')?.textContent,
            vod_play_url: v.querySelector('dl dd')?.textContent,
            vod_content: v.querySelector('des')?.textContent
        }));
    }

    // ä¿®å¤åçš„å¯¼å…¥å‡½æ•°
    async function doImport() {
        const input = document.getElementById('api-input').value.trim();
        const status = document.getElementById('status');
        if(!input) return;

        status.innerText = "â³ æ­£åœ¨å°è¯•è¯†åˆ«å¹¶ä¿å­˜...";
        const lines = input.split('\n');
        
        for(let url of lines) {
            url = url.trim();
            if(!url) continue;
            
            // è‹¹æœCMSæ¥å£è‡ªåŠ¨è¡¥å…¨é€»è¾‘ (å¯é€‰)
            if(url.includes('api.php') && !url.includes('ac=detail')) {
                // ä¿æŒåŸæ ·ï¼Œä¸‹é¢è¯·æ±‚æ—¶ä¼šè‡ªåŠ¨æ‹¼å‚æ•°
            }

            // å…³é”®ä¿®å¤ï¼šæ— è®ºæ˜¯å¦è¯·æ±‚æˆåŠŸï¼Œéƒ½å…ˆå­˜å…¥åˆ—è¡¨ï¼Œé˜²æ­¢CORSæ‹¦æˆªå¯¼è‡´ç‚¹å‡»æ²¡ååº”
            const data = await smartFetch(`${url}${url.includes('?')?'&':'?'}ac=list`);
            const name = data ? data.name : "è‡ªå®šä¹‰æ¥å£(æœªè¯†åˆ«åç§°)";
            
            if(!apiList.some(a => a.url === url)) {
                apiList.push({ name: name, url: url });
            }
        }
        
        localStorage.setItem('joe_v21_apis', JSON.stringify(apiList));
        status.innerText = "âœ… å¯¼å…¥æˆåŠŸï¼å³å°†åˆ·æ–°...";
        setTimeout(() => location.reload(), 1000);
    }

    async function route(id, el) {
        const view = document.getElementById('main-view');
        if(!apiList.length) {
            view.innerHTML = "<h3>è¯·å…ˆç‚¹å‡»ä¸Šæ–¹â€œå¯¼å…¥æ¥å£â€æ·»åŠ èµ„æºã€‚</h3>";
            return;
        }
        view.innerHTML = "åŠ è½½ä¸­...";
        fetchData(apiList[0].url, "");
    }

    async function fetchData(url, param) {
        const fullUrl = `${url}${url.includes('?')?'&':'?'}ac=detail&${param}`;
        const data = await smartFetch(fullUrl);
        if(data) {
            const grid = document.getElementById('main-view');
            grid.innerHTML = `<div class="grid">${data.list.map(v => `
                <div class="card" onclick="reqDetail('${url}','${v.vod_id}')">
                    <img src="${v.vod_pic}">
                    <div class="info">${v.vod_name}</div>
                </div>`).join('')}</div>`;
        } else {
            document.getElementById('main-view').innerHTML = "æ¥å£å“åº”å¤±è´¥ï¼Œå¯èƒ½æ˜¯è·¨åŸŸé—®é¢˜æˆ–åœ°å€é”™è¯¯ã€‚";
        }
    }

    async function reqDetail(url, id) {
        const res = await smartFetch(`${url}${url.includes('?')?'&':'?'}ac=detail&ids=${id}`);
        if(!res) return;
        currentVod = res.list[0];
        const rawEps = currentVod.vod_play_url.split('$$$')[0].split('#');
        currentVod.processedEps = rawEps.map(e => {
            const p = e.split('$'); return { n: p[0], u: p[1] };
        });
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-name').innerText = currentVod.vod_name;
        document.getElementById('v-desc').innerText = currentVod.vod_content?.replace(/<[^>]+>/g, '');
        renderRange();
    }

    function renderRange() {
        const eps = isReverse ? [...currentVod.processedEps].reverse() : currentVod.processedEps;
        const bar = document.getElementById('range-bar');
        bar.innerHTML = "";
        for(let i=0; i<eps.length; i+=50) {
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = `${i+1}-${Math.min(i+50, eps.length)}`;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEps(eps.slice(i, i+50));
            };
            bar.appendChild(btn);
        }
        if(bar.firstChild) bar.firstChild.click();
    }

    function renderEps(slice) {
        document.getElementById('e-grid').innerHTML = slice.map(e => `
            <div class="ep-item" onclick="play('${e.u}',this)">${e.n}</div>
        `).join('');
    }

    function play(url, el) {
        document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');
        if(player) player.dispose();
        document.getElementById('v-wrapper').innerHTML = `<video id="v-core" class="video-js vjs-16-9" controls></video>`;
        player = videojs('v-core');
        player.src({ src: url, type: 'application/x-mpegURL' });
        player.play();
    }

    function toggleSort() { isReverse = !isReverse; renderRange(); }
    function toggleModal(show) { 
        document.getElementById('mgr-modal').style.display = show ? 'flex' : 'none'; 
        if(show) {
            document.getElementById('api-list').innerHTML = apiList.map((a, i) => `
                <div style="padding:5px; border-bottom:1px solid #eee; display:flex; justify-content:space-between;">
                    <span>${a.name}</span>
                    <button onclick="apiList.splice(${i},1);localStorage.setItem('joe_v21_apis',JSON.stringify(apiList));location.reload()" style="color:red;border:none;background:none;cursor:pointer;">åˆ é™¤</button>
                </div>
            `).join('');
        }
    }
    function closePlayer() { if(player) player.pause(); document.getElementById('player-page').style.display='none'; }
    window.onload = () => route('home');
</script>
</body>
</html>
