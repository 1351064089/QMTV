<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>DecoTV | æè‡´å½±è§†ä½“éªŒ</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root {
            --bg-color: #f8fafc;
            --card-bg: #ffffff;
            --text-main: #1e293b;
            --accent-movie: #ff6b6b;
            --accent-tv: #a29bfe;
            --accent-anime: #55efc4;
            --accent-variety: #ffe66d;
            --accent-live: #ff9f43;
        }

        body {
            margin: 0;
            background-color: var(--bg-color);
            color: var(--text-main);
            font-family: "PingFang SC", "Microsoft YaHei", sans-serif;
            overflow-x: hidden;
        }

        /* --- é¡¶éƒ¨å¯¼èˆªæ  (è¿˜åŸæˆªå›¾) --- */
        header {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            width: 90%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(10px);
            border-radius: 50px;
            display: flex;
            align-items: center;
            padding: 8px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.05);
            z-index: 1000;
        }

        .logo { font-size: 22px; font-weight: 900; color: #a29bfe; margin-right: 20px; }

        .nav-links { display: flex; gap: 10px; align-items: center; flex: 1; }
        .nav-item {
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 14px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: 0.3s;
            text-decoration: none;
            color: #64748b;
        }
        .nav-item.active { background: #f1f5f9; color: var(--text-main); }
        /* å½©è‰²åˆ†ç±»æ ‡ç­¾ */
        .cat-movie { background: #fff1f1; color: var(--accent-movie); }
        .cat-tv { background: #f3f0ff; color: var(--accent-tv); }
        .cat-anime { background: #e6fffa; color: var(--accent-anime); }
        .cat-variety { background: #fffbe6; color: var(--accent-variety); }
        .cat-live { background: #fff5eb; color: var(--accent-live); }

        .header-right { display: flex; align-items: center; gap: 15px; }

        /* --- ä¸»å†…å®¹åŒº --- */
        main { padding-top: 120px; width: 90%; max-width: 1200px; margin: 0 auto; }

        .hero-section { text-align: center; padding: 60px 0; }
        .hero-section h1 { font-size: 80px; margin: 0; background: linear-gradient(90deg, #a29bfe, #6c5ce7); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }

        /* --- æµ·æŠ¥å¢™æ ·å¼ (è¿˜åŸæˆªå›¾) --- */
        .section-title { font-size: 20px; font-weight: bold; margin: 30px 0 20px; display: flex; justify-content: space-between; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        
        .card { background: var(--card-bg); border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.3s; position: relative; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .badge { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; padding: 2px 6px; border-radius: 4px; font-size: 11px; }
        .card .info { padding: 10px; }
        .card .title { font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card .source { font-size: 11px; color: #94a3b8; margin-top: 4px; display: flex; align-items: center; gap: 4px; }

        /* --- è®¾ç½®ä¸åå°å¼¹çª— (è¿˜åŸæˆªå›¾) --- */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.4); 
            display: none; align-items: center; justify-content: center; z-index: 2000;
        }
        .modal-content {
            background: white; width: 600px; border-radius: 20px; padding: 30px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); position: relative;
        }
        .modal-header { font-size: 18px; font-weight: bold; margin-bottom: 20px; border-bottom: 1px solid #f1f5f9; padding-bottom: 15px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 13px; color: #64748b; margin-bottom: 8px; }
        select, input { width: 100%; padding: 10px; border: 1px solid #e2e8f0; border-radius: 8px; outline: none; }

        /* --- ç®¡ç†å‘˜é¢æ¿åˆ—è¡¨ --- */
        .admin-list-item {
            background: #fff; border: 1px solid #f1f5f9; padding: 15px 20px;
            margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; cursor: pointer;
        }
        .admin-list-item:hover { background: #f8fafc; }

        #player-container { position: fixed; inset: 0; background: #000; z-index: 3000; display: none; }
    </style>
</head>
<body>

<header>
    <div class="logo">DecoTV</div>
    <div class="nav-links">
        <a href="#" class="nav-item active">é¦–é¡µ</a>
        <a href="#" class="nav-item">æœç´¢</a>
        <div class="nav-item cat-movie" onclick="loadDouban('Movie')">ç”µå½±</div>
        <div class="nav-item cat-tv" onclick="loadDouban('TV')">å‰§é›†</div>
        <div class="nav-item cat-anime" onclick="loadDouban('Anime')">åŠ¨æ¼«</div>
        <div class="nav-item cat-variety" onclick="loadDouban('Variety')">ç»¼è‰º</div>
        <div class="nav-item cat-live" onclick="toggleAdmin()">ç®¡ç†é¢æ¿</div>
    </div>
    <div class="header-right">
        <div style="cursor:pointer" onclick="toggleSettings()">âš™ï¸ è®¾ç½®</div>
        <div style="width:32px; height:32px; background:#ddd; border-radius:50%; overflow:hidden">
            <img src="https://api.dicebear.com/7.x/avataaars/svg?seed=admin" width="32">
        </div>
    </div>
</header>

<main>
    <div class="hero-section">
        <h1>DecoTV</h1>
        <p style="color:#94a3b8">å‘ç° Â· æ”¶è— Â· ç»§ç»­è§‚çœ‹</p>
    </div>

    <div class="section-title">
        <span>ç»§ç»­è§‚çœ‹</span>
        <span style="font-size:12px; color:#94a3b8; cursor:pointer" onclick="clearHistory()">æ¸…ç©º</span>
    </div>
    <div class="grid" id="history-grid">
        </div>

    <div class="section-title">
        <span>çƒ­é—¨å†…å®¹</span>
        <span style="font-size:12px; color:#a29bfe; cursor:pointer">æŸ¥çœ‹æ›´å¤š ></span>
    </div>
    <div class="grid" id="main-grid">
        </div>
</main>

<div id="settings-modal" class="modal">
    <div class="modal-content">
        <div class="modal-header">æœ¬åœ°è®¾ç½® <span style="font-size:12px; color:#ff6b6b; margin-left:10px;">æ¢å¤é»˜è®¤</span></div>
        <div class="form-group">
            <label>è±†ç“£æ•°æ®ä»£ç†</label>
            <select id="db-api-proxy">
                <option value="https://api.douban.com">é»˜è®¤ç›´è¿ (å¯èƒ½è¶…æ—¶)</option>
                <option value="https://db-api.cmli.biz">è±†ç“£ CDN By CMLiussss (æ¨è)</option>
            </select>
        </div>
        <div class="form-group">
            <label>è±†ç“£å›¾ç‰‡ä»£ç†</label>
            <select id="db-img-proxy">
                <option value="">åŸå§‹åœ°å€</option>
                <option value="https://images.weserv.nl/?url=">Weserv.nl ä»£ç†</option>
            </select>
        </div>
        <div class="form-group" style="display:flex; justify-content: space-between; align-items: center;">
            <label>é»˜è®¤èšåˆæœç´¢ç»“æœ</label>
            <input type="checkbox" checked style="width:auto">
        </div>
        <div style="text-align:right">
            <button onclick="toggleSettings()" style="background:#f1f5f9; border:none; padding:8px 20px; border-radius:5px; cursor:pointer">å–æ¶ˆ</button>
            <button onclick="saveSettings()" style="background:#a29bfe; color:white; border:none; padding:8px 20px; border-radius:5px; cursor:pointer; margin-left:10px;">ä¿å­˜é…ç½®</button>
        </div>
    </div>
</div>

<div id="admin-modal" class="modal">
    <div class="modal-content" style="width:800px; max-height:80vh; overflow-y:auto;">
        <div class="modal-header">ç®¡ç†å‘˜è®¾ç½® <span style="font-size:12px; color:white; background:red; padding:2px 6px; border-radius:4px; margin-left:10px;">é›†ç¾¤é…ç½®</span></div>
        <div class="admin-list-item"><span>ğŸ“„ é…ç½®æ–‡ä»¶</span> <span>></span></div>
        <div class="admin-list-item"><span>âš™ï¸ ç«™ç‚¹é…ç½®</span> <span>></span></div>
        <div class="admin-list-item" onclick="promptAddSource()"><span>ğŸ“º è§†é¢‘æºé…ç½® (é‡è¦)</span> <span>+</span></div>
        <div class="admin-list-item"><span>ğŸ“¡ ç›´æ’­æºé…ç½®</span> <span>></span></div>
        <div class="admin-list-item"><span>ğŸ“¦ TVBoxé…ç½®</span> <span>></span></div>
        <div class="admin-list-item"><span>ğŸ“ åˆ†ç±»é…ç½®</span> <span>></span></div>
        <div style="text-align:center; margin-top:20px;">
            <button onclick="toggleAdmin()" style="color:#94a3b8; background:none; border:none; cursor:pointer">å…³é—­ç®¡ç†é¢æ¿</button>
        </div>
    </div>
</div>

<div id="player-container">
    <div onclick="closePlayer()" style="position:absolute; top:20px; left:20px; z-index:3001; color:white; cursor:pointer; background:rgba(0,0,0,0.5); padding:10px 20px; border-radius:30px;">é€€å‡ºæ’­æ”¾</div>
    <video id="main-v" class="video-js vjs-big-play-centered" controls style="width:100%; height:100%"></video>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    let sources = JSON.parse(localStorage.getItem('deco_sources') || '[]');
    let history = JSON.parse(localStorage.getItem('deco_history') || '[]');
    const player = videojs('main-v');

    window.onload = () => {
        renderHistory();
        loadDouban('Movie');
    };

    // 1. è±†ç“£æ•°æ®åŠ è½½ (è”åŠ¨è®¾ç½®ä¸­çš„ä»£ç†)
    async function loadDouban(type) {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<p style="text-align:center; color:#94a3b8">æ­£åœ¨ä»è±†ç“£æ‹‰å–æœ€æ–°æ•°æ®...</p>';
        
        // æ¨¡æ‹Ÿä»£ç†è¯·æ±‚ (å®é™…å¯æ›¿æ¢ä¸ºè®¾ç½®ä¸­çš„ä»£ç†åœ°å€)
        try {
            const res = await fetch(`https://api.wmdb.tv/api/v1/top?type=${type}&skip=0&limit=12`);
            const data = await res.json();
            grid.innerHTML = '';
            data.forEach(item => {
                const imgUrl = item.data[0].poster;
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="badge">${item.doubanRating || '7.5'}</div>
                    <img src="${imgUrl}" referrerpolicy="no-referrer">
                    <div class="info">
                        <div class="title">${item.data[0].name}</div>
                        <div class="source">ğŸ’ è±†ç“£çƒ­æ˜ </div>
                    </div>
                `;
                card.onclick = () => searchAndPlay(item.data[0].name);
                grid.appendChild(card);
            });
        } catch (e) {
            grid.innerHTML = '<p style="text-align:center; color:#ff6b6b">è¯·æ±‚å¤±è´¥ï¼Œè¯·åœ¨è®¾ç½®ä¸­åˆ‡æ¢ä»£ç†ã€‚</p>';
        }
    }

    // 2. èšåˆæœç´¢å¹¶è‡ªåŠ¨æ’­æ”¾
    async function searchAndPlay(name) {
        if(sources.length === 0) {
            alert("è¯·å…ˆåœ¨ç®¡ç†å‘˜é¢æ¿ -> è§†é¢‘æºé…ç½®ä¸­æ·»åŠ é‡‡é›†æ¥å£ï¼");
            toggleAdmin();
            return;
        }

        // æŸ¥æ‰¾ç¬¬ä¸€ä¸ªå¯ç”¨è§†é¢‘
        for(let s of sources) {
            try {
                const res = await fetch(`${s.url}?ac=detail&wd=${encodeURIComponent(name)}`).then(r => r.json());
                if(res.list && res.list.length > 0) {
                    const video = res.list[0];
                    playM3U8(video);
                    addToHistory(video);
                    return;
                }
            } catch(e) {}
        }
        alert("æš‚æ— å¯ç”¨æ’­æ”¾æºï¼Œè¯·å°è¯•æ‰‹åŠ¨æœç´¢ã€‚");
    }

    function playM3U8(video) {
        const playUrl = video.vod_play_url.split('$')[1].split('#')[0];
        document.getElementById('player-container').style.display = 'block';
        player.src({ src: playUrl, type: 'application/x-mpegURL' });
        player.play();
    }

    // 3. å†å²è®°å½• (æˆªå›¾1ä¸­çš„â€œç»§ç»­è§‚çœ‹â€)
    function addToHistory(video) {
        history = history.filter(v => v.vod_id !== video.vod_id);
        history.unshift(video);
        if(history.length > 6) history.pop();
        localStorage.setItem('deco_history', JSON.stringify(history));
        renderHistory();
    }

    function renderHistory() {
        const hGrid = document.getElementById('history-grid');
        hGrid.innerHTML = history.length ? '' : '<p style="color:#94a3b8; font-size:13px;">æš‚æ— è§‚çœ‹è®°å½•</p>';
        history.forEach(v => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `
                <div class="badge">å·²çœ‹</div>
                <img src="${v.vod_pic}" referrerpolicy="no-referrer">
                <div class="info">
                    <div class="title">${v.vod_name}</div>
                    <div class="source">â±ï¸ ç»§ç»­è§‚çœ‹</div>
                </div>
            `;
            card.onclick = () => playM3U8(v);
            hGrid.appendChild(card);
        });
    }

    // --- ç•Œé¢äº¤äº’é€»è¾‘ ---
    function toggleSettings() { 
        const m = document.getElementById('settings-modal');
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    }
    function toggleAdmin() { 
        const m = document.getElementById('admin-modal');
        m.style.display = m.style.display === 'flex' ? 'none' : 'flex';
    }
    function promptAddSource() {
        const name = prompt("è¾“å…¥èµ„æºç«™åç§° (å¦‚: èŒ…å°)");
        const url = prompt("è¾“å…¥é‡‡é›†æ¥å£åœ°å€ (JSONæ ¼å¼)");
        if(name && url) {
            sources.push({name, url});
            localStorage.setItem('deco_sources', JSON.stringify(sources));
            alert("æºå·²æ·»åŠ ï¼");
        }
    }
    function closePlayer() { player.pause(); document.getElementById('player-container').style.display = 'none'; }
    function clearHistory() { history = []; localStorage.removeItem('deco_history'); renderHistory(); }
</script>
</body>
</html>
