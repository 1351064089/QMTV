<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer"> <title>UltraVision X | 聚合搜索与豆瓣增强</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #ff5c38; --bg: #0a0a0a; --panel: #161616; --card: #202020; }
        body { margin: 0; background: var(--bg); color: #eee; font-family: sans-serif; display: flex; height: 100vh; overflow: hidden; }
        
        /* 侧边栏：订阅管理 */
        .sidebar { width: 300px; background: var(--panel); border-right: 1px solid #222; display: flex; flex-direction: column; }
        .sidebar-box { padding: 15px; border-bottom: 1px solid #222; }
        .sidebar-box input { width: 100%; background: #222; border: 1px solid #333; color: #fff; padding: 8px; margin-bottom: 5px; box-sizing: border-box; }
        .source-list { flex: 1; overflow-y: auto; padding: 10px; }
        .source-item { background: #222; padding: 10px; margin-bottom: 8px; border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; }
        .source-item:hover { border: 1px solid var(--main); }
        .source-item.active { background: var(--main); }

        /* 主界面 */
        .main { flex: 1; display: flex; flex-direction: column; }
        .search-nav { padding: 15px 30px; background: #000; display: flex; gap: 10px; border-bottom: 1px solid #222; }
        .search-nav input { flex: 1; background: #1a1a1a; border: 1px solid #333; color: white; padding: 10px 20px; border-radius: 25px; outline: none; }
        
        /* 内容区 */
        .content { flex: 1; overflow-y: auto; padding: 25px; }
        .movie-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 25px; }
        .movie-card { background: var(--card); border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.3s; position: relative; }
        .movie-card:hover { transform: translateY(-8px); }
        .movie-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .movie-card .rating { position: absolute; top: 10px; right: 10px; background: rgba(255,92,56,0.9); color: white; padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .movie-card .info { padding: 10px; }
        .movie-card .info .t { font-size: 14px; font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .movie-card .info .s { font-size: 12px; color: #888; margin-top: 4px; }

        /* 播放器全屏层 */
        #play-layer { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; grid-template-columns: 1fr 380px; }
        .video-box { position: relative; background: #000; display: flex; flex-direction: column; }
        .playlist-box { background: #111; padding: 20px; border-left: 1px solid #222; overflow-y: auto; }
        .back-btn { position: absolute; top: 20px; left: 20px; z-index: 10; cursor: pointer; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 20px; }
        
        .tab-menu { display: flex; border-bottom: 1px solid #333; margin-bottom: 15px; }
        .tab-btn { padding: 10px; cursor: pointer; font-size: 14px; color: #888; }
        .tab-btn.active { color: var(--main); border-bottom: 2px solid var(--main); }
        .ep-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; }
        .ep-item { background: #222; border: 1px solid #333; color: #ccc; padding: 8px; text-align: center; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .ep-item.active { background: var(--main); color: white; border-color: var(--main); }
        
        .loading { text-align: center; padding: 50px; color: var(--main); font-weight: bold; }
    </style>
</head>
<body>

<aside class="sidebar">
    <div class="sidebar-header" style="padding:20px; font-size:22px; color:var(--main); font-weight:bold;">UltraVision X</div>
    <div class="sidebar-box">
        <input type="text" id="src-name" placeholder="源名称 (如: 茅台资源)">
        <input type="text" id="src-url" placeholder="JSON 接口地址">
        <button onclick="saveSource()" style="width:100%; background:var(--main); border:none; color:white; padding:8px; border-radius:4px; cursor:pointer;">添加订阅</button>
    </div>
    <div class="source-list" id="source-list"></div>
</aside>

<main class="main">
    <div class="search-nav">
        <input type="text" id="search-kw" placeholder="聚合搜索全网资源，匹配豆瓣详情..." onkeypress="if(event.keyCode==13) aggregateSearch()">
        <button onclick="aggregateSearch()" style="background:var(--main); border:none; color:white; padding:0 25px; border-radius:25px; cursor:pointer;">聚合搜索</button>
    </div>
    <div class="content">
        <div class="movie-grid" id="main-grid">
            </div>
    </div>
</main>

<div id="play-layer">
    <div class="back-btn" onclick="closePlayer()">✕ 退出播放</div>
    <div class="video-box">
        <div style="flex:1; background:#000;">
            <video id="vjs-player" class="video-js vjs-big-play-centered" controls preload="auto" style="width:100%; height:100%;"></video>
        </div>
        <div style="padding:25px; background:var(--panel);">
            <h1 id="v-title" style="margin:0; font-size:26px;"></h1>
            <div id="v-meta" style="color:var(--main); margin:10px 0; font-weight:bold;"></div>
            <p id="v-desc" style="color:#aaa; font-size:14px; line-height:1.6; max-height:100px; overflow-y:auto;"></p>
        </div>
    </div>
    <div class="playlist-box">
        <h3>路线与选集</h3>
        <div class="tab-menu" id="line-tabs"></div>
        <div class="ep-list" id="ep-list"></div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('vjs-player', { fluid: false });
    let sources = JSON.parse(localStorage.getItem('uv_sources') || '[]');

    function saveSource() {
        const name = document.getElementById('src-name').value;
        const url = document.getElementById('src-url').value;
        if(name && url) {
            sources.push({ name, url });
            localStorage.setItem('uv_sources', JSON.stringify(sources));
            renderSources();
        }
    }

    function renderSources() {
        const list = document.getElementById('source-list');
        list.innerHTML = '';
        sources.forEach((s, i) => {
            const div = document.createElement('div');
            div.className = 'source-item';
            div.innerHTML = `<span>${s.name}</span> <span onclick="deleteSource(${i})" style="color:#666">删除</span>`;
            div.onclick = (e) => { if(e.target.innerText!=='删除') loadFromSource(s.url); };
            list.appendChild(div);
        });
    }

    function deleteSource(i) {
        sources.splice(i, 1);
        localStorage.setItem('uv_sources', JSON.stringify(sources));
        renderSources();
    }

    // 核心：聚合搜索并联动豆瓣
    async function aggregateSearch() {
        const kw = document.getElementById('search-kw').value.trim();
        if(!kw) return;
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div class="loading">正在检索全网资源并匹配豆瓣数据...</div>';

        // 1. 聚合抓取资源站数据
        const promises = sources.map(s => 
            fetch(`${s.url}?ac=detail&wd=${encodeURIComponent(kw)}`).then(r => r.json()).catch(() => ({list:[]}))
        );
        const results = await Promise.all(promises);
        grid.innerHTML = '';

        // 2. 合并结果并去重显示
        let combined = [];
        results.forEach(res => { if(res.list) combined = [...combined, ...res.list]; });

        if(combined.length === 0) {
            grid.innerHTML = '<div>未找到相关资源，请检查订阅源或关键词。</div>';
            return;
        }

        combined.forEach(item => renderMovieCard(item));
    }

    // 渲染卡片并实时抓取豆瓣评分/海报
    async function renderMovieCard(item) {
        const grid = document.getElementById('main-grid');
        const card = document.createElement('div');
        card.className = 'movie-card';
        // 初始显示资源站图片
        card.innerHTML = `
            <div class="rating" id="rate-${item.vod_id}">--</div>
            <img src="${item.vod_pic}" referrerpolicy="no-referrer" id="img-${item.vod_id}">
            <div class="info">
                <div class="t">${item.vod_name}</div>
                <div class="s">${item.vod_remarks || '高清'}</div>
            </div>
        `;
        card.onclick = () => openPlayer(item);
        grid.appendChild(card);

        // 异步尝试豆瓣匹配增强
        try {
            const dbRes = await fetch(`https://api.wmdb.tv/api/v1/movie/search?q=${encodeURIComponent(item.vod_name)}`);
            const dbData = await dbRes.json();
            if(dbData && dbData.length > 0) {
                const bestMatch = dbData[0];
                document.getElementById(`rate-${item.vod_id}`).innerText = bestMatch.doubanRating || "7.0";
                document.getElementById(`img-${item.vod_id}`).src = bestMatch.data[0].poster;
                item.dbData = bestMatch; // 存入详情使用
            }
        } catch(e){}
    }

    // 3. 播放器逻辑：处理选集与换源
    function openPlayer(item) {
        document.getElementById('play-layer').style.display = 'grid';
        document.getElementById('v-title').innerText = item.vod_name;
        document.getElementById('v-desc').innerText = item.dbData?.description || item.vod_content.replace(/<[^>]+>/g, '');
        document.getElementById('v-meta').innerText = `豆瓣评分: ${item.dbData?.doubanRating || '7.0'} / 分类: ${item.vod_type_name}`;

        const tabMenu = document.getElementById('line-tabs');
        const epList = document.getElementById('ep-list');
        tabMenu.innerHTML = '';
        epList.innerHTML = '';

        // 解析资源站的多线路 ($$$ 分割)
        const lines = item.vod_play_url.split('$$$');
        lines.forEach((lineData, index) => {
            const btn = document.createElement('div');
            btn.className = `tab-btn ${index === 0 ? 'active' : ''}`;
            btn.innerText = `线路 ${index + 1}`;
            btn.onclick = () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEpisodes(lineData);
            };
            tabMenu.appendChild(btn);
            if(index === 0) renderEpisodes(lineData);
        });
    }

    function renderEpisodes(lineData) {
        const epList = document.getElementById('ep-list');
        epList.innerHTML = '';
        const eps = lineData.split('#');
        eps.forEach((ep, i) => {
            const [name, url] = ep.split('$');
            const div = document.createElement('div');
            div.className = 'ep-item';
            div.innerText = name || `第${i+1}集`;
            div.onclick = () => {
                document.querySelectorAll('.ep-item').forEach(e => e.classList.remove('active'));
                div.classList.add('active');
                playUrl(url);
            };
            epList.appendChild(div);
            if(i === 0) div.click();
        });
    }

    function playUrl(url) {
        // 关键：解决黑屏，强制 HLS 类型识别
        player.src({
            src: url,
            type: url.includes('m3u8') ? 'application/x-mpegURL' : 'video/mp4'
        });
        player.play().catch(e => {
            alert("播放失败：该源地址可能失效或存在跨域安全限制。");
        });
    }

    function closePlayer() {
        player.pause();
        document.getElementById('play-layer').style.display = 'none';
    }

    renderSources();
</script>
</body>
</html>
