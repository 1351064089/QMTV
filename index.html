<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>UltraVision OS 7.0 | 豆瓣全联动旗舰</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #00fb9a; --bg: #050505; --card: #121212; --panel: #181818; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: "PingFang SC", sans-serif; height: 100vh; overflow: hidden; }
        
        #app { display: flex; height: 100vh; }
        
        /* 侧边栏：历史 + 订阅 */
        aside { width: 300px; background: #000; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .side-title { padding: 20px; font-size: 18px; font-weight: bold; color: var(--main); border-bottom: 1px solid #222; }
        .section-label { padding: 15px 20px 5px; font-size: 12px; color: #666; text-transform: uppercase; }
        .list-box { flex: 1; overflow-y: auto; padding: 10px; }
        
        /* 记录样式 */
        .item-card { background: var(--panel); padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; cursor: pointer; transition: 0.2s; position: relative; border: 1px solid transparent; }
        .item-card:hover { border-color: var(--main); background: #222; }
        .item-card .del { position: absolute; right: 10px; top: 10px; color: #ff4444; opacity: 0; }
        .item-card:hover .del { opacity: 1; }
        
        /* 主界面 */
        main { flex: 1; display: flex; flex-direction: column; overflow: hidden; }
        header { background: rgba(0,0,0,0.9); padding: 15px 30px; border-bottom: 1px solid #222; }
        .nav-cats { display: flex; gap: 25px; margin-bottom: 15px; }
        .cat { cursor: pointer; color: #888; font-size: 15px; position: relative; padding-bottom: 5px; }
        .cat.active { color: var(--main); }
        .cat.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--main); }
        .search-row { display: flex; gap: 10px; }
        input.search { flex: 1; background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 10px 20px; border-radius: 20px; outline: none; }

        /* 海报区 */
        .content { flex: 1; overflow-y: auto; padding: 30px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(150px, 1fr)); gap: 25px; }
        .card { background: var(--card); border-radius: 10px; overflow: hidden; cursor: pointer; transition: 0.3s; position: relative; }
        .card:hover { transform: scale(1.05); z-index: 10; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .score { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.7); color: #ffb800; font-size: 12px; padding: 2px 6px; border-radius: 4px; font-weight: bold; }
        .card .title { padding: 10px; font-size: 13px; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 播放器全屏 */
        #player-layer { position: fixed; inset: 0; background: #000; z-index: 3000; display: none; grid-template-columns: 1fr 350px; }
        .video-box { position: relative; display: flex; flex-direction: column; }
        .ep-box { background: #111; padding: 20px; border-left: 1px solid #222; overflow-y: auto; }
        .close-btn { position: absolute; top: 20px; left: 20px; z-index: 10; background: rgba(0,0,0,0.6); padding: 8px 15px; border-radius: 20px; cursor: pointer; }
        .ep-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 20px; }
        .ep-btn { background: #222; border: 1px solid #333; color: #aaa; padding: 8px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .ep-btn.active { background: var(--main); color: #000; font-weight: bold; border-color: var(--main); }
    </style>
</head>
<body>

<div id="app">
    <aside>
        <div class="side-title">ULTRAVISION OS</div>
        
        <div class="section-label">添加订阅源</div>
        <div style="padding: 0 20px 15px;">
            <input type="text" id="new-name" placeholder="源名称(如: 茅台)" style="width:100%; margin-bottom:5px; background:#111; border:1px solid #333; color:#fff; padding:6px; border-radius:4px;">
            <input type="text" id="new-url" placeholder="API 地址" style="width:100%; margin-bottom:5px; background:#111; border:1px solid #333; color:#fff; padding:6px; border-radius:4px;">
            <button onclick="saveSrc()" style="width:100%; background:var(--main); border:none; color:#000; font-weight:bold; padding:8px; border-radius:4px; cursor:pointer;">导入订阅</button>
        </div>

        <div class="section-label">播放历史记录</div>
        <div class="list-box" id="history-list"></div>

        <div class="section-label">已导入订阅源</div>
        <div class="list-box" id="src-list"></div>
    </aside>

    <main>
        <header>
            <div class="nav-cats" id="cat-tabs">
                <div class="cat active" data-type="Movie">电影推荐</div>
                <div class="cat" data-type="TV">热播剧集</div>
                <div class="cat" data-type="Variety">综艺晚会</div>
                <div class="cat" data-type="Anime">二次元动漫</div>
            </div>
            <div class="search-row">
                <input type="text" id="search-kw" class="search" placeholder="输入片名，全网源聚合匹配...">
                <button onclick="aggregateSearch()" style="background:var(--main); border:none; color:#000; font-weight:bold; padding:0 20px; border-radius:20px; cursor:pointer;">聚合搜索</button>
            </div>
        </header>

        <div class="content">
            <div class="grid" id="main-grid"></div>
        </div>
    </main>
</div>

<div id="player-layer">
    <div class="close-btn" onclick="closePlayer()">✕ 退出播放</div>
    <div class="video-box">
        <video id="v-player" class="video-js vjs-big-play-centered" controls style="width:100%; height:100%;"></video>
        <div style="padding:25px; background:linear-gradient(to bottom, #111, #000);">
            <h1 id="v-title" style="margin:0; color:var(--main);"></h1>
            <p id="v-desc" style="color:#888; font-size:14px; line-height:1.6;"></p>
        </div>
    </div>
    <div class="ep-box">
        <h3>多线路选集</h3>
        <div id="v-lines" style="display:flex; gap:10px;"></div>
        <div class="ep-grid" id="v-eps"></div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('v-player');
    let sources = JSON.parse(localStorage.getItem('uv_src_v7') || '[]');
    let historyData = JSON.parse(localStorage.getItem('uv_his_v7') || '[]');

    // 1. 初始化
    window.onload = () => {
        initUI();
        loadDouban('Movie'); // 首页默认加载电影
    };

    function initUI() {
        renderSources();
        renderHistory();
        document.querySelectorAll('.cat').forEach(c => {
            c.onclick = () => {
                document.querySelectorAll('.cat').forEach(i => i.classList.remove('active'));
                c.classList.add('active');
                loadDouban(c.dataset.type);
            }
        });
    }

    // 2. 豆瓣数据真导入：从 API 抓取热映排行榜
    async function loadDouban(type) {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center; padding:50px;">正在从豆瓣云端导入最新排行...</div>';
        
        try {
            // 使用公共豆瓣数据接口
            const res = await fetch(`https://api.wmdb.tv/api/v1/top?type=${type}&skip=0&limit=36`);
            const data = await res.json();
            grid.innerHTML = '';
            data.forEach(m => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="score">${m.doubanRating || '7.0'}</div>
                    <img src="${m.data[0].poster}" referrerpolicy="no-referrer">
                    <div class="title">${m.data[0].name}</div>
                `;
                // 点击豆瓣海报，直接通过标题在资源站里聚合搜索
                card.onclick = () => {
                    document.getElementById('search-kw').value = m.data[0].name;
                    aggregateSearch();
                };
                grid.appendChild(card);
            });
        } catch(e) {
            grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">豆瓣数据拉取失败，请检查网络或点击搜索。</div>';
        }
    }

    // 3. 聚合搜索逻辑
    async function aggregateSearch() {
        const kw = document.getElementById('search-kw').value.trim();
        if(!kw) return;
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">正在聚合全网订阅源...</div>';

        const promises = sources.map(s => 
            fetch(`${s.url}?ac=detail&wd=${encodeURIComponent(kw)}`).then(r => r.json()).catch(() => ({list:[]}))
        );
        const results = await Promise.all(promises);
        grid.innerHTML = '';
        results.forEach((res, idx) => {
            if(res.list) res.list.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `
                    <div class="score" style="color:var(--main)">${sources[idx].name}</div>
                    <img src="${item.vod_pic}" referrerpolicy="no-referrer">
                    <div class="title">${item.vod_name}</div>
                `;
                card.onclick = () => openPlayer(item);
                grid.appendChild(card);
            });
        });
    }

    // 4. 播放与历史记录保存
    function openPlayer(item) {
        document.getElementById('player-layer').style.display = 'grid';
        document.getElementById('v-title').innerText = item.vod_name;
        document.getElementById('v-desc').innerText = item.vod_content.replace(/<[^>]+>/g, '');

        // 存入播放历史 (去重并置顶)
        historyData = historyData.filter(h => h.vod_id !== item.vod_id);
        historyData.unshift(item);
        if(historyData.length > 20) historyData.pop();
        localStorage.setItem('uv_his_v7', JSON.stringify(historyData));
        renderHistory();

        const lineNav = document.getElementById('v-lines');
        const epGrid = document.getElementById('v-eps');
        lineNav.innerHTML = ''; epGrid.innerHTML = '';

        const lines = item.vod_play_url.split('$$$');
        lines.forEach((line, i) => {
            const lbtn = document.createElement('button');
            lbtn.className = 'ep-btn';
            lbtn.innerText = '线路' + (i+1);
            lbtn.onclick = () => {
                epGrid.innerHTML = '';
                line.split('#').forEach(ep => {
                    const [name, url] = ep.split('$');
                    const ebtn = document.createElement('button');
                    ebtn.className = 'ep-btn';
                    ebtn.innerText = name;
                    ebtn.onclick = () => {
                        document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
                        ebtn.classList.add('active');
                        player.src({ src: url, type: 'application/x-mpegURL' });
                        player.play();
                    };
                    epGrid.appendChild(ebtn);
                });
                if(epGrid.firstChild) epGrid.firstChild.click();
            };
            lineNav.appendChild(lbtn);
        });
        if(lineNav.firstChild) lineNav.firstChild.click();
    }

    // 5. 侧边栏渲染
    function renderHistory() {
        const box = document.getElementById('history-list');
        box.innerHTML = historyData.length ? '' : '<div style="color:#444; padding:10px;">暂无历史记录</div>';
        historyData.forEach((h, i) => {
            const d = document.createElement('div');
            d.className = 'item-card';
            d.innerHTML = `<b>${h.vod_name}</b><br><small style="color:#666">上次观看</small><span class="del" onclick="delHis(event, ${i})">✕</span>`;
            d.onclick = () => openPlayer(h);
            box.appendChild(d);
        });
    }

    function renderSources() {
        const box = document.getElementById('src-list');
        box.innerHTML = '';
        sources.forEach((s, i) => {
            const d = document.createElement('div');
            d.className = 'item-card';
            d.innerHTML = `${s.name} <span class="del" onclick="delSrc(event, ${i})">✕</span>`;
            d.onclick = () => { 
                document.getElementById('search-kw').value = ''; 
                loadSingleSrc(s.url); 
            };
            box.appendChild(d);
        });
    }

    // 功能函数
    function saveSrc() {
        const n = document.getElementById('new-name').value;
        const u = document.getElementById('new-url').value;
        if(n && u) {
            sources.push({ name: n, url: u });
            localStorage.setItem('uv_src_v7', JSON.stringify(sources));
            renderSources();
        }
    }
    function delSrc(e, i) { e.stopPropagation(); sources.splice(i,1); localStorage.setItem('uv_src_v7', JSON.stringify(sources)); renderSources(); }
    function delHis(e, i) { e.stopPropagation(); historyData.splice(i,1); localStorage.setItem('uv_his_v7', JSON.stringify(historyData)); renderHistory(); }
    function closePlayer() { player.pause(); document.getElementById('player-layer').style.display = 'none'; }
    async function loadSingleSrc(url) {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">正在读取源首页内容...</div>';
        const res = await fetch(url + "?ac=detail").then(r => r.json()).catch(()=>({list:[]}));
        grid.innerHTML = '';
        if(res.list) res.list.forEach(item => {
            const card = document.createElement('div');
            card.className = 'card';
            card.innerHTML = `<img src="${item.vod_pic}" referrerpolicy="no-referrer"><div class="title">${item.vod_name}</div>`;
            card.onclick = () => openPlayer(item);
            grid.appendChild(card);
        });
    }
</script>
</body>
</html>
