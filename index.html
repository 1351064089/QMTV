<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE TV V21.2 | 豆瓣全兼容版</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --db-green: #007722; --db-bg: #f7f7f7; --db-text: #111; --db-link: #37a; }
        body { margin: 0; background: var(--db-bg); color: var(--db-text); font-family: -apple-system, system-ui, sans-serif; }
        
        /* 头部导航 */
        header { background: #fff; border-bottom: 1px solid #f3f3f3; padding: 12px 4vw; position: sticky; top: 0; z-index: 999; display: flex; align-items: center; }
        .logo { color: var(--db-green); font-size: 24px; font-weight: 900; cursor: pointer; margin-right: 30px; }
        .search-area { flex: 1; max-width: 400px; }
        .search-area input { width: 100%; background: #f5f5f5; border: none; padding: 8px 15px; border-radius: 4px; outline: none; }
        .nav-links { display: flex; gap: 20px; margin-left: auto; font-size: 14px; }
        .nav-links div { cursor: pointer; color: #666; }
        .nav-links div.active { color: var(--db-green); font-weight: bold; }
        .nav-links .mgr-btn { background: #fff8e1; color: #f57c00; padding: 2px 8px; border-radius: 4px; border: 1px solid #ffe0b2; }

        /* 内容区 */
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; }
        .filter-bar { margin-bottom: 20px; background: #fff; padding: 15px; border-radius: 4px; display: none; }
        .tag { cursor: pointer; padding: 2px 10px; color: var(--db-link); font-size: 13px; }
        .tag.active { background: var(--db-green); color: #fff; border-radius: 3px; }

        .section-title { font-size: 18px; margin: 20px 0; border-left: 4px solid var(--db-green); padding-left: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; }
        
        /* 豆瓣风格卡片 */
        .card { cursor: pointer; text-align: center; }
        .poster-wrap { position: relative; padding-top: 140%; border-radius: 4px; overflow: hidden; background: #eee; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .poster { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .card-title { font-size: 14px; margin-top: 8px; color: #37a; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 详情播放页 */
        #detail-view { display: none; position: fixed; inset: 0; background: #fff; z-index: 2000; overflow-y: auto; }
        .detail-header { padding: 15px 4vw; border-bottom: 1px solid #eee; color: var(--db-green); cursor: pointer; font-weight: bold; }
        .detail-layout { max-width: 1100px; margin: 20px auto; display: grid; grid-template-columns: 1.5fr 1fr; gap: 40px; padding: 0 20px; }
        
        @media (max-width: 800px) { .detail-layout { grid-template-columns: 1fr; } }

        .v-container { background: #000; border-radius: 8px; overflow: hidden; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .ep-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(70px, 1fr)); gap: 8px; max-height: 400px; overflow-y: auto; padding: 10px; background: #f9f9f9; border-radius: 4px; }
        .ep-item { padding: 8px; font-size: 12px; text-align: center; background: #fff; border: 1px solid #eee; cursor: pointer; border-radius: 2px; }
        .ep-item:hover { border-color: var(--db-green); color: var(--db-green); }
        .ep-item.active { background: var(--db-green); color: #fff; border-color: var(--db-green); }

        /* 管理弹窗 */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.6); z-index: 3000; align-items: center; justify-content: center; }
        .modal-content { background: #fff; width: 90%; max-width: 500px; padding: 25px; border-radius: 8px; }
        textarea { width: 100%; height: 100px; margin: 10px 0; padding: 10px; box-sizing: border-box; border: 1px solid #ddd; }
        .btn-group { display: flex; gap: 10px; margin-top: 10px; }
        button { flex: 1; padding: 10px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-main { background: var(--db-green); color: #fff; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE TV</div>
    <div class="search-area"><input type="text" id="kw" placeholder="输入片名，回车搜索..." onkeydown="if(event.keyCode==13) search()"></div>
    <div class="nav-links">
        <div onclick="switchTab('home')" class="active" id="nav-home">首页</div>
        <div onclick="switchTab('movie')" id="nav-movie">电影</div>
        <div onclick="switchTab('tv')" id="nav-tv">剧集</div>
        <div onclick="openMgr()" class="mgr-btn">⚙ 源管理</div>
    </div>
</header>

<div class="container" id="main-view"></div>

<div id="detail-view">
    <div class="detail-header" onclick="closeDetail()">← 返回列表</div>
    <div class="detail-layout">
        <div class="left-col">
            <h2 id="d-title" style="margin:0 0 10px 0;"></h2>
            <div class="v-container" id="player-box"></div>
            <div style="background:#f0f0f0; padding:10px; border-radius:4px; font-size:13px; margin-bottom:20px;">
                <label><input type="checkbox" id="auto-next" checked> 自动下一集</label>
                <span style="margin-left:20px;">跳过片头 <input type="number" id="sk-s" value="0" style="width:40px;"> 秒</span>
            </div>
            <p id="d-desc" style="font-size:14px; color:#444; line-height:1.6;"></p>
        </div>
        <div class="right-col">
            <div style="margin-bottom:15px; font-weight:bold; color:var(--db-green);">选集播放</div>
            <div class="ep-list" id="ep-list"></div>
        </div>
    </div>
</div>

<div class="modal" id="mgr-modal">
    <div class="modal-content">
        <h3>管理数据源</h3>
        <p style="font-size:12px; color:#888;">支持 JSON 或 XML 接口（如：https://.../api.php/provide/vod/at/xml/）</p>
        <textarea id="api-input" placeholder="输入 API 接口地址..."></textarea>
        <div id="source-list" style="max-height:100px; overflow-y:auto; font-size:12px; margin-bottom:10px;"></div>
        <div class="btn-group">
            <button class="btn-main" onclick="saveSource()">保存并刷新</button>
            <button onclick="closeMgr()">取消</button>
        </div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    let player = null;
    let currentApi = localStorage.getItem('joe_active_api') || '';
    let apiList = JSON.parse(localStorage.getItem('joe_api_list') || '[]');
    let categories = [];

    // --- 初始化 ---
    async function init() {
        if(!currentApi) { openMgr(); return; }
        await loadCategories();
        switchTab('home');
    }

    // 针对 XML 和 JSON 的万能解析器
    async function smartFetch(url) {
        try {
            const response = await fetch(url);
            const text = await response.text();
            // 如果是 XML
            if (text.trim().startsWith('<?xml') || text.trim().startsWith('<rss')) {
                const parser = new DOMParser();
                const xml = parser.parseFromString(text, "text/xml");
                const list = [];
                const items = xml.querySelectorAll('video');
                items.forEach(v => {
                    list.push({
                        vod_id: v.querySelector('id')?.textContent,
                        vod_name: v.querySelector('name')?.textContent,
                        vod_pic: v.querySelector('pic')?.textContent,
                        vod_play_url: v.querySelector('dl dd')?.textContent || v.querySelector('last')?.textContent,
                        vod_content: v.querySelector('des')?.textContent,
                        type_name: v.querySelector('type')?.textContent
                    });
                });
                return { list, class: [] }; // XML 结构简化处理
            } 
            // 如果是 JSON
            return JSON.parse(text);
        } catch (e) {
            console.error("解析失败:", e);
            return { list: [] };
        }
    }

    async function loadCategories() {
        const data = await smartFetch(`${currentApi}?ac=list`);
        categories = data.class || [];
    }

    async function fetchList(targetId, params) {
        const data = await smartFetch(`${currentApi}?ac=detail&${params}`);
        renderGrid(targetId, data.list || []);
    }

    function renderGrid(id, list) {
        const container = document.getElementById(id);
        if(!container) return;
        container.innerHTML = list.map(v => `
            <div class="card" onclick="openDetail('${v.vod_id}')">
                <div class="poster-wrap"><img class="poster" src="${v.vod_pic}"></div>
                <div class="card-title">${v.vod_name}</div>
            </div>
        `).join('');
    }

    function switchTab(tab) {
        document.querySelectorAll('.nav-links div').forEach(d => d.classList.remove('active'));
        document.getElementById('nav-'+tab).classList.add('active');
        const main = document.getElementById('main-view');
        
        if(tab === 'home') {
            main.innerHTML = `<div class="section-title">最近更新</div><div class="grid" id="g-home"></div>`;
            fetchList('g-home', 'pg=1');
        } else {
            const key = tab === 'movie' ? '电影' : '剧';
            main.innerHTML = `<div class="section-title">${key}精选</div><div class="grid" id="g-cat"></div>`;
            fetchList('g-cat', `wd=${key}`);
        }
    }

    async function search() {
        const kw = document.getElementById('kw').value;
        if(!kw) return;
        document.getElementById('main-view').innerHTML = `<div class="section-title">搜索: ${kw}</div><div class="grid" id="g-search"></div>`;
        fetchList('g-search', `wd=${encodeURIComponent(kw)}`);
    }

    // --- 播放逻辑修复 ---
    async function openDetail(id) {
        const data = await smartFetch(`${currentApi}?ac=detail&ids=${id}`);
        const v = data.list[0];
        document.getElementById('d-title').innerText = v.vod_name;
        document.getElementById('d-desc').innerText = v.vod_content || '暂无简介';
        
        // 解析播放列表 (兼容资源站多种分隔符)
        const rawUrl = v.vod_play_url || "";
        let eps = [];
        if(rawUrl.includes('$')) {
            // 标准格式: 集数$url#集数$url
            eps = rawUrl.split('#').map(item => {
                const parts = item.split('$');
                return { name: parts[0], url: parts[1] };
            });
        } else {
            // 只有URL格式
            eps = [{ name: '正片', url: rawUrl }];
        }

        const epList = document.getElementById('ep-list');
        epList.innerHTML = eps.map((e, index) => `
            <div class="ep-item" onclick="playVideo('${e.url}', this)">${e.name}</div>
        `).join('');

        document.getElementById('detail-view').style.display = 'block';
        if(eps.length > 0) epList.firstChild.nextSibling.click(); // 修正：点击第一个子元素
    }

    function playVideo(url, el) {
        // UI 状态切换
        document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
        el.classList.add('active');

        const container = document.getElementById('player-box');
        container.innerHTML = `<video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto" width="100%"></video>`;
        
        if(player) player.dispose();
        
        player = videojs('v-core');
        player.src({ src: url, type: 'application/x-mpegURL' });
        
        player.ready(() => {
            const skip = parseInt(document.getElementById('sk-s').value) || 0;
            if(skip > 0) player.currentTime(skip);
            player.play().catch(e => console.log("等待手动点击播放"));
        });

        player.on('ended', () => {
            if(document.getElementById('auto-next').checked) {
                const next = el.nextElementSibling;
                if(next) next.click();
            }
        });
    }

    function closeDetail() {
        if(player) player.pause();
        document.getElementById('detail-view').style.display = 'none';
    }

    // --- 管理功能 ---
    function openMgr() {
        document.getElementById('mgr-modal').style.display = 'flex';
        document.getElementById('api-input').value = currentApi;
        document.getElementById('source-list').innerHTML = `当前使用: ${currentApi || '无'}`;
    }
    function closeMgr() { document.getElementById('mgr-modal').style.display = 'none'; }
    function saveSource() {
        const val = document.getElementById('api-input').value.trim();
        if(val) {
            localStorage.setItem('joe_active_api', val);
            location.reload();
        }
    }

    window.onload = init;
</script>
</body>
</html>
