<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE OS | Ultimate V12</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #a29bfe; --bg: #f8fafc; --text: #1e293b; --card: #ffffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "PingFang SC", "Microsoft YaHei", sans-serif; }
        
        /* å¯¼èˆª */
        header { 
            position: sticky; top: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(15px);
            display: flex; align-items: center; padding: 10px 30px; z-index: 1000; border-bottom: 1px solid #e2e8f0;
        }
        .logo { font-size: 24px; font-weight: 900; color: var(--main); margin-right: 30px; cursor: pointer; }
        .nav { display: flex; gap: 12px; flex: 1; }
        .nav div { padding: 8px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; background: #f1f5f9; transition: 0.2s; }
        .nav div:hover { background: #e2e8f0; }
        .nav .active { background: var(--main); color: white; box-shadow: 0 4px 10px rgba(162, 155, 254, 0.3); }

        .search-area { display: flex; align-items: center; background: #f1f5f9; border-radius: 20px; padding: 5px 15px; width: 300px; }
        .search-area input { border: none; background: transparent; outline: none; padding: 5px; flex: 1; font-size: 14px; }

        /* å†…å®¹åŒº */
        .container { max-width: 1400px; margin: 20px auto; padding: 0 20px; }
        .section-title { font-size: 20px; font-weight: bold; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        
        /* å¡ç‰‡æ ·å¼ */
        .card { background: var(--card); border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid #f1f5f9; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.05); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: #eee; }
        .card .title { padding: 10px; text-align: center; font-size: 13px; font-weight: 600; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card .res-tag { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; }

        /* æ’­æ”¾å™¨é¡µé¢ */
        #player-page { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; padding-top: 60px; }
        .player-layout { display: grid; grid-template-columns: 1fr 380px; gap: 25px; max-width: 1500px; margin: 0 auto; padding: 0 20px; }
        .v-box { background: #000; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.2); }
        
        /* ä¾§è¾¹é¢æ¿ */
        .side-panel { background: #fff; border-radius: 16px; height: 780px; display: flex; flex-direction: column; border: 1px solid #e2e8f0; }
        .tabs { display: flex; background: #f8fafc; padding: 6px; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; font-size: 14px; font-weight: bold; color: #94a3b8; border-radius: 10px; }
        .tab.active { background: #fff; color: var(--main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }

        /* åˆ†æ®µä¸é›†æ•° */
        .range-bar { display: flex; gap: 8px; padding: 10px; overflow-x: auto; border-bottom: 1px solid #f1f5f9; }
        .range-btn { padding: 5px 12px; border-radius: 6px; background: #f1f5f9; font-size: 11px; cursor: pointer; white-space: nowrap; }
        .range-btn.active { background: var(--main); color: white; }
        
        .ep-list { flex: 1; overflow-y: auto; padding: 15px; }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .ep-item { background: #f8fafc; border: 1px solid #f1f5f9; padding: 12px 0; text-align: center; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .ep-item.active { background: var(--main); color: white; border-color: var(--main); }

        /* å¼¹çª—æ ·å¼ */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-body { background: #fff; width: 500px; padding: 25px; border-radius: 20px; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        .api-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8fafc; margin-bottom: 8px; border-radius: 10px; border: 1px solid #eee; }
        .api-row span { font-size: 13px; color: #1e293b; font-weight: bold; }
        .api-row button { background: #ff7675; color: white; border: none; padding: 4px 8px; border-radius: 5px; cursor: pointer; font-size: 11px; }
        textarea { width: 100%; height: 120px; border: 1px solid #e2e8f0; border-radius: 10px; padding: 10px; margin: 15px 0; font-size: 12px; resize: none; box-sizing: border-box; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE TV</div>
    <div class="nav">
        <div class="active" onclick="initHome('Movie')">ç”µå½±</div>
        <div onclick="initHome('TV')">å‰§é›†</div>
        <div onclick="initHome('Anime')">åŠ¨æ¼«</div>
        <div onclick="openManager()" style="background:#fff3bf; color:#e67700;">âš™ï¸ æºç®¡ç†</div>
    </div>
    <div class="search-area">
        <input type="text" id="kw" placeholder="è¾“å…¥ç‰‡åï¼Œå›è½¦æœç´¢..." onkeydown="if(event.keyCode==13) search()">
    </div>
</header>

<div class="container">
    <div class="section-title" id="sec-title">ğŸ¬ çƒ­é—¨æ¨è</div>
    <div class="grid" id="main-grid"></div>
</div>

<div id="player-page">
    <div style="position: absolute; top: 15px; left: 30px; cursor: pointer; font-weight: bold; color: var(--main);" onclick="closePlayer()">å…³é—­æ’­æ”¾å™¨</div>
    <div class="player-layout">
        <div class="p-left">
            <div class="v-box">
                <video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto"></video>
            </div>
            <div style="background:#fff; margin-top:20px; padding:20px; border-radius:16px;">
                <h2 id="v-name" style="margin:0"></h2>
                <div style="margin-top:15px; display:flex; gap:20px; font-size:13px; color:#64748b;">
                    <span>è·³è¿‡ç‰‡å¤´: <input type="number" id="sk-start" value="0" style="width:50px; border:1px solid #ddd; border-radius:4px; text-align:center;" onchange="saveConf()"> ç§’</span>
                    <span>è‡ªåŠ¨ä¸‹ä¸€é›†: <input type="checkbox" id="at-next" checked onchange="saveConf()"></span>
                </div>
                <p id="v-desc" style="font-size:13px; line-height:1.6; color:#94a3b8; margin-top:15px;"></p>
            </div>
        </div>
        <div class="side-panel">
            <div class="tabs">
                <div class="tab active" onclick="switchTab('ep')">é€‰é›†</div>
                <div class="tab" onclick="switchTab('src')">çº¿è·¯</div>
            </div>
            <div id="ep-sec" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                <div class="range-bar" id="range-bar"></div>
                <div class="ep-list"><div class="ep-grid" id="ep-grid"></div></div>
            </div>
            <div id="src-sec" class="ep-list" style="display:none;">
                <div id="src-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="modal-mgr">
    <div class="modal-body">
        <h3 style="margin-top:0">å·²æ·»åŠ çš„æºç®¡ç†</h3>
        <div id="api-items"></div>
        <hr style="border:none; border-top:1px dashed #eee; margin:20px 0;">
        <p style="font-size:12px; color:#94a3b8;">æ‰¹é‡å¯¼å…¥ (æ¯è¡Œä¸€ä¸ª API åœ°å€):</p>
        <textarea id="api-input" placeholder="http://cj.example.com/api.php/provide/vod/at/json/"></textarea>
        <button onclick="saveApis()" style="width:100%; background:var(--main); color:#fff; border:none; padding:12px; border-radius:10px; cursor:pointer; font-weight:bold;">å¼€å§‹è§£æå¯¼å…¥</button>
        <button onclick="closeManager()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('v-core');
    let apis = JSON.parse(localStorage.getItem('joe_v12_apis') || '[]');
    let config = JSON.parse(localStorage.getItem('joe_v12_conf') || '{"skip":0,"auto":true}');
    let currentRawEps = [];

    // --- é¦–é¡µä¸åŠ è½½ ---
    async function initHome(type) {
        document.getElementById('sec-title').innerText = "ğŸ¬ " + (type==='Movie'?'çƒ­é—¨ç”µå½±':type==='TV'?'åŒæ­¥å‰§é›†':'åŠ¨æ¼«ç•ªå‰§');
        const grid = document.getElementById('main-grid');
        grid.innerHTML = "æ­£åœ¨åŠ è½½äº‘ç«¯æ•°æ®...";
        
        // å°è¯•åŠ è½½è±†ç“£ï¼Œå¤±è´¥åˆ™åŠ è½½èµ„æºç«™é¦–å±
        try {
            const res = await fetch(`https://api.wmdb.tv/api/v1/top?type=${type}&skip=0&limit=30`).then(r => r.json());
            renderGrid(res.map(m => ({ name: m.data[0].name, pic: m.data[0].poster, tag: m.doubanRating })));
        } catch(e) {
            if(apis.length > 0) fetchFirstApi();
            else grid.innerHTML = "<div style='grid-column:1/-1;text-align:center;padding:50px;'>é¦–é¡µæš‚æ— æ•°æ®ï¼Œè¯·å…ˆç‚¹å‡»â€œæºç®¡ç†â€å¯¼å…¥èµ„æºåœ°å€ã€‚</div>";
        }
    }

    async function fetchFirstApi() {
        try {
            const res = await fetch(apis[0].url + "?ac=detail").then(r => r.json());
            renderGrid(res.list.map(v => ({ name: v.vod_name, pic: v.vod_pic, tag: v.vod_remarks })));
        } catch(e) { document.getElementById('main-grid').innerHTML = "çº¿è·¯è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æºã€‚"; }
    }

    function renderGrid(data) {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = "";
        data.forEach(item => {
            const d = document.createElement('div');
            d.className = 'card';
            d.innerHTML = `<div class="res-tag">${item.tag}</div><img src="${item.pic}"><div class="title">${item.name}</div>`;
            d.onclick = () => { document.getElementById('kw').value = item.name; search(); };
            grid.appendChild(d);
        });
    }

    // --- æœç´¢ä¸æµ‹é€Ÿ ---
    async function search() {
        const kw = document.getElementById('kw').value;
        if(!kw || apis.length === 0) return alert("è¯·å…ˆæ·»åŠ æºï¼");
        const grid = document.getElementById('main-grid');
        grid.innerHTML = "èšåˆçº¿è·¯æ·±åº¦æœç´¢ä¸­...";

        const results = await Promise.allSettled(apis.map(async api => {
            const start = Date.now();
            const res = await fetch(`${api.url}?ac=detail&wd=${encodeURIComponent(kw)}`).then(r => r.json());
            return { api, list: res.list || [], ms: Date.now() - start };
        }));

        grid.innerHTML = "";
        results.forEach(res => {
            if(res.status === 'fulfilled' && res.value.list.length > 0) {
                res.value.list.forEach(v => {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `<div class="res-tag" style="background:green">${res.value.ms}ms</div><img src="${v.vod_pic}"><div class="title">${v.vod_name}</div>`;
                    card.onclick = () => openPlayer(v, results);
                    grid.appendChild(card);
                });
            }
        });
    }

    // --- æ’­æ”¾ä¸åŠ¨æ€åˆ†æ®µé€»è¾‘ (æ ¸å¿ƒä¿®å¤) ---
    function openPlayer(v, allRes) {
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-name').innerText = v.vod_name;
        document.getElementById('v-desc').innerText = v.vod_content.replace(/<[^>]+>/g, '');
        document.getElementById('sk-start').value = config.skip;
        document.getElementById('at-next').checked = config.auto;

        const srcBox = document.getElementById('src-list');
        srcBox.innerHTML = "";
        allRes.forEach(res => {
            if(res.status === 'fulfilled' && res.value.list.length > 0) {
                const item = document.createElement('div');
                item.className = 'api-row';
                item.style.cursor = "pointer";
                item.innerHTML = `<span>${res.value.api.name}</span> <span style="font-size:10px; color:green;">${res.value.ms}ms</span>`;
                item.onclick = () => {
                    currentRawEps = res.value.list[0].vod_play_url.split('#');
                    renderRanges();
                    switchTab('ep');
                };
                srcBox.appendChild(item);
            }
        });
        if(srcBox.firstChild) srcBox.firstChild.click();
    }

    function renderRanges() {
        const bar = document.getElementById('range-bar');
        bar.innerHTML = "";
        const size = 50;
        const total = currentRawEps.length;

        // å¦‚æœæ€»æ•°å°äº 1ï¼Œä¸æ¸²æŸ“
        if(total <= 0) return;

        // åŠ¨æ€è®¡ç®—åˆ†æ®µï¼šä¿®æ­£äº†â€œæ›´æ–°åˆ°50é›†åé¢ä¸æ˜¾ç¤ºâ€çš„Bug
        for(let i = 0; i < total; i += size) {
            const end = Math.min(i + size, total); // ç¡®ä¿æœ€åä¸€æ®µä¸è¶Šç•Œ
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = (i + 1) + "-" + end;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEps(i, end);
            };
            bar.appendChild(btn);
        }
        bar.firstChild.click();
    }

    function renderEps(start, end) {
        const grid = document.getElementById('ep-grid');
        grid.innerHTML = "";
        const slice = currentRawEps.slice(start, end);
        slice.forEach(item => {
            const [name, url] = item.split('$');
            const d = document.createElement('div');
            d.className = 'ep-item';
            d.innerText = name;
            d.onclick = () => {
                document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
                d.classList.add('active');
                player.src({ src: url, type: 'application/x-mpegURL' });
                player.one('loadedmetadata', () => { if(config.skip > 0) player.currentTime(config.skip); });
                player.play();
            };
            grid.appendChild(d);
        });
    }

    // --- æºç®¡ç†é€»è¾‘ ---
    function openManager() {
        document.getElementById('modal-mgr').style.display = 'flex';
        renderApiManager();
    }
    function closeManager() { document.getElementById('modal-mgr').style.display = 'none'; }
    
    function renderApiManager() {
        const box = document.getElementById('api-items');
        box.innerHTML = apis.length ? "" : "<p style='color:#999;font-size:12px;'>æš‚æ— è‡ªå®šä¹‰çº¿è·¯</p>";
        apis.forEach((api, idx) => {
            const div = document.createElement('div');
            div.className = 'api-row';
            div.innerHTML = `<span>${api.name}</span> <button onclick="delApi(${idx})">åˆ é™¤</button>`;
            box.appendChild(div);
        });
    }

    async function saveApis() {
        const urls = document.getElementById('api-input').value.split('\n').map(u => u.trim()).filter(u => u);
        for(let u of urls) {
            if(apis.some(a => a.url === u)) continue;
            try {
                const res = await fetch(u + "?ac=list").then(r => r.json());
                const name = res.source?.name || (res.class && res.class[0] ? res.class[0].name : "é‡‡é›†æº") + (apis.length+1);
                apis.push({ name, url: u });
            } catch(e) { console.error("æºè§£æå¤±è´¥:", u); }
        }
        localStorage.setItem('joe_v12_apis', JSON.stringify(apis));
        document.getElementById('api-input').value = "";
        renderApiManager();
    }

    function delApi(idx) {
        apis.splice(idx, 1);
        localStorage.setItem('joe_v12_apis', JSON.stringify(apis));
        renderApiManager();
    }

    // --- è®¾ç½®ä¸è¾…åŠ© ---
    function saveConf() {
        config.skip = parseInt(document.getElementById('sk-start').value) || 0;
        config.auto = document.getElementById('at-next').checked;
        localStorage.setItem('joe_v12_conf', JSON.stringify(config));
    }
    function switchTab(t) {
        document.getElementById('ep-sec').style.display = t==='ep'?'flex':'none';
        document.getElementById('src-sec').style.display = t==='src'?'block':'none';
        document.querySelectorAll('.tab').forEach((el, idx) => el.classList.toggle('active', (t==='ep' && idx===0) || (t==='src' && idx===1)));
    }
    function closePlayer() { player.pause(); document.getElementById('player-page').style.display = 'none'; }
    
    player.on('ended', () => {
        if(config.auto) {
            const next = document.querySelector('.ep-item.active').nextSibling;
            if(next) next.click();
        }
    });

    window.onload = () => initHome('Movie');
</script>
</body>
</html>
