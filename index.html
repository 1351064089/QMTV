<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UltraVision Pro - 多源影院</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #ff5c38; --bg: #0f0f0f; --card: #1a1a1a; --green: #00ff88; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: white; font-family: sans-serif; }
        
        /* 导航与管理 */
        nav { display: flex; align-items: center; padding: 15px 4%; background: #000; border-bottom: 1px solid #222; position: sticky; top:0; z-index:100; }
        .logo { font-size: 22px; font-weight: bold; color: var(--main); margin-right: 20px; }
        .source-mgr { display: flex; gap: 10px; flex: 1; }
        input { flex: 1; background: #222; border: 1px solid #333; color: white; padding: 8px 15px; border-radius: 4px; }
        button { background: var(--main); color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 13px; }
        
        /* 源状态显示 */
        .source-tags { display: flex; gap: 10px; padding: 10px 4%; overflow-x: auto; background: #111; }
        .tag { background: #222; padding: 4px 12px; border-radius: 15px; font-size: 12px; display: flex; align-items: center; gap: 5px; border: 1px solid #333; }
        .latency { font-weight: bold; }
        .lat-green { color: var(--green); }
        .lat-red { color: #ff3333; }

        /* 海报墙布局 */
        .container { padding: 20px 4%; }
        .poster-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .movie-card { background: var(--card); border-radius: 8px; overflow: hidden; cursor: pointer; transition: 0.3s; position: relative; }
        .movie-card:hover { transform: translateY(-5px); box-shadow: 0 5px 15px rgba(255,92,56,0.3); }
        .movie-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .movie-card .info { padding: 10px; font-size: 14px; text-overflow: ellipsis; white-space: nowrap; overflow: hidden; }
        .movie-card .badge { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); font-size: 11px; padding: 2px 6px; border-radius: 3px; }

        /* 播放器弹窗层 */
        #player-overlay { 
            position: fixed; top:0; left:0; width:100%; height:100%; background: #000; 
            z-index: 2000; display: none; grid-template-columns: 1fr 320px; 
        }
        .video-side { position: relative; display: flex; flex-direction: column; }
        .list-side { background: #111; border-left: 1px solid #222; overflow-y: auto; padding: 15px; }
        .close-btn { position: absolute; top: 10px; left: 10px; z-index: 2100; font-size: 24px; cursor: pointer; background: rgba(0,0,0,0.5); padding: 5px 15px; border-radius: 5px; }
        
        .episode-btn { display: block; width: 100%; padding: 10px; background: #222; margin-bottom: 5px; border: none; color: #ccc; text-align: left; cursor: pointer; border-radius: 4px; }
        .episode-btn:hover { background: #333; color: white; }
        .episode-btn.active { background: var(--main); color: white; }

        @media (max-width: 800px) {
            #player-overlay { grid-template-columns: 1fr; }
            .list-side { height: 300px; }
        }
    </style>
</head>
<body>

<nav>
    <div class="logo">UV-PRO</div>
    <div class="source-mgr">
        <input type="text" id="api-url" placeholder="贴入 CMS JSON 接口或 M3U 地址 (如茅台 API)...">
        <button onclick="addSource()">添加订阅</button>
    </div>
</nav>

<div class="source-tags" id="source-status">
    </div>

<div class="container">
    <div class="poster-grid" id="main-grid">
        </div>
</div>

<div id="player-overlay">
    <div class="close-btn" onclick="closePlayer()">✕ 返回首页</div>
    <div class="video-side">
        <video id="player" class="video-js vjs-big-play-centered" controls preload="auto"></video>
        <div style="padding: 20px;">
            <h1 id="v-title">影片标题</h1>
            <p id="v-desc" style="color: #888; font-size: 14px;"></p>
        </div>
    </div>
    <div class="list-side">
        <h3>选集播放</h3>
        <div id="episode-list"></div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('player', { fluid: true });
    let allContent = [];
    let currentSources = JSON.parse(localStorage.getItem('my_sources') || '[]');

    // 1. 初始化加载
    window.onload = () => {
        currentSources.forEach(s => testAndLoad(s));
    };

    // 2. 添加源并测速
    async function addSource() {
        const url = document.getElementById('api-url').value.trim();
        if(!url || currentSources.includes(url)) return;
        currentSources.push(url);
        localStorage.setItem('my_sources', JSON.stringify(currentSources));
        testAndLoad(url);
    }

    // 3. 测速逻辑与内容抓取
    async function testAndLoad(url) {
        const start = Date.now();
        const tagId = btoa(url).substring(0, 8);
        
        // 先在状态栏显示“测试中”
        const statusBox = document.getElementById('source-status');
        const tag = document.createElement('div');
        tag.className = 'tag';
        tag.id = `tag-${tagId}`;
        tag.innerHTML = `<span>源:${url.substring(0,15)}...</span> <span class="latency">测速中...</span>`;
        statusBox.appendChild(tag);

        try {
            const resp = await fetch(url);
            const latency = Date.now() - start;
            const data = await resp.json();
            
            // 更新延迟显示
            const latClass = latency < 500 ? 'lat-green' : 'lat-red';
            document.querySelector(`#tag-${tagId} .latency`).innerHTML = `<span class="${latClass}">${latency}ms</span>`;
            
            // 处理茅台 API (CMS 类型)
            if(data.list) {
                appendContent(data.list);
            }
        } catch (e) {
            document.querySelector(`#tag-${tagId} .latency`).innerHTML = `<span class="lat-red">超时</span>`;
        }
    }

    // 4. 渲染海报墙
    function appendContent(newList) {
        const grid = document.getElementById('main-grid');
        newList.forEach(item => {
            const card = document.createElement('div');
            card.className = 'movie-card';
            // 茅台 API 通常自带 pic (海报)
            card.innerHTML = `
                <img src="${item.vod_pic}" onerror="this.src='https://via.placeholder.com/200x300?text=No+Pic'">
                <div class="badge">${item.vod_remarks || '高清'}</div>
                <div class="info">${item.vod_name}</div>
            `;
            card.onclick = () => openPlayer(item);
            grid.appendChild(card);
        });
    }

    // 5. 播放详情逻辑
    function openPlayer(item) {
        document.getElementById('player-overlay').style.display = 'grid';
        document.getElementById('v-title').innerText = item.vod_name;
        document.getElementById('v-desc').innerText = item.vod_content || '暂无简介';

        // 解析选集 (茅台 API 格式: 1集$url#2集$url)
        const episodes = item.vod_play_url.split('#');
        const listDiv = document.getElementById('episode-list');
        listDiv.innerHTML = "";

        episodes.forEach((ep, idx) => {
            const [name, url] = ep.split('$');
            const btn = document.createElement('button');
            btn.className = 'episode-btn';
            btn.innerText = name || `第${idx+1}集`;
            btn.onclick = () => {
                // 选集激活状态
                document.querySelectorAll('.episode-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                // 切换地址
                player.src({ src: url, type: 'application/x-mpegURL' });
                player.play();
                // 记录历史
                localStorage.setItem(`history_${item.vod_id}`, url);
            };
            listDiv.appendChild(btn);
            
            // 自动播放第一集
            if(idx === 0) btn.click();
        });
    }

    function closePlayer() {
        player.pause();
        document.getElementById('player-overlay').style.display = 'none';
    }
</script>
</body>
</html>
