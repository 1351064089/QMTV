<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>UltraVision OS - 全网聚合旗舰版</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #ff5c38; --bg: #080808; --card-bg: #151515; }
        body, html { margin: 0; padding: 0; background: var(--bg); color: #fff; font-family: "PingFang SC", sans-serif; overflow: hidden; height: 100vh; }
        
        /* 布局 */
        #app { display: flex; height: 100vh; }
        
        /* 左侧：源管理 */
        aside { width: 240px; background: #000; border-right: 1px solid #222; display: flex; flex-direction: column; }
        .side-header { padding: 25px; font-size: 22px; font-weight: bold; color: var(--main); letter-spacing: 1px; }
        .src-form { padding: 0 15px 15px; border-bottom: 1px solid #222; }
        .src-form input { width: 100%; background: #1a1a1a; border: 1px solid #333; color: #fff; padding: 8px; margin-bottom: 8px; border-radius: 4px; box-sizing: border-box; }
        .src-list { flex: 1; overflow-y: auto; padding: 10px; }
        .src-item { padding: 10px; background: #111; margin-bottom: 8px; border-radius: 6px; font-size: 13px; cursor: pointer; display: flex; justify-content: space-between; }
        .src-item:hover { background: #222; }

        /* 右侧：主视窗 */
        main { flex: 1; overflow-y: auto; display: flex; flex-direction: column; position: relative; }
        
        /* 顶部导航 */
        header { position: sticky; top: 0; background: rgba(8,8,8,0.95); z-index: 100; border-bottom: 1px solid #222; }
        .nav-bar { display: flex; align-items: center; padding: 10px 30px; gap: 40px; }
        .cats { display: flex; gap: 25px; }
        .cat { cursor: pointer; color: #999; font-size: 16px; font-weight: 500; }
        .cat.active { color: var(--main); border-bottom: 2px solid var(--main); padding-bottom: 5px; }
        .search-input { background: #1a1a1a; border: none; color: #fff; padding: 8px 20px; border-radius: 20px; width: 300px; outline: none; }

        /* 首页海报墙 */
        .content { padding: 30px; }
        .banner { height: 350px; border-radius: 15px; background: linear-gradient(45deg, #111, #222); margin-bottom: 30px; display: flex; align-items: flex-end; padding: 40px; position: relative; overflow: hidden; }
        .banner img { position: absolute; top:0; left:0; width:100%; height:100%; object-fit: cover; opacity: 0.4; }
        .section-title { font-size: 22px; font-weight: bold; margin-bottom: 20px; color: #fff; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 25px; }
        
        /* 影片卡片 */
        .movie-card { background: var(--card-bg); border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.3s; position: relative; }
        .movie-card:hover { transform: translateY(-10px); box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        .movie-card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; background: #222; }
        .movie-card .badge { position: absolute; top: 10px; right: 10px; background: var(--main); padding: 2px 6px; border-radius: 4px; font-size: 12px; font-weight: bold; }
        .movie-card .desc { padding: 12px; font-size: 14px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* 播放层 */
        #player-box { position: fixed; inset: 0; background: #000; z-index: 1000; display: none; grid-template-columns: 1fr 350px; }
        .v-side { position: relative; display: flex; flex-direction: column; }
        .l-side { background: #111; border-left: 1px solid #222; padding: 20px; overflow-y: auto; }
        .close-p { position: absolute; top: 20px; left: 20px; z-index: 1001; cursor: pointer; background: rgba(0,0,0,0.5); padding: 8px 20px; border-radius: 25px; }
        .line-btn { background: var(--main); border: none; color: #fff; padding: 5px 15px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .ep-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-top: 20px; }
        .ep-btn { background: #222; border: 1px solid #333; color: #aaa; padding: 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .ep-btn.active { background: var(--main); color: #fff; }
    </style>
</head>
<body>

<div id="app">
    <aside>
        <div class="side-header">UltraVision X</div>
        <div class="src-form">
            <input type="text" id="sn" placeholder="源名称 (手动输入)">
            <input type="text" id="su" placeholder="订阅 API 接口">
            <button onclick="addSource()" style="width:100%; background:var(--main); border:none; color:#fff; padding:8px; border-radius:4px; cursor:pointer;">导入并识别</button>
        </div>
        <div class="src-list" id="src-list"></div>
    </aside>

    <main>
        <header>
            <div class="nav-bar">
                <div class="cats" id="cat-nav">
                    <div class="cat active" onclick="fetchDouban('Movie')">电影</div>
                    <div class="cat" onclick="fetchDouban('TV')">电视剧</div>
                    <div class="cat" onclick="fetchDouban('Variety')">综艺</div>
                    <div class="cat" onclick="fetchDouban('Anime')">动漫</div>
                </div>
                <input type="text" id="skw" class="search-input" placeholder="输入名称全网聚合搜索..." onkeypress="if(event.keyCode==13) searchAll()">
            </div>
        </header>

        <div class="content">
            <div class="banner" id="banner">
                <img id="b-img" src="">
                <div style="position:relative; z-index:2">
                    <h1 id="b-title" style="font-size:40px; margin:0"></h1>
                    <p id="b-desc" style="max-width:600px; color:#ccc;"></p>
                </div>
            </div>
            
            <div class="section-title" id="grid-title">今日热门推荐</div>
            <div class="grid" id="main-grid"></div>
        </div>
    </main>
</div>

<div id="player-box">
    <div class="close-p" onclick="closePlayer()">✕ 退出播放</div>
    <div class="v-side">
        <video id="v-core" class="video-js vjs-big-play-centered" controls style="width:100%; height:100%;"></video>
        <div style="padding:25px; background: #000;">
            <h1 id="v-name" style="margin:0"></h1>
            <p id="v-plot" style="color:#666; font-size:14px; margin-top:10px;"></p>
        </div>
    </div>
    <div class="l-side">
        <h3>多线路选集</h3>
        <div id="v-lines"></div>
        <div class="ep-grid" id="v-eps"></div>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const vCore = videojs('v-core', { fluid: false });
    let sources = JSON.parse(localStorage.getItem('uv_sources_v5') || '[]');

    // 初始化
    window.onload = () => {
        renderSources();
        fetchDouban('Movie'); // 默认进电影分类
    };

    // 1. 获取豆瓣数据填充首页
    async function fetchDouban(type) {
        document.querySelectorAll('.cat').forEach(el => el.classList.remove('active'));
        if(event.target.classList) event.target.classList.add('active');
        
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">正在同步豆瓣最新数据...</div>';

        try {
            const res = await fetch(`https://api.wmdb.tv/api/v1/top?type=${type}&skip=0&limit=30`);
            const data = await res.json();
            
            // 设置 Banner (第一部)
            const hero = data[0];
            document.getElementById('b-img').src = hero.data[0].poster;
            document.getElementById('b-title').innerText = hero.data[0].name;
            document.getElementById('b-desc').innerText = hero.description.slice(0, 80) + '...';

            grid.innerHTML = '';
            data.forEach(m => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.innerHTML = `
                    <div class="badge">${m.doubanRating || '8.0'}</div>
                    <img src="${m.data[0].poster}" referrerpolicy="no-referrer">
                    <div class="desc">${m.data[0].name}</div>
                `;
                card.onclick = () => { document.getElementById('skw').value = m.data[0].name; searchAll(); };
                grid.appendChild(card);
            });
        } catch(e) { grid.innerHTML = '首页数据加载超时，请先添加订阅源。'; }
    }

    // 2. 聚合搜索逻辑
    async function searchAll() {
        const kw = document.getElementById('skw').value;
        if(!kw) return;
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div style="grid-column:1/-1; text-align:center;">正在全网源内聚合检索...</div>';
        
        const tasks = sources.map(s => fetch(`${s.url}?ac=detail&wd=${encodeURIComponent(kw)}`).then(r => r.json()).catch(()=>({list:[]})) );
        const results = await Promise.all(tasks);
        
        grid.innerHTML = '';
        results.forEach((res, i) => {
            if(res.list) res.list.forEach(item => {
                const card = document.createElement('div');
                card.className = 'movie-card';
                card.innerHTML = `
                    <div class="badge">${sources[i].name}</div>
                    <img src="${item.vod_pic}" referrerpolicy="no-referrer">
                    <div class="desc">${item.vod_name}</div>
                `;
                card.onclick = () => openPlayer(item);
                grid.appendChild(card);
            });
        });
    }

    // 3. 播放与选集
    function openPlayer(item) {
        document.getElementById('player-box').style.display = 'grid';
        document.getElementById('v-name').innerText = item.vod_name;
        document.getElementById('v-plot').innerText = item.vod_content.replace(/<[^>]+>/g, '');
        
        const lineNav = document.getElementById('v-lines');
        const epGrid = document.getElementById('v-eps');
        lineNav.innerHTML = ''; epGrid.innerHTML = '';

        const lines = item.vod_play_url.split('$$$');
        lines.forEach((line, idx) => {
            const btn = document.createElement('button');
            btn.className = 'line-btn';
            btn.innerText = '线路' + (idx+1);
            btn.onclick = () => {
                epGrid.innerHTML = '';
                line.split('#').forEach(ep => {
                    const [name, url] = ep.split('$');
                    const ebtn = document.createElement('button');
                    ebtn.className = 'ep-btn';
                    ebtn.innerText = name;
                    ebtn.onclick = () => {
                        document.querySelectorAll('.ep-btn').forEach(b => b.classList.remove('active'));
                        ebtn.classList.add('active');
                        vCore.src({ src: url, type: 'application/x-mpegURL' });
                        vCore.play();
                    };
                    epGrid.appendChild(ebtn);
                });
                if(epGrid.firstChild) epGrid.firstChild.click();
            };
            lineNav.appendChild(btn);
        });
        if(lineNav.firstChild) lineNav.firstChild.click();
    }

    // 4. 源管理
    function addSource() {
        const u = document.getElementById('su').value;
        let n = document.getElementById('sn').value;
        if(!u) return;
        if(!n) n = u.includes('maotai') ? '茅台源' : '新资源站' + (sources.length+1);
        sources.push({ name: n, url: u });
        localStorage.setItem('uv_sources_v5', JSON.stringify(sources));
        renderSources();
    }

    function renderSources() {
        const list = document.getElementById('src-list');
        list.innerHTML = '';
        sources.forEach((s, i) => {
            const d = document.createElement('div');
            d.className = 'src-item';
            d.innerHTML = `<span>${s.name}</span> <span onclick="delSrc(${i})" style="color:#666">✕</span>`;
            d.onclick = (e) => { if(e.target.innerText!=='✕') searchSourceAll(s.url); };
            list.appendChild(d);
        });
    }

    function closePlayer() { vCore.pause(); document.getElementById('player-box').style.display = 'none'; }
    function delSrc(i) { sources.splice(i,1); localStorage.setItem('uv_sources_v5', JSON.stringify(sources)); renderSources(); }
</script>
</body>
</html>
