<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE OS | Ultimate</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #a29bfe; --bg: #f8fafc; --text: #1e293b; --card: #ffffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "PingFang SC", sans-serif; overflow-x: hidden; }
        
        /* 1. é¡¶æ å¤åˆ» */
        header { 
            position: sticky; top: 0; background: rgba(255,255,255,0.85); backdrop-filter: blur(15px);
            display: flex; align-items: center; padding: 10px 30px; z-index: 1000; border-bottom: 1px solid #e2e8f0;
        }
        .nav { display: flex; gap: 15px; flex: 1; }
        .nav div { padding: 6px 16px; border-radius: 20px; cursor: pointer; font-size: 14px; background: #f1f5f9; transition: 0.3s; }
        .nav .active { background: var(--main); color: white; box-shadow: 0 4px 10px rgba(162, 155, 254, 0.3); }

        /* 2. ä¸»å†…å®¹ */
        .container { max-width: 1400px; margin: 30px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .card { background: var(--card); border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.3s; position: relative; border: 1px solid #f1f5f9; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.08); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .tag { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .card .info { padding: 12px; text-align: center; font-weight: bold; font-size: 13px; }

        /* 3. è¯¦æƒ…æ’­æ”¾å™¨ (æˆªå›¾ 4, 5 å‡çº§ç‰ˆ) */
        #player-page { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; }
        .player-layout { display: grid; grid-template-columns: 1fr 380px; gap: 25px; max-width: 1600px; margin: 60px auto; padding: 0 20px; }
        .v-box { background: #000; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 40px rgba(0,0,0,0.15); }
        
        /* æ’­æ”¾è®¾ç½®åŠŸèƒ½ */
        .setting-card { background: #fff; border-radius: 16px; padding: 20px; margin-top: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
        .set-item { display: flex; align-items: center; gap: 10px; font-size: 13px; }
        .set-item input { width: 60px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; }

        /* å³ä¾§è¾¹æ  */
        .side-panel { background: #fff; border-radius: 16px; height: 800px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e2e8f0; }
        .tab-nav { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; font-size: 14px; color: #94a3b8; }
        .tab.active { color: var(--main); border-bottom: 3px solid var(--main); background: #fff; }

        /* é€‰é›†åˆ†æ®µ 1-50 */
        .range-bar { display: flex; gap: 8px; padding: 10px; overflow-x: auto; background: #fdfdfd; border-bottom: 1px solid #f1f5f9; }
        .range-btn { padding: 4px 10px; border-radius: 6px; background: #f1f5f9; font-size: 11px; cursor: pointer; white-space: nowrap; }
        .range-btn.active { background: var(--main); color: white; }

        .list-body { flex: 1; overflow-y: auto; padding: 15px; }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .ep-item { background: #f8fafc; border: 1px solid #f1f5f9; padding: 10px 0; text-align: center; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .ep-item.active { background: var(--main); color: white; border-color: var(--main); }

        /* æ¢æºæµ‹é€Ÿ */
        .src-item { 
            display: flex; justify-content: space-between; align-items: center; padding: 12px; 
            background: #f8fafc; border-radius: 10px; margin-bottom: 8px; cursor: pointer; transition: 0.2s;
        }
        .src-item:hover { background: #f1f5f9; }
        .src-item.active { background: #f3f0ff; border: 1px solid var(--main); }
        .ping { font-size: 10px; padding: 2px 6px; border-radius: 4px; background: #e2e8f0; }

        /* æ‰¹é‡å¯¼å…¥å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-body { background: #fff; width: 600px; padding: 30px; border-radius: 20px; box-shadow: 0 25px 50px rgba(0,0,0,0.2); }
        textarea { width: 100%; height: 200px; border: 1px solid #ddd; border-radius: 12px; padding: 15px; margin: 15px 0; font-size: 12px; }
    </style>
</head>
<body>

<header>
    <div style="font-size: 20px; font-weight: 900; color: var(--main); margin-right: 30px;">JOE OS</div>
    <div class="nav" id="main-nav">
        <div class="active" onclick="loadDouban('Movie')">ç”µå½±</div>
        <div onclick="loadDouban('TV')">å‰§é›†</div>
        <div onclick="loadDouban('Anime')">åŠ¨æ¼«</div>
        <div onclick="showImport()">æ‰¹é‡å¯¼å…¥æº</div>
    </div>
    <div style="display:flex; gap:10px;">
        <input type="text" id="search-input" placeholder="å…¨ç½‘èšåˆæœç´¢..." style="padding:8px 20px; border-radius:20px; border:1px solid #ddd; width:250px;">
        <button onclick="aggregateSearch()" style="background:var(--main); color:white; border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">æœç´¢</button>
    </div>
</header>

<div class="container">
    <div class="grid" id="main-grid"></div>
</div>

<div id="player-page">
    <div style="padding: 20px 50px; cursor:pointer; font-weight:bold; color:var(--main);" onclick="closePlayer()"> â† è¿”å›åˆ—è¡¨</div>
    <div class="player-layout">
        <div class="player-left">
            <div class="v-box">
                <video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls></video>
            </div>
            <div class="setting-card">
                <div style="grid-column: 1/-1; display:flex; gap:20px; align-items:flex-start;">
                    <img id="v-img" src="" style="width:120px; border-radius:8px; box-shadow:0 4px 10px rgba(0,0,0,0.1);">
                    <div>
                        <h2 id="v-title" style="margin:0"></h2>
                        <div id="v-meta" style="font-size:12px; color:#a29bfe; margin:8px 0;"></div>
                        <p id="v-desc" style="font-size:13px; color:#64748b; line-height:1.6;"></p>
                    </div>
                </div>
                <div class="set-item">
                    <span>â© è·³è¿‡ç‰‡å¤´(ç§’)</span>
                    <input type="number" id="skip-start" value="0" onchange="savePlaySet()">
                </div>
                <div class="set-item">
                    <span>ğŸ” è‡ªåŠ¨è¿æ’­</span>
                    <input type="checkbox" id="auto-next" checked onchange="savePlaySet()">
                </div>
            </div>
        </div>

        <div class="side-panel">
            <div class="tab-nav">
                <div class="tab active" id="tab-ep-btn" onclick="switchTab('ep')">é€‰é›†åˆ—è¡¨</div>
                <div class="tab" id="tab-src-btn" onclick="switchTab('src')">æ¢æº/çº¿è·¯</div>
            </div>
            <div id="ep-sec" style="display:flex; flex-direction:column; flex:1;">
                <div class="range-bar" id="range-bar"></div>
                <div class="list-body">
                    <div class="ep-grid" id="ep-grid"></div>
                </div>
            </div>
            <div id="src-sec" class="list-body" style="display:none;">
                <div id="src-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="import-modal">
    <div class="modal-body">
        <h3>æ‰¹é‡å¯¼å…¥è§†é¢‘æº</h3>
        <p style="font-size:12px; color:#94a3b8;">æ¯è¡Œä¸€ä¸ª URL åœ°å€ï¼Œç³»ç»Ÿå°†è‡ªåŠ¨è¯†åˆ«åç§°å¹¶æµ‹é€Ÿã€‚</p>
        <textarea id="api-urls" placeholder="http://api.example.com/api.php/provide/vod/at/json/&#10;http://another-source.com/api/"></textarea>
        <button onclick="processImport()" style="width:100%; padding:12px; background:var(--main); color:white; border:none; border-radius:12px; cursor:pointer; font-weight:bold;">å¼€å§‹æ™ºèƒ½è¯†åˆ«</button>
        <button onclick="hideImport()" style="width:100%; padding:10px; background:none; border:none; color:#94a3b8; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('v-core');
    let apis = JSON.parse(localStorage.getItem('joe_ult_apis') || '[]');
    let currentVData = null;
    let allEpisodes = [];
    let playSettings = JSON.parse(localStorage.getItem('joe_play_set') || '{"skipStart":0, "autoNext":true}');

    window.onload = () => {
        loadDouban('Movie');
        initPlayerEvents();
    };

    // 1. è±†ç“£ä¸åˆ†ç±»æ•°æ®
    async function loadDouban(type) {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:100px;">æ­£åœ¨ä»è±†ç“£äº‘ç«¯åŒæ­¥æœ€æ–°æ•°æ®...</div>';
        try {
            const res = await fetch(`https://api.wmdb.tv/api/v1/top?type=${type}&skip=0&limit=36`).then(r => r.json());
            grid.innerHTML = '';
            res.forEach(m => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<div class="tag">${m.doubanRating || 'HOT'}</div><img src="${m.data[0].poster}" referrerpolicy="no-referrer"><div class="info">${m.data[0].name}</div>`;
                card.onclick = () => { document.getElementById('search-input').value = m.data[0].name; aggregateSearch(m); };
                grid.appendChild(card);
            });
        } catch(e) { grid.innerHTML = 'æ•°æ®åŒæ­¥å¤±è´¥'; }
    }

    // 2. æ‰¹é‡å¯¼å…¥ä¸è‡ªåŠ¨è¯†åˆ«
    async function processImport() {
        const urls = document.getElementById('api-urls').value.split('\n').filter(u => u.trim());
        const modalBtn = document.querySelector('.modal-body button');
        modalBtn.innerText = "æ­£åœ¨æ™ºèƒ½è¯†åˆ«æºåç§°...";
        
        for(let u of urls) {
            const cleanUrl = u.trim();
            if(apis.some(a => a.url === cleanUrl)) continue;
            try {
                // è‡ªåŠ¨è¯·æ±‚é¦–æ¡æ•°æ®æ¥è·å–ç«™ç‚¹åç§°
                const res = await fetch(cleanUrl + "?ac=list").then(r => r.json());
                const name = res.class?.[0]?.name ? `èµ„æºæº-${res.class[0].name}` : `æº-${apis.length + 1}`;
                apis.push({ name, url: cleanUrl });
            } catch(e) {
                apis.push({ name: `æ‰‹åŠ¨æº-${apis.length + 1}`, url: cleanUrl });
            }
        }
        localStorage.setItem('joe_ult_apis', JSON.stringify(apis));
        alert('å¯¼å…¥æˆåŠŸï¼Œå…± ' + apis.length + ' ä¸ªæºå·²å°±ç»ª');
        hideImport();
    }

    // 3. èšåˆæœç´¢ä¸çº¿è·¯ä¼˜åŒ–
    async function aggregateSearch(doubanData = null) {
        const kw = document.getElementById('search-input').value;
        if(!kw) return;
        const grid = document.getElementById('main-grid');
        grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;">æ­£åœ¨æ‰«æå…¨ç½‘çº¿è·¯å¹¶æµ‹è¯•å»¶è¿Ÿ...</div>';

        const searchPromises = apis.map(async api => {
            const start = Date.now();
            try {
                const res = await fetch(`${api.url}?ac=detail&wd=${encodeURIComponent(kw)}`).then(r => r.json());
                return { api, data: res.list || [], ping: Date.now() - start };
            } catch(e) { return { api, data: [], ping: 9999 }; }
        });

        const results = await Promise.all(searchPromises);
        grid.innerHTML = '';
        
        results.forEach(res => {
            res.data.forEach(item => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<div class="tag" style="background:var(--main)">${res.ping}ms</div><img src="${item.vod_pic}"><div class="info">${item.vod_name}</div>`;
                card.onclick = () => openPlayer(item, results, doubanData);
                grid.appendChild(card);
            });
        });
    }

    // 4. æ’­æ”¾è¯¦æƒ…é¡µæ ¸å¿ƒ (1-50é›†åˆ†æ®µ)
    function openPlayer(item, allResults, dbData) {
        document.getElementById('player-page').style.display = 'block';
        currentVData = item;
        
        // å½±ç‰‡ä¿¡æ¯ä¼˜å…ˆä½¿ç”¨è±†ç“£æ•°æ®
        document.getElementById('v-img').src = dbData ? dbData.data[0].poster : item.vod_pic;
        document.getElementById('v-title').innerText = item.vod_name;
        document.getElementById('v-meta').innerText = `è¯„åˆ†: ${dbData?.doubanRating || 'æš‚æ— '} | åˆ†ç±»: ${item.type_name}`;
        document.getElementById('v-desc').innerText = item.vod_content.replace(/<[^>]+>/g, '');
        
        // åˆå§‹åŒ–æ’­æ”¾é…ç½®
        document.getElementById('skip-start').value = playSettings.skipStart;
        document.getElementById('auto-next').checked = playSettings.autoNext;

        // çº¿è·¯é€‰æ‹©
        const srcList = document.getElementById('src-list');
        srcList.innerHTML = '';
        allResults.filter(r => r.data.length > 0).forEach((res, idx) => {
            const div = document.createElement('div');
            div.className = 'src-item';
            div.innerHTML = `<span>${res.api.name}</span> <span class="ping">${res.ping}ms</span>`;
            div.onclick = () => {
                document.querySelectorAll('.src-item').forEach(s => s.classList.remove('active'));
                div.classList.add('active');
                allEpisodes = res.data[0].vod_play_url.split('#');
                renderRangeBar();
            };
            srcList.appendChild(div);
        });
        srcList.firstChild.click();
    }

    // 5. é€‰é›†åˆ†æ®µæ¸²æŸ“ (1-50, 51-100...)
    function renderRangeBar() {
        const bar = document.getElementById('range-bar');
        bar.innerHTML = '';
        const step = 50;
        const total = allEpisodes.length;
        
        for (let i = 0; i < total; i += step) {
            const end = Math.min(i + step, total);
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = `${i + 1}-${end}`;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEps(i, end);
            };
            bar.appendChild(btn);
        }
        bar.firstChild.click();
    }

    function renderEps(start, end) {
        const grid = document.getElementById('ep-grid');
        grid.innerHTML = '';
        const slice = allEpisodes.slice(start, end);
        slice.forEach((ep, idx) => {
            const [name, url] = ep.split('$');
            const d = document.createElement('div');
            d.className = 'ep-item';
            d.innerText = name;
            d.onclick = () => {
                document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
                d.classList.add('active');
                player.src({ src: url, type: 'application/x-mpegURL' });
                player.play();
                // è‡ªåŠ¨è·³è¿‡ç‰‡å¤´
                if(playSettings.skipStart > 0) player.currentTime(playSettings.skipStart);
            };
            grid.appendChild(d);
        });
    }

    // æ’­æ”¾å™¨äº‹ä»¶å¤„ç†
    function initPlayerEvents() {
        player.on('ended', () => {
            if(playSettings.autoNext) {
                const next = document.querySelector('.ep-item.active').nextSibling;
                if(next) next.click();
            }
        });
    }

    function savePlaySet() {
        playSettings.skipStart = parseInt(document.getElementById('skip-start').value);
        playSettings.autoNext = document.getElementById('auto-next').checked;
        localStorage.setItem('joe_play_set', JSON.stringify(playSettings));
    }

    // åŸºç¡€äº¤äº’
    function switchTab(t) {
        document.getElementById('ep-sec').style.display = t==='ep'?'flex':'none';
        document.getElementById('src-sec').style.display = t==='src'?'block':'none';
        document.getElementById('tab-ep-btn').className = 'tab ' + (t==='ep'?'active':'');
        document.getElementById('tab-src-btn').className = 'tab ' + (t==='src'?'active':'');
    }
    function showImport() { document.getElementById('import-modal').style.display = 'flex'; }
    function hideImport() { document.getElementById('import-modal').style.display = 'none'; }
    function closePlayer() { player.pause(); document.getElementById('player-page').style.display = 'none'; }
</script>
</body>
</html>
