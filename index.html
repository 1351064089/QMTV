<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE TV V17 | æ’­æ”¾è®°å½• & ç²¾å‡†åˆ†ç±»</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #6c5ce7; --bg: #f0f2f5; --card: #ffffff; --text: #2d3436; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "PingFang SC", sans-serif; }
        
        /* å¯¼èˆª */
        header { position: sticky; top: 0; background: #fff; display: flex; align-items: center; padding: 10px 40px; z-index: 1000; border-bottom: 1px solid #ddd; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .logo { font-size: 24px; font-weight: 900; color: var(--main); margin-right: 30px; cursor: pointer; }
        .nav { display: flex; gap: 10px; flex: 1; overflow-x: auto; }
        .nav div { padding: 8px 15px; border-radius: 20px; cursor: pointer; font-size: 14px; background: #f1f5f9; font-weight: bold; white-space: nowrap; }
        .nav .active { background: var(--main); color: white; }
        .mgr-btn { background: #fff3bf !important; color: #e67700 !important; }

        .container { max-width: 1600px; margin: 20px auto; padding: 0 20px; }
        .row-title { font-size: 18px; font-weight: 800; margin: 25px 0 15px; border-left: 4px solid var(--main); padding-left: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        
        /* æ’­æ”¾è®°å½•ä¸“åŒº */
        .history-row { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
        .hist-card { flex: 0 0 200px; background: #fff; padding: 10px; border-radius: 12px; cursor: pointer; font-size: 12px; border: 1px solid #eee; }
        .hist-card b { display: block; color: var(--main); margin-bottom: 4px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

        .card { background: var(--card); border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid #eee; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.1); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .info { padding: 8px; text-align: center; font-size: 13px; font-weight: bold; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        .card .tag { position: absolute; top: 5px; right: 5px; background: rgba(0,0,0,0.7); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; }

        /* æ’­æ”¾å±‚ */
        #player-page { position: fixed; inset: 0; background: #f8fafc; z-index: 2000; display: none; overflow-y: auto; }
        .p-layout { display: grid; grid-template-columns: 1fr 380px; gap: 20px; max-width: 1600px; margin: 0 auto; padding: 20px; }
        .v-box { background: #000; border-radius: 15px; overflow: hidden; position: relative; }
        #v-status { position: absolute; top: 15px; left: 15px; z-index: 10; background: rgba(0,0,0,0.5); color: #fff; padding: 5px 12px; border-radius: 5px; font-size: 12px; backdrop-filter: blur(5px); }
        
        .side-panel { background: #fff; border-radius: 15px; height: 750px; display: flex; flex-direction: column; border: 1px solid #eee; }
        .range-bar { padding: 10px; display: flex; gap: 8px; overflow-x: auto; background: #f8fafc; border-bottom: 1px solid #eee; }
        .range-btn { padding: 5px 12px; background: #fff; border: 1px solid #ddd; border-radius: 8px; font-size: 11px; cursor: pointer; white-space: nowrap; }
        .range-btn.active { background: var(--main); color: #fff; }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; padding: 15px; overflow-y: auto; }
        .ep-item { background: #f1f5f9; padding: 10px 0; text-align: center; border-radius: 8px; font-size: 12px; font-weight: bold; cursor: pointer; }
        .ep-item.active { background: var(--main); color: #fff; }

        /* è®¾ç½®åŒº */
        .v-controls { background: #fff; margin-top: 15px; padding: 20px; border-radius: 15px; border: 1px solid #eee; }
        .set-row { display: flex; gap: 20px; font-size: 13px; color: #666; margin-top: 10px; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE TV</div>
    <div class="nav" id="main-nav">
        <div class="active" onclick="route('home', this)">ğŸ  é¦–é¡µ</div>
        <div onclick="route('1', this)">ğŸ¬ çƒ­é—¨ç”µå½±</div>
        <div onclick="route('2', this)">ğŸ“º åŒæ­¥å‰§é›†</div>
        <div onclick="route('3', this)">ğŸ‹ åŠ¨æ¼«ç•ªå‰§</div>
        <div onclick="route('short', this)">ğŸ“± çƒ­é—¨çŸ­å‰§</div>
        <div class="mgr-btn" onclick="toggleModal('mgr', true)">âš™ï¸ æºç®¡ç†</div>
    </div>
</header>

<div class="container" id="main-view">
    </div>

<div id="player-page">
    <div style="padding: 15px 40px; font-weight: bold; color: var(--main); cursor: pointer;" onclick="closePlayer()"> â† è¿”å›åˆ—è¡¨</div>
    <div class="p-layout">
        <div class="p-left">
            <div class="v-box">
                <div id="v-status">æ­£åœ¨è¿æ¥èµ„æº...</div>
                <video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto"></video>
            </div>
            <div class="v-controls">
                <h2 id="v-name" style="margin:0"></h2>
                <div class="set-row">
                    <span>è·³è¿‡ç‰‡å¤´: <input type="number" id="sk-s" value="0" style="width:40px;" onchange="saveConf()"> ç§’</span>
                    <label><input type="checkbox" id="at-n" checked onchange="saveConf()"> è‡ªåŠ¨ä¸‹ä¸€é›†</label>
                </div>
                <p id="v-desc" style="font-size:13px; color:#999; margin-top:10px;"></p>
            </div>
        </div>
        <div class="side-panel">
            <div id="r-bar" class="range-bar"></div>
            <div id="e-grid" class="ep-grid"></div>
        </div>
    </div>
</div>

<div id="mgr-modal" class="mgr-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:3000; align-items:center; justify-content:center;">
    <div style="background:#fff; width:400px; padding:30px; border-radius:20px;">
        <h3>çº¿è·¯ç®¡ç†</h3>
        <div id="api-list" style="max-height:100px; overflow-y:auto; font-size:12px;"></div>
        <textarea id="api-in" style="width:100%; height:60px; margin-top:10px;" placeholder="ç²˜è´´APIåœ°å€"></textarea>
        <button onclick="importApis()" style="width:100%; margin-top:10px; padding:10px; background:var(--main); color:#fff; border:none; border-radius:10px;">å¯¼å…¥æº</button>
        <button onclick="toggleModal('mgr', false)" style="width:100%; background:none; border:none; margin-top:10px; color:#999;">å…³é—­</button>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('v-core');
    let apis = JSON.parse(localStorage.getItem('joe_v17_apis') || '[]');
    let config = JSON.parse(localStorage.getItem('joe_v17_conf') || '{"skip":0,"auto":true}');
    let history = JSON.parse(localStorage.getItem('joe_v17_hist') || '[]');
    let currentRawEps = [];
    let currentVod = null;

    // --- è·¯ç”±ä¸åˆ†ç±» ---
    async function route(id, el) {
        if(el) {
            document.querySelectorAll('.nav div').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }
        const view = document.getElementById('main-view');
        view.innerHTML = "æ­£åœ¨æ‹‰å–æœ€æ–°åˆ†ç±»æ•°æ®...";

        if(id === 'home') {
            view.innerHTML = `
                <div class="row-title">ğŸ•’ ç»§ç»­è§‚çœ‹</div><div class="history-row" id="h-row"></div>
                <div class="row-title">ğŸ†• æœ€æ–°å…¥åº“</div><div class="grid" id="g-new"></div>
                <div class="row-title">ğŸ“± çƒ­é—¨çŸ­å‰§</div><div class="grid" id="g-short"></div>
            `;
            renderHistory();
            fetchList('g-new', '', 12);
            fetchList('g-short', 'çŸ­å‰§', 12);
        } else {
            view.innerHTML = `<div class="row-title">åˆ†ç±»ç»“æœ</div><div class="grid" id="g-cat"></div>`;
            fetchList('g-cat', id === 'short' ? 'çŸ­å‰§' : id, 30);
        }
    }

    async function fetchList(gid, param, num) {
        if(!apis.length) return;
        const isId = !isNaN(param);
        const url = `${apis[0].url}?ac=detail&${isId ? 't='+param : 'wd='+param}`;
        const res = await fetch(url).then(r => r.json());
        const g = document.getElementById(gid);
        if(g) g.innerHTML = res.list.slice(0, num).map(v => `
            <div class="card" onclick="openDetail('${v.vod_id}')">
                <div class="tag">${v.vod_remarks}</div>
                <img src="${v.vod_pic}">
                <div class="info">${v.vod_name}</div>
            </div>
        `).join('');
    }

    // --- æ’­æ”¾è®°å½•é€»è¾‘ ---
    function renderHistory() {
        const hRow = document.getElementById('h-row');
        if(!history.length) { hRow.innerHTML = "<small style='color:#999'>æš‚æ— è®°å½•</small>"; return; }
        hRow.innerHTML = history.slice(0, 10).map(h => `
            <div class="hist-card" onclick="openDetail('${h.id}', '${h.epUrl}', ${h.time})">
                <b>${h.name}</b>
                <div style="color:#999">${h.epName} / å·²çœ‹ ${Math.floor(h.time/60)}åˆ†</div>
            </div>
        `).join('');
    }

    function saveHistory(epName, epUrl, time) {
        history = history.filter(h => h.id !== currentVod.vod_id);
        history.unshift({ id: currentVod.vod_id, name: currentVod.vod_name, epName, epUrl, time });
        localStorage.setItem('joe_v17_hist', JSON.stringify(history));
    }

    // --- æ’­æ”¾å™¨é€»è¾‘ (ç‰©ç†éš”ç¦»é›†æ•°) ---
    async function openDetail(id, resumeUrl = null, resumeTime = 0) {
        const res = await fetch(`${apis[0].url}?ac=detail&ids=${id}`).then(r => r.json());
        currentVod = res.list[0];
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-name').innerText = currentVod.vod_name;
        document.getElementById('v-desc').innerText = currentVod.vod_content.replace(/<[^>]+>/g, '');
        document.getElementById('sk-s').value = config.skip;
        document.getElementById('at-n').checked = config.auto;

        currentRawEps = currentVod.vod_play_url.split('#').filter(s => s.includes('$'));
        
        renderRanges(resumeUrl, resumeTime);
    }

    function renderRanges(resumeUrl, resumeTime) {
        const rBar = document.getElementById('r-bar');
        rBar.innerHTML = "";
        const size = 50;
        for(let i=0; i < currentRawEps.length; i += size) {
            const end = Math.min(i + size, currentRawEps.length);
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = `${i+1}-${end}`;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEps(i, end, resumeUrl, resumeTime);
            };
            rBar.appendChild(btn);
        }
        // å¦‚æœæœ‰è®°å½•ï¼Œè·³è½¬åˆ°è®°å½•æ‰€åœ¨çš„åˆ†é¡µ
        const initialPage = resumeUrl ? Math.floor(currentRawEps.findIndex(e => e.includes(resumeUrl)) / 50) : 0;
        rBar.children[initialPage >= 0 ? initialPage : 0].click();
    }

    function renderEps(start, end, resumeUrl, resumeTime) {
        const eGrid = document.getElementById('e-grid');
        eGrid.innerHTML = "";
        // æ ¸å¿ƒéš”ç¦»ï¼šåªå¯¹å½“å‰åˆ†æ®µè¿›è¡Œæ¸²æŸ“ï¼Œå½»åº•åˆ‡æ–­ç´¢å¼•å›æµ
        const slice = currentRawEps.slice(start, end);
        slice.forEach(item => {
            const [name, url] = item.split('$');
            const d = document.createElement('div');
            d.className = 'ep-item' + (resumeUrl === url ? ' active' : '');
            d.innerText = name;
            d.onclick = () => {
                document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
                d.classList.add('active');
                play(url, name, resumeTime);
                resumeTime = 0; // ä»…ç¬¬ä¸€æ¬¡è·³è½¬
            };
            eGrid.appendChild(d);
            if(resumeUrl === url) d.scrollIntoView();
        });
        if(resumeUrl && eGrid.querySelector('.active')) eGrid.querySelector('.active').click();
    }

    function play(url, name, time) {
        document.getElementById('v-status').innerText = `æ­£åœ¨æ’­æ”¾ï¼š${name}`;
        player.src({ src: url, type: 'application/x-mpegURL' });
        player.play();
        player.one('loadedmetadata', () => {
            if(time > 0) player.currentTime(time);
            else if(config.skip > 0) player.currentTime(config.skip);
        });
        // ç›‘å¬è¿›åº¦ä¿å­˜è®°å½•
        player.off('timeupdate');
        player.on('timeupdate', () => {
            if(player.currentTime() > 10) saveHistory(name, url, player.currentTime());
        });
    }

    // --- å…¶å®ƒé€»è¾‘ ---
    function toggleModal(id, show) { document.getElementById(id+'-modal').style.display = show ? 'flex' : 'none'; }
    function saveConf() {
        config.skip = parseInt(document.getElementById('sk-s').value) || 0;
        config.auto = document.getElementById('at-n').checked;
        localStorage.setItem('joe_v17_conf', JSON.stringify(config));
    }
    async function importApis() {
        const url = document.getElementById('api-in').value.trim();
        if(!url) return;
        const res = await fetch(url + "?ac=list").then(r => r.json());
        apis.push({ name: res.source?.name || 'æ–°ç«™ç‚¹', url });
        localStorage.setItem('joe_v17_apis', JSON.stringify(apis));
        location.reload();
    }
    function renderApiList() {
        document.getElementById('api-list').innerHTML = apis.map(a => `<div>${a.name}</div>`).join('');
    }
    function closePlayer() { player.pause(); document.getElementById('player-page').style.display = 'none'; route('home'); }

    window.onload = () => { route('home'); renderApiList(); };
</script>
</body>
</html>
