<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE OS | Ultimate V14</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #a29bfe; --bg: #f8fafc; --text: #1e293b; --accent: #6c5ce7; --tag-bg: #ffeaa7; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "PingFang SC", sans-serif; overflow-x: hidden; }
        
        /* é¡¶éƒ¨å¯¼èˆª */
        header { 
            position: sticky; top: 0; background: rgba(255,255,255,0.95); backdrop-filter: blur(20px);
            display: flex; align-items: center; padding: 10px 40px; z-index: 1000; border-bottom: 1px solid #e2e8f0;
        }
        .logo { font-size: 24px; font-weight: 900; color: var(--main); margin-right: 30px; cursor: pointer; }
        .nav { display: flex; gap: 10px; flex: 1; overflow-x: auto; scrollbar-width: none; }
        .nav::-webkit-scrollbar { display: none; }
        .nav div { padding: 8px 18px; border-radius: 20px; cursor: pointer; font-size: 14px; background: #f1f5f9; white-space: nowrap; transition: 0.2s; font-weight: 600; }
        .nav .active { background: var(--main); color: white; box-shadow: 0 4px 12px rgba(162, 155, 254, 0.4); }
        .nav .mgr-btn { background: #fff3bf; color: #e67700; }

        .search-area { width: 280px; margin-left: 20px; }
        .search-area input { width: 100%; padding: 10px 20px; border-radius: 25px; border: 1px solid #e2e8f0; outline: none; font-size: 13px; }

        /* å†…å®¹å®¹å™¨ */
        .container { max-width: 1500px; margin: 25px auto; padding: 0 20px; }
        .row-title { font-size: 20px; font-weight: 800; margin: 30px 0 20px; display: flex; align-items: center; gap: 10px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; }
        
        /* å½±ç‰‡å¡ç‰‡ */
        .card { background: #fff; border-radius: 16px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid #f1f5f9; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .info { padding: 12px; text-align: center; font-size: 13px; font-weight: 700; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .card .remark { position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.7); color: #fff; font-size: 10px; padding: 3px 8px; border-radius: 6px; }

        /* æ’­æ”¾å™¨å…¨å±å±‚ */
        #player-page { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; }
        .p-layout { display: grid; grid-template-columns: 1fr 400px; gap: 25px; max-width: 1600px; margin: 20px auto; padding: 20px; }
        .v-wrap { background: #000; border-radius: 20px; overflow: hidden; box-shadow: 0 20px 50px rgba(0,0,0,0.3); }
        
        /* é€‰é›†é¢æ¿ */
        .side-panel { background: #fff; border-radius: 20px; height: 800px; display: flex; flex-direction: column; border: 1px solid #e2e8f0; }
        .tabs { display: flex; padding: 10px; background: #f8fafc; border-bottom: 1px solid #eee; }
        .tab { flex: 1; padding: 12px; text-align: center; cursor: pointer; font-weight: bold; color: #94a3b8; font-size: 14px; border-radius: 12px; }
        .tab.active { background: #fff; color: var(--main); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }

        .range-bar { padding: 10px; display: flex; gap: 8px; overflow-x: auto; border-bottom: 1px solid #f1f5f9; }
        .range-btn { padding: 6px 12px; background: #f1f5f9; border-radius: 8px; font-size: 12px; cursor: pointer; white-space: nowrap; }
        .range-btn.active { background: var(--main); color: #fff; }

        .ep-list { flex: 1; overflow-y: auto; padding: 15px; }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; }
        .ep-item { background: #f8fafc; border: 1px solid #f1f5f9; padding: 12px 0; text-align: center; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .ep-item.active { background: var(--main); color: #fff; border-color: var(--main); }

        /* å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-body { background: #fff; width: 500px; padding: 30px; border-radius: 25px; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE TV</div>
    <div class="nav" id="nav-bar">
        </div>
    <div class="search-area">
        <input type="text" id="kw" placeholder="æœç´¢ç‰‡åï¼Œå›è½¦ç¡®è®¤..." onkeydown="if(event.keyCode==13) search()">
    </div>
</header>

<div class="container" id="content-flow">
    </div>

<div id="player-page">
    <div style="padding: 20px 40px; cursor:pointer; font-weight:bold; color:var(--main);" onclick="closePlayer()"> â† è¿”å›åˆ—è¡¨</div>
    <div class="p-layout">
        <div class="p-left">
            <div class="v-wrap">
                <video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto"></video>
            </div>
            <div style="background:#fff; margin-top:20px; padding:25px; border-radius:20px;">
                <h2 id="v-title" style="margin:0"></h2>
                <p id="v-desc" style="color:#94a3b8; font-size:14px; margin-top:15px; line-height:1.6;"></p>
            </div>
        </div>
        <div class="side-panel">
            <div class="tabs">
                <div class="tab active" onclick="switchSide('ep')">é€‰é›†</div>
                <div class="tab" onclick="switchSide('src')">æ¢æº</div>
            </div>
            <div id="sec-ep" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                <div class="range-bar" id="range-bar"></div>
                <div class="ep-list"><div class="ep-grid" id="ep-grid"></div></div>
            </div>
            <div id="sec-src" class="ep-list" style="display:none;">
                <div id="src-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="modal-mgr">
    <div class="modal-body">
        <h3>æºç®¡ç†</h3>
        <div id="api-list" style="max-height:150px; overflow-y:auto; margin-bottom:15px;"></div>
        <textarea id="api-in" style="width:100%; height:100px; border-radius:10px; padding:10px; margin-bottom:15px;" placeholder="ç²˜è´´APIåœ°å€ (ä¸€è¡Œä¸€ä¸ª)"></textarea>
        <button onclick="importApis()" style="width:100%; padding:12px; background:var(--main); color:#fff; border:none; border-radius:10px; cursor:pointer; font-weight:bold;">å¯¼å…¥å¹¶ä¿å­˜</button>
        <button onclick="closeMgr()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('v-core');
    let apis = JSON.parse(localStorage.getItem('joe_v14_apis') || '[]');
    let currentRawEps = [];

    // å®šä¹‰åˆ†ç±»æ˜ å°„ (å¯¹æ¥é‡‡é›†ç«™ type_id æˆ–å…³é”®å­—)
    const CATS = [
        { name: 'é¦–é¡µ', id: 'home', icon: 'ğŸ ' },
        { name: 'ç”µå½±', id: '1', icon: 'ğŸ¬' },
        { name: 'å‰§é›†', id: '2', icon: 'ğŸ“º' },
        { name: 'åŠ¨æ¼«', id: '3', icon: 'ğŸ‹' },
        { name: 'çŸ­å‰§', id: 'short', icon: 'ğŸ“±' },
        { name: 'ç»¼è‰º', id: '4', icon: 'ğŸ¤' }
    ];

    // --- åˆå§‹åŒ–å¯¼èˆª ---
    function initNav() {
        const nav = document.getElementById('nav-bar');
        nav.innerHTML = CATS.map(c => `<div class="${c.id==='home'?'active':''}" onclick="changeTab('${c.id}', this)">${c.icon} ${c.name}</div>`).join('');
        nav.innerHTML += `<div class="mgr-btn" onclick="openMgr()">âš™ï¸ ç®¡ç†</div>`;
        changeTab('home');
    }

    // --- æ ¸å¿ƒï¼šå¤šç±»å‹åˆ†ç±»æ˜¾ç¤º ---
    async function changeTab(id, el) {
        if(el) {
            document.querySelectorAll('.nav div').forEach(d => d.classList.remove('active'));
            el.classList.add('active');
        }
        const flow = document.getElementById('content-flow');
        flow.innerHTML = "æ­£åœ¨æ·±åº¦è§£ææ•°æ®...";

        if(id === 'home') {
            // é¦–é¡µï¼šå±•ç¤ºå¤šä¸ªçƒ­é—¨æ¨¡å—
            flow.innerHTML = `
                <div class="row-title">ğŸ”¥ çƒ­é—¨ç”µå½±</div><div class="grid" id="g-hot-movie"></div>
                <div class="row-title">ğŸ¿ æœ€æ–°å‰§é›†</div><div class="grid" id="g-new-tv"></div>
                <div class="row-title">ğŸ“± çƒ­é—¨çŸ­å‰§</div><div class="grid" id="g-short"></div>
            `;
            loadSection('g-hot-movie', '1', 12);
            loadSection('g-new-tv', '2', 12);
            loadSection('g-short', 'çŸ­å‰§', 12);
        } else {
            // å•åˆ†ç±»é¡µ
            flow.innerHTML = `<div class="row-title">ğŸ” æ­£åœ¨å‘ç° ${id}</div><div class="grid" id="g-single"></div>`;
            loadSection('g-single', id, 30);
        }
    }

    async function loadSection(containerId, catId, num) {
        if(!apis.length) return;
        try {
            // ä¼˜å…ˆä»ç¬¬ä¸€ä¸ªå¯ç”¨çš„æºæŠ“å–
            const url = `${apis[0].url}?ac=detail&t=${catId === 'short' ? '' : catId}&wd=${catId === 'short' ? 'çŸ­å‰§' : ''}&pg=1`;
            const res = await fetch(url).then(r => r.json());
            renderGrid(containerId, res.list.slice(0, num));
        } catch(e) { console.error("åŠ è½½å¤±è´¥", containerId); }
    }

    function renderGrid(id, list) {
        const g = document.getElementById(id);
        if(!g) return;
        g.innerHTML = list.map(v => `
            <div class="card" onclick="reqDetail('${v.vod_id}')">
                <div class="remark">${v.vod_remarks}</div>
                <img src="${v.vod_pic}">
                <div class="info">${v.vod_name}</div>
            </div>
        `).join('');
    }

    // --- è¯¦æƒ…ä¸æœç´¢ ---
    async function search() {
        const kw = document.getElementById('kw').value;
        const flow = document.getElementById('content-flow');
        flow.innerHTML = `<div class="row-title">ğŸ” "${kw}" çš„æœç´¢ç»“æœ</div><div class="grid" id="g-search"></div>`;
        
        for(let api of apis) {
            fetch(`${api.url}?ac=detail&wd=${encodeURIComponent(kw)}`)
                .then(r => r.json())
                .then(res => renderGrid('g-search', res.list));
        }
    }

    async function reqDetail(id) {
        // å¼¹å‡ºè¯¦æƒ…/æ’­æ”¾
        const res = await fetch(`${apis[0].url}?ac=detail&ids=${id}`).then(r => r.json());
        const v = res.list[0];
        openPlayer(v);
    }

    // --- æ’­æ”¾å™¨ä¸ã€ç²¾å‡†é›†æ•°ã€‘ä¿®å¤ ---
    function openPlayer(v) {
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-title').innerText = v.vod_name;
        document.getElementById('v-desc').innerText = v.vod_content.replace(/<[^>]+>/g, '');

        // æ ¸å¿ƒä¿®å¤ï¼šå…ˆè¿‡æ»¤ï¼Œå†åˆ†ç‰‡ï¼Œä¸¥ç¦ç´¢å¼•å›æµ
        currentRawEps = v.vod_play_url.split('#').filter(s => s.includes('$'));
        
        renderRanges();
    }

    function renderRanges() {
        const bar = document.getElementById('range-bar');
        bar.innerHTML = "";
        const size = 50;
        const total = currentRawEps.length;

        for (let i = 0; i < total; i += size) {
            const end = Math.min(i + size, total);
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = `${i + 1}-${end}`;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEps(i, end);
            };
            bar.appendChild(btn);
        }
        if(bar.firstChild) bar.firstChild.click();
    }

    function renderEps(start, end) {
        const grid = document.getElementById('ep-grid');
        grid.innerHTML = "";
        // å…³é”®ï¼šä¸¥æ ¼ä½¿ç”¨ slice(start, end)ï¼Œä¸” index ä»…ç”¨äºæ˜¾ç¤ºï¼Œä¸ç”¨äºè®¡ç®—é€»è¾‘
        const sliceData = currentRawEps.slice(start, end);
        
        sliceData.forEach((item) => {
            const [name, url] = item.split('$');
            const d = document.createElement('div');
            d.className = 'ep-item';
            d.innerText = name.length > 5 ? name.slice(0,5)+'...' : name;
            d.onclick = () => {
                document.querySelectorAll('.ep-item').forEach(e => e.classList.remove('active'));
                d.classList.add('active');
                player.src({ src: url, type: 'application/x-mpegURL' });
                player.play();
            };
            grid.appendChild(d);
        });
    }

    // --- æºç®¡ç† ---
    function openMgr() { document.getElementById('modal-mgr').style.display = 'flex'; renderApiList(); }
    function closeMgr() { document.getElementById('modal-mgr').style.display = 'none'; }
    function renderApiList() {
        const box = document.getElementById('api-list');
        box.innerHTML = apis.map((a,i) => `<div style="display:flex;justify-content:space-between;padding:5px;font-size:12px;">${a.name} <span onclick="delApi(${i})" style="color:red;cursor:pointer">åˆ é™¤</span></div>`).join('');
    }
    async function importApis() {
        const urls = document.getElementById('api-in').value.split('\n').filter(u => u.trim());
        for(let u of urls) {
            const res = await fetch(u.trim() + "?ac=list").then(r => r.json());
            apis.push({ name: res.source?.name || 'æœªçŸ¥æº', url: u.trim() });
        }
        localStorage.setItem('joe_v14_apis', JSON.stringify(apis));
        location.reload();
    }
    function delApi(i) { apis.splice(i,1); localStorage.setItem('joe_v14_apis', JSON.stringify(apis)); renderApiList(); }

    function switchSide(t) {
        document.getElementById('sec-ep').style.display = t==='ep'?'flex':'none';
        document.getElementById('sec-src').style.display = t==='src'?'block':'none';
        document.querySelectorAll('.tab').forEach((el, idx) => el.classList.toggle('active', (t==='ep' && idx===0) || (t==='src' && idx===1)));
    }
    function closePlayer() { player.pause(); document.getElementById('player-page').style.display = 'none'; }

    initNav();
</script>
</body>
</html>
