<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE TV | Ultimate V16</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #a29bfe; --bg: #f8fafc; --text: #1e293b; --card: #ffffff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "PingFang SC", sans-serif; overflow-x: hidden; }
        
        /* å¯¼èˆªä¸å¸ƒå±€ */
        header { position: sticky; top: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(20px); display: flex; align-items: center; padding: 10px 40px; z-index: 1000; border-bottom: 1px solid #e2e8f0; }
        .logo { font-size: 24px; font-weight: 900; color: var(--main); margin-right: 30px; cursor: pointer; }
        .nav { display: flex; gap: 10px; flex: 1; }
        .nav div { padding: 8px 18px; border-radius: 20px; cursor: pointer; font-size: 14px; background: #f1f5f9; font-weight: 600; transition: 0.2s; }
        .nav .active { background: var(--main); color: white; }
        .nav .mgr-btn { background: #fff3bf; color: #e67700; }

        .container { max-width: 1500px; margin: 25px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(170px, 1fr)); gap: 20px; margin-bottom: 40px; }
        
        /* å½±ç‰‡å¡ç‰‡ */
        .card { background: var(--card); border-radius: 16px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid #f1f5f9; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.1); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .info { padding: 10px; text-align: center; font-size: 13px; font-weight: 700; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
        
        /* æ’­æ”¾å™¨é¡µé¢ */
        #player-page { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; }
        .p-layout { display: grid; grid-template-columns: 1fr 400px; gap: 25px; max-width: 1600px; margin: 0 auto; padding: 20px; }
        .v-wrap { background: #000; border-radius: 20px; overflow: hidden; position: relative; box-shadow: 0 20px 50px rgba(0,0,0,0.2); }
        
        /* æ’­æ”¾è¯¦æƒ… (å·¦ä¸Šè§’æµ®å±‚) */
        #v-info-tag { position: absolute; top: 15px; left: 15px; z-index: 10; background: rgba(0,0,0,0.6); color: #fff; padding: 8px 15px; border-radius: 10px; font-size: 12px; pointer-events: none; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); }

        /* é€‰é›†é¢æ¿ */
        .side-panel { background: #fff; border-radius: 20px; height: 800px; display: flex; flex-direction: column; border: 1px solid #e2e8f0; overflow: hidden; }
        .range-bar { padding: 12px; display: flex; gap: 8px; overflow-x: auto; background: #f8fafc; border-bottom: 1px solid #eee; }
        .range-btn { padding: 6px 14px; background: #fff; border: 1px solid #e2e8f0; border-radius: 10px; font-size: 12px; cursor: pointer; white-space: nowrap; font-weight: 600; }
        .range-btn.active { background: var(--main); color: #fff; border-color: var(--main); }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 10px; padding: 15px; }
        .ep-item { background: #f8fafc; border: 1px solid #f1f5f9; padding: 12px 0; text-align: center; border-radius: 10px; font-size: 12px; font-weight: 600; cursor: pointer; }
        .ep-item.active { background: var(--main); color: #fff; }

        /* æ’­æ”¾è®¾ç½®åŒºåŸŸ */
        .v-meta { background: #fff; margin-top: 20px; padding: 25px; border-radius: 20px; border: 1px solid #e2e8f0; }
        .play-set { display: flex; gap: 20px; margin-top: 15px; font-size: 13px; color: #64748b; background: #f1f5f9; padding: 12px; border-radius: 12px; }
        
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-body { background: #fff; width: 450px; padding: 30px; border-radius: 25px; }
    </style>
</head>
<body>

<header>
    <div class="logo" onclick="location.reload()">JOE TV</div>
    <div class="nav">
        <div class="active" onclick="loadHome()">ğŸ  é¦–é¡µ</div>
        <div onclick="loadCat('1')">ğŸ¬ ç”µå½±</div>
        <div onclick="loadCat('2')">ğŸ“º å‰§é›†</div>
        <div onclick="loadCat('short')">ğŸ“± çŸ­å‰§</div>
        <div class="mgr-btn" onclick="openMgr()">âš™ï¸ æºç®¡ç†</div>
    </div>
    <div class="search-area"><input type="text" id="kw" placeholder="å›è½¦æœç´¢å…¨ç½‘..." onkeydown="if(event.keyCode==13) search()"></div>
</header>

<div class="container" id="content-flow"></div>

<div id="player-page">
    <div style="padding: 15px 40px; cursor:pointer; font-weight:900; color:var(--main);" onclick="closePlayer()"> â† è¿”å›æ¢ç´¢</div>
    <div class="p-layout">
        <div class="p-left">
            <div class="v-wrap">
                <div id="v-info-tag">æ­£åœ¨åˆå§‹åŒ–æ’­æ”¾ä¿¡æ¯...</div>
                <video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto"></video>
            </div>
            <div class="v-meta">
                <h2 id="v-title" style="margin:0; letter-spacing:-1px;"></h2>
                <div class="play-set">
                    <span>â±ï¸ è·³è¿‡ç‰‡å¤´ï¼š<input type="number" id="cfg-skip" value="0" style="width:45px; border:none; background:#fff; text-align:center; border-radius:5px;" onchange="saveCfg()"> ç§’</span>
                    <label style="cursor:pointer"><input type="checkbox" id="cfg-auto" checked onchange="saveCfg()"> è‡ªåŠ¨è¿æ’­ä¸‹ä¸€é›†</label>
                </div>
                <p id="v-desc" style="color:#94a3b8; font-size:14px; margin-top:15px; line-height:1.6;"></p>
            </div>
        </div>
        <div class="side-panel">
            <div id="range-bar" class="range-bar"></div>
            <div style="overflow-y:auto; flex:1;"><div id="ep-grid" class="ep-grid"></div></div>
        </div>
    </div>
</div>

<div class="modal" id="modal-mgr">
    <div class="modal-body">
        <h3 style="margin-top:0">ç®¡ç†è§†é¢‘æº</h3>
        <div id="api-list" style="max-height:150px; overflow-y:auto; margin-bottom:15px;"></div>
        <textarea id="api-in" style="width:100%; height:80px; padding:10px; border-radius:10px; border:1px solid #eee;" placeholder="ç²˜è´´APIåœ°å€ (ä¸€è¡Œä¸€ä¸ª)"></textarea>
        <button onclick="importApis()" style="width:100%; padding:12px; background:var(--main); color:#fff; border:none; border-radius:10px; margin-top:10px; font-weight:bold; cursor:pointer;">ä¿å­˜çº¿è·¯</button>
        <button onclick="closeMgr()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('v-core');
    let apis = JSON.parse(localStorage.getItem('joe_v16_apis') || '[]');
    let config = JSON.parse(localStorage.getItem('joe_v16_cfg') || '{"skip":0,"auto":true}');
    let currentRawEps = [];

    // --- é¦–é¡µä¸åˆ†ç±»åŠ è½½ (æ€§èƒ½ä¼˜åŒ–ï¼šå¼‚æ­¥å¹¶å‘) ---
    async function loadHome() {
        const flow = document.getElementById('content-flow');
        flow.innerHTML = `<div class="grid" id="g-home"></div>`;
        // å°è¯•åŠ è½½æ¨èæ•°æ® (WMDB)
        fetch('https://api.wmdb.tv/api/v1/top?type=Movie&skip=0&limit=18')
            .then(r => r.json())
            .then(data => renderGrid('g-home', data.map(m => ({vod_name: m.data[0].name, vod_pic: m.data[0].poster, isWmdb: true}))))
            .catch(() => loadCat('1')); 
    }

    async function loadCat(tid) {
        if(!apis.length) return alert("è¯·å…ˆæ·»åŠ è§†é¢‘æºï¼");
        const flow = document.getElementById('content-flow');
        flow.innerHTML = `<div class="grid" id="g-cat"></div>`;
        const url = `${apis[0].url}?ac=detail&t=${tid==='short'?'':tid}&wd=${tid==='short'?'çŸ­å‰§':''}`;
        const res = await fetch(url).then(r => r.json());
        renderGrid('g-cat', res.list);
    }

    function renderGrid(id, list) {
        const g = document.getElementById(id);
        if(!g) return;
        g.innerHTML = list.map(v => `
            <div class="card" onclick="${v.isWmdb ? `quickSearch('${v.vod_name}')` : `reqDetail('${v.vod_id}')`}">
                <img src="${v.vod_pic}">
                <div class="info">${v.vod_name}</div>
            </div>
        `).join('');
    }

    async function quickSearch(name) { document.getElementById('kw').value = name; search(); }

    async function search() {
        const kw = document.getElementById('kw').value;
        const flow = document.getElementById('content-flow');
        flow.innerHTML = `<div class="grid" id="g-search"></div>`;
        apis.forEach(api => {
            fetch(`${api.url}?ac=detail&wd=${encodeURIComponent(kw)}`)
                .then(r => r.json()).then(res => renderGrid('g-search', res.list));
        });
    }

    async function reqDetail(id) {
        const res = await fetch(`${apis[0].url}?ac=detail&ids=${id}`).then(r => r.json());
        openPlayer(res.list[0]);
    }

    // --- æ’­æ”¾å™¨é€»è¾‘ (ä¸¥æ ¼ä¿®å¤é›†æ•°ä¸æ’­æ”¾è¯¦æƒ…) ---
    function openPlayer(v) {
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-title').innerText = v.vod_name;
        document.getElementById('v-desc').innerText = v.vod_content.replace(/<[^>]+>/g, '');
        document.getElementById('cfg-skip').value = config.skip;
        document.getElementById('cfg-auto').checked = config.auto;

        // é›†æ•°æ•°æ®é¢„å¤„ç†ï¼šè¿‡æ»¤ç©ºè¡Œ
        currentRawEps = v.vod_play_url.split('#').filter(s => s.includes('$'));
        
        // åˆå§‹å·¦ä¸Šè§’ä¿¡æ¯
        updateInfoTag(v.vod_name, "å‡†å¤‡ä¸­", v.vod_remarks);
        renderRanges();
    }

    function updateInfoTag(name, ep, quality) {
        document.getElementById('v-info-tag').innerHTML = `
            <b style="color:var(--main)">${name}</b> | ${ep} | <span style="color:#22c55e">${quality || '1080P'}</span>
        `;
    }

    function renderRanges() {
        const bar = document.getElementById('range-bar');
        bar.innerHTML = "";
        const size = 50;
        // ä¸¥æ ¼æŒ‰ç…§æ€»é•¿åº¦è®¡ç®—æŒ‰é’®ï¼Œä¸é¢„è®¾ä»»ä½•å¾ªç¯
        for (let i = 0; i < currentRawEps.length; i += size) {
            const endIdx = Math.min(i + size, currentRawEps.length);
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = `${i + 1}-${endIdx}`;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEps(i, endIdx); // ä¼ å…¥ç‰©ç†åˆ‡ç‰‡ç´¢å¼•
            };
            bar.appendChild(btn);
        }
        bar.firstChild?.click();
    }

    function renderEps(start, end) {
        const grid = document.getElementById('ep-grid');
        grid.innerHTML = "";
        // æ ¸å¿ƒä¿®å¤ï¼šç›´æ¥ä½¿ç”¨ slice è·å–è¯¥èŒƒå›´å†…çš„ç‹¬ç«‹æ•°ç»„
        const pageData = currentRawEps.slice(start, end);
        pageData.forEach((item) => {
            const [name, url] = item.split('$');
            const d = document.createElement('div');
            d.className = 'ep-item';
            d.innerText = name.includes('ç¬¬') ? name : `ç¬¬${name}é›†`;
            d.onclick = () => {
                document.querySelectorAll('.ep-item').forEach(e => e.classList.remove('active'));
                d.classList.add('active');
                updateInfoTag(document.getElementById('v-title').innerText, name, "æ­£åœ¨æ’­æ”¾");
                player.src({ src: url, type: 'application/x-mpegURL' });
                player.play();
                // è‡ªåŠ¨è·³è¿‡ç‰‡å¤´
                if(config.skip > 0) player.one('loadedmetadata', () => player.currentTime(config.skip));
            };
            grid.appendChild(d);
        });
    }

    // --- è‡ªåŠ¨è¿æ’­ ---
    player.on('ended', () => {
        if(config.auto) {
            const next = document.querySelector('.ep-item.active')?.nextSibling;
            if(next) next.click();
        }
    });

    // --- é…ç½®ä¿å­˜ ---
    function saveCfg() {
        config.skip = parseInt(document.getElementById('cfg-skip').value) || 0;
        config.auto = document.getElementById('cfg-auto').checked;
        localStorage.setItem('joe_v16_cfg', JSON.stringify(config));
    }

    function openMgr() { document.getElementById('modal-mgr').style.display = 'flex'; renderApiList(); }
    function closeMgr() { document.getElementById('modal-mgr').style.display = 'none'; }
    function renderApiList() {
        const box = document.getElementById('api-list');
        box.innerHTML = apis.map((a,i) => `<div style="display:flex;justify-content:space-between;padding:8px;font-size:12px;background:#f8fafc;margin-bottom:5px;border-radius:8px;">${a.name} <span onclick="delApi(${i})" style="color:red;cursor:pointer">åˆ é™¤</span></div>`).join('');
    }
    async function importApis() {
        const lines = document.getElementById('api-in').value.split('\n').filter(l => l.trim());
        for(let l of lines) {
            try {
                const res = await fetch(l.trim() + "?ac=list").then(r => r.json());
                apis.push({ name: res.source?.name || 'æœªçŸ¥çº¿è·¯', url: l.trim() });
            } catch(e) {}
        }
        localStorage.setItem('joe_v16_apis', JSON.stringify(apis));
        location.reload();
    }
    function delApi(i) { apis.splice(i,1); localStorage.setItem('joe_v16_apis', JSON.stringify(apis)); renderApiList(); }
    function closePlayer() { player.pause(); document.getElementById('player-page').style.display = 'none'; }

    window.onload = loadHome;
</script>
</body>
</html>
