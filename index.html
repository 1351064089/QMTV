<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>JOE OS | Ultimate æ——èˆ°ç‰ˆ</title>
    <link href="https://vjs.zencdn.net/8.10.0/video-js.css" rel="stylesheet" />
    <style>
        :root { --main: #a29bfe; --bg: #f8fafc; --text: #1e293b; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: "PingFang SC", sans-serif; }
        
        /* å¯¼èˆª */
        header { 
            position: sticky; top: 0; background: rgba(255,255,255,0.9); backdrop-filter: blur(10px);
            display: flex; align-items: center; padding: 12px 30px; z-index: 1000; border-bottom: 1px solid #e2e8f0;
        }
        .nav { display: flex; gap: 10px; flex: 1; }
        .nav div { padding: 6px 18px; border-radius: 20px; cursor: pointer; font-size: 14px; background: #f1f5f9; }
        .nav .active { background: var(--main); color: white; }

        /* å†…å®¹åŒº */
        .container { max-width: 1400px; margin: 25px auto; padding: 0 20px; }
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 20px; }
        .card { background: #fff; border-radius: 12px; overflow: hidden; cursor: pointer; transition: 0.3s; border: 1px solid #f1f5f9; position: relative; }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .card img { width: 100%; aspect-ratio: 2/3; object-fit: cover; }
        .card .badge { position: absolute; top: 8px; right: 8px; background: rgba(0,0,0,0.6); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .card .title { padding: 10px; text-align: center; font-weight: bold; font-size: 13px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        /* æ’­æ”¾å™¨é¡µé¢ */
        #player-page { position: fixed; inset: 0; background: var(--bg); z-index: 2000; display: none; overflow-y: auto; }
        .player-layout { display: grid; grid-template-columns: 1fr 380px; gap: 25px; max-width: 1500px; margin: 40px auto; padding: 0 20px; }
        .v-box { background: #000; border-radius: 16px; overflow: hidden; aspect-ratio: 16/9; }
        
        /* è®¾ç½®åŒº */
        .info-panel { background: #fff; border-radius: 16px; padding: 20px; margin-top: 20px; }
        .set-group { display: flex; gap: 20px; margin-top: 15px; padding-top: 15px; border-top: 1px solid #f1f5f9; }
        .set-item { display: flex; align-items: center; gap: 8px; font-size: 13px; }
        .set-item input[type="number"] { width: 50px; padding: 4px; border: 1px solid #ddd; border-radius: 4px; }

        /* å³ä¾§é¢æ¿ */
        .side-panel { background: #fff; border-radius: 16px; height: 750px; display: flex; flex-direction: column; overflow: hidden; border: 1px solid #e2e8f0; }
        .tab-nav { display: flex; background: #f8fafc; border-bottom: 1px solid #e2e8f0; }
        .tab { flex: 1; padding: 15px; text-align: center; cursor: pointer; font-weight: bold; font-size: 14px; color: #94a3b8; }
        .tab.active { color: var(--main); background: #fff; border-bottom: 3px solid var(--main); }

        /* é€‰é›†åˆ†æ®µ */
        .range-bar { display: flex; gap: 6px; padding: 10px; overflow-x: auto; background: #fff; border-bottom: 1px solid #f1f5f9; scrollbar-width: none; }
        .range-btn { padding: 4px 12px; border-radius: 6px; background: #f1f5f9; font-size: 11px; cursor: pointer; white-space: nowrap; }
        .range-btn.active { background: var(--main); color: white; }

        .list-body { flex: 1; overflow-y: auto; padding: 15px; }
        .ep-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; }
        .ep-item { background: #f8fafc; border: 1px solid #f1f5f9; padding: 10px 0; text-align: center; border-radius: 8px; font-size: 12px; cursor: pointer; }
        .ep-item.active { background: var(--main); color: white; }

        /* æ¢æºé¡¹ */
        .src-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; background: #f8fafc; border-radius: 10px; margin-bottom: 8px; cursor: pointer; }
        .src-item.active { border: 1px solid var(--main); background: #f3f0ff; }
        .ms { font-size: 10px; padding: 2px 6px; border-radius: 4px; }
        .ms-fast { background: #dcfce7; color: #15803d; }
        .ms-slow { background: #fee2e2; color: #b91c1c; }

        /* å¼¹çª— */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: none; align-items: center; justify-content: center; z-index: 3000; }
        .modal-body { background: #fff; width: 550px; padding: 25px; border-radius: 20px; }
        textarea { width: 100%; height: 180px; margin: 15px 0; padding: 10px; border-radius: 10px; border: 1px solid #ddd; box-sizing: border-box; }
    </style>
</head>
<body>

<header>
    <div style="font-size: 20px; font-weight: 900; color: var(--main); margin-right: 30px;">JOE OS</div>
    <div class="nav" id="main-nav">
        <div class="active" onclick="loadDouban('Movie')">ç”µå½±</div>
        <div onclick="loadDouban('TV')">å‰§é›†</div>
        <div onclick="loadDouban('Anime')">åŠ¨æ¼«</div>
        <div onclick="showModal()">æ‰¹é‡å¯¼å…¥æº</div>
    </div>
    <input type="text" id="search-kw" placeholder="è¾“å…¥ç‰‡åæœç´¢..." style="padding:8px 20px; border-radius:20px; border:1px solid #ddd; width:200px;">
    <button onclick="search()" style="margin-left:10px; background:var(--main); color:#fff; border:none; padding:8px 20px; border-radius:20px; cursor:pointer;">å…¨ç½‘æœ</button>
</header>

<div class="container">
    <div class="grid" id="main-grid"></div>
</div>

<div id="player-page">
    <div style="padding: 15px 40px; cursor:pointer; font-weight:bold; color:var(--main);" onclick="closePlayer()"> â† è¿”å›åˆ—è¡¨</div>
    <div class="player-layout">
        <div>
            <div class="v-box">
                <video id="v-core" class="video-js vjs-big-play-centered vjs-16-9" controls preload="auto"></video>
            </div>
            <div class="info-panel">
                <h2 id="v-title" style="margin:0"></h2>
                <p id="v-desc" style="font-size:13px; color:#64748b; line-height:1.6; height:60px; overflow:hidden;"></p>
                <div class="set-group">
                    <div class="set-item">â© è·³è¿‡ç‰‡å¤´ <input type="number" id="skip-s" value="0" onchange="updateSet()"> ç§’</div>
                    <div class="set-item">ğŸ” è‡ªåŠ¨è¿æ’­ <input type="checkbox" id="auto-n" checked onchange="updateSet()"></div>
                </div>
            </div>
        </div>
        <div class="side-panel">
            <div class="tab-nav">
                <div class="tab active" onclick="switchTab('ep')">é€‰é›†åˆ†æ®µ</div>
                <div class="tab" onclick="switchTab('src')">æ¢æºæµ‹é€Ÿ</div>
            </div>
            <div id="ep-sec" style="display:flex; flex-direction:column; flex:1; overflow:hidden;">
                <div class="range-bar" id="range-bar"></div>
                <div class="list-body"><div class="ep-grid" id="ep-grid"></div></div>
            </div>
            <div id="src-sec" class="list-body" style="display:none;">
                <div id="src-list"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal" id="import-modal">
    <div class="modal-body">
        <h3>æ‰¹é‡å¯¼å…¥ (è‡ªåŠ¨è¯†åˆ«åç§°)</h3>
        <textarea id="url-input" placeholder="http://api.com/api.php/provide/vod/at/json/&#10;ä¸€è¡Œä¸€ä¸ªåœ°å€"></textarea>
        <button onclick="doImport()" id="import-btn" style="width:100%; padding:12px; background:var(--main); color:#fff; border:none; border-radius:10px; cursor:pointer;">å¼€å§‹è¯†åˆ«å¹¶ä¿å­˜</button>
        <button onclick="hideModal()" style="width:100%; background:none; border:none; color:#94a3b8; margin-top:10px; cursor:pointer;">å–æ¶ˆ</button>
    </div>
</div>

<script src="https://vjs.zencdn.net/8.10.0/video.min.js"></script>
<script>
    const player = videojs('v-core');
    let apis = JSON.parse(localStorage.getItem('joe_v9_apis') || '[]');
    let playSet = JSON.parse(localStorage.getItem('joe_v9_set') || '{"skip":0,"auto":true}');
    let currentRawEps = [];

    // 1. æ‰¹é‡å¯¼å…¥ï¼šçœŸæ­£è¯†åˆ«åç§°
    async function doImport() {
        const urls = document.getElementById('url-input').value.split('\n').map(u => u.trim()).filter(u => u);
        const btn = document.getElementById('import-btn');
        btn.disabled = true;
        btn.innerText = "æ­£åœ¨é€šè¿‡ API è¯†åˆ«ç«™ç‚¹åç§°...";

        const results = await Promise.allSettled(urls.map(async u => {
            const r = await fetch(u + "?ac=list").then(res => res.json());
            return { name: r.source?.name || r.list?.[0]?.type_name || "æœªçŸ¥æº", url: u };
        }));

        results.forEach(res => {
            if(res.status === 'fulfilled') {
                if(!apis.find(a => a.url === res.value.url)) apis.push(res.value);
            }
        });

        localStorage.setItem('joe_v9_apis', JSON.stringify(apis));
        btn.disabled = false;
        btn.innerText = "è¯†åˆ«å®Œæˆï¼";
        setTimeout(hideModal, 1000);
    }

    // 2. è±†ç“£å¯¼å…¥
    async function loadDouban(type) {
        const grid = document.getElementById('main-grid');
        grid.innerHTML = "æ­£åœ¨åŠ è½½è±†ç“£æ’è¡Œ...";
        try {
            const data = await fetch(`https://api.wmdb.tv/api/v1/top?type=${type}&skip=0&limit=30`).then(r => r.json());
            grid.innerHTML = "";
            data.forEach(m => {
                const card = document.createElement('div');
                card.className = 'card';
                card.innerHTML = `<div class="badge">${m.doubanRating}</div><img src="${m.data[0].poster}" referrerpolicy="no-referrer"><div class="title">${m.data[0].name}</div>`;
                card.onclick = () => { document.getElementById('search-kw').value = m.data[0].name; search(); };
                grid.appendChild(card);
            });
        } catch(e) { grid.innerHTML = "è±†ç“£æ¥å£ç¹å¿™"; }
    }

    // 3. èšåˆæœç´¢ + çœŸå®æµ‹é€Ÿ
    async function search() {
        const kw = document.getElementById('search-kw').value;
        if(!kw) return;
        const grid = document.getElementById('main-grid');
        grid.innerHTML = "å…¨ç½‘çº¿è·¯å¹¶å‘æµ‹é€Ÿä¸­...";

        const tasks = apis.map(async api => {
            const start = Date.now();
            try {
                const r = await fetch(`${api.url}?ac=detail&wd=${encodeURIComponent(kw)}`).then(res => res.json());
                return { api, list: r.list || [], ms: Date.now() - start };
            } catch(e) { return { api, list: [], ms: 9999 }; }
        });

        const results = await Promise.all(tasks);
        grid.innerHTML = "";
        results.forEach(res => {
            res.list.forEach(v => {
                const card = document.createElement('div');
                card.className = 'card';
                const msClass = res.ms < 400 ? 'ms-fast' : 'ms-slow';
                card.innerHTML = `<div class="badge ${msClass}">${res.ms}ms</div><img src="${v.vod_pic}"><div class="title">${v.vod_name}</div>`;
                card.onclick = () => openPlayer(v, results);
                grid.appendChild(card);
            });
        });
    }

    // 4. æ’­æ”¾è¯¦æƒ…é¡µ
    function openPlayer(video, allRes) {
        document.getElementById('player-page').style.display = 'block';
        document.getElementById('v-title').innerText = video.vod_name;
        document.getElementById('v-desc').innerText = video.vod_content.replace(/<[^>]+>/g, '');
        document.getElementById('skip-s').value = playSet.skip;
        document.getElementById('auto-n').checked = playSet.auto;

        // çº¿è·¯åˆ‡æ¢
        const srcBox = document.getElementById('src-list');
        srcBox.innerHTML = "";
        allRes.filter(r => r.list.length > 0).forEach(res => {
            const d = document.createElement('div');
            d.className = 'src-item';
            d.innerHTML = `<span>${res.api.name}</span> <span class="ms ${res.ms < 400 ? 'ms-fast' : 'ms-slow'}">${res.ms}ms</span>`;
            d.onclick = () => {
                document.querySelectorAll('.src-item').forEach(i => i.classList.remove('active'));
                d.classList.add('active');
                currentRawEps = res.list[0].vod_play_url.split('#');
                renderRange();
            };
            srcBox.appendChild(d);
        });
        srcBox.firstChild.click();
    }

    // 5. å®æ‰“å®çš„ 1-50 åˆ†æ®µé€»è¾‘
    function renderRange() {
        const bar = document.getElementById('range-bar');
        bar.innerHTML = "";
        const size = 50;
        for(let i = 0; i < currentRawEps.length; i += size) {
            const end = Math.min(i + size, currentRawEps.length);
            const btn = document.createElement('div');
            btn.className = 'range-btn';
            btn.innerText = `${i+1}-${end}`;
            btn.onclick = () => {
                document.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                renderEps(i, end);
            };
            bar.appendChild(btn);
        }
        bar.firstChild.click();
    }

    function renderEps(start, end) {
        const grid = document.getElementById('ep-grid');
        grid.innerHTML = "";
        currentRawEps.slice(start, end).forEach(item => {
            const [name, url] = item.split('$');
            const d = document.createElement('div');
            d.className = 'ep-item';
            d.innerText = name;
            d.onclick = () => {
                document.querySelectorAll('.ep-item').forEach(i => i.classList.remove('active'));
                d.classList.add('active');
                playUrl(url);
            };
            grid.appendChild(d);
        });
    }

    function playUrl(url) {
        player.src({ src: url, type: 'application/x-mpegURL' });
        player.one('loadedmetadata', () => {
            if(playSet.skip > 0) player.currentTime(playSet.skip);
        });
        player.play();
    }

    // æ’­æ”¾å™¨è‡ªåŠ¨è¿æ’­é€»è¾‘
    player.on('ended', () => {
        if(playSet.auto) {
            const next = document.querySelector('.ep-item.active').nextSibling;
            if(next) next.click();
        }
    });

    function updateSet() {
        playSet.skip = parseInt(document.getElementById('skip-s').value) || 0;
        playSet.auto = document.getElementById('auto-n').checked;
        localStorage.setItem('joe_v9_set', JSON.stringify(playSet));
    }

    function switchTab(t) {
        document.getElementById('ep-sec').style.display = t==='ep'?'flex':'none';
        document.getElementById('src-sec').style.display = t==='src'?'block':'none';
        document.querySelectorAll('.tab').forEach((el, idx) => el.classList.toggle('active', (t==='ep' && idx===0) || (t==='src' && idx===1)));
    }
    function showModal() { document.getElementById('import-modal').style.display = 'flex'; }
    function hideModal() { document.getElementById('import-modal').style.display = 'none'; }
    function closePlayer() { player.pause(); document.getElementById('player-page').style.display = 'none'; }
    
    window.onload = () => loadDouban('Movie');
</script>
</body>
</html>
